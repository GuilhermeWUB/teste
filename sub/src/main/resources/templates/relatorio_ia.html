<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>SUB - Relatórios Inteligentes</title>
    <style>
        /* CSS Mínimo apenas para o que o Bootstrap não cobre */
        .ai-header-gradient {
            background: linear-gradient(135deg, #4e73df 0%, #224abe 100%); /* Azul padrão admin */
            color: white;
        }

        .cursor-pointer {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .cursor-pointer:hover {
            transform: translateY(-3px);
            background-color: #f8f9fa;
        }

        .loading-spinner {
            width: 1.5rem;
            height: 1.5rem;
            border-width: 0.2em;
        }

        /* Ajuste para modo escuro se seu sistema tiver */
        [data-theme="dark"] .cursor-pointer:hover {
            background-color: #2c2c2c;
        }
    </style>
</head>
<body>
<section layout:fragment="content">
    <div class="container-fluid p-4">

        <div class="card border-0 shadow-sm mb-4 overflow-hidden">
            <div class="card-body ai-header-gradient p-4">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-robot fa-3x"></i> </div>
                    <div>
                        <h2 class="mb-1 fw-bold">Relatórios Inteligentes (RAG)</h2>
                        <p class="mb-0 opacity-75">
                            Faça perguntas sobre seus dados e obtenha análises completas instantaneamente.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-white">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-search me-2"></i>Análise de Dados
                </h6>
            </div>
            <div class="card-body p-4">

                <div class="row justify-content-center mb-4">
                    <div class="col-lg-10">
                        <div class="input-group input-group-lg">
                            <input type="text"
                                   id="aiPergunta"
                                   class="form-control bg-light border-0 small"
                                   placeholder="Ex: Qual o faturamento total deste mês?"
                                   aria-label="Search">
                            <button class="btn btn-primary px-4" type="button" id="aiBtn">
                                <i class="fas fa-magic me-2"></i> Analisar
                            </button>
                        </div>
                        <small class="text-muted ms-2 mt-1 d-block">
                            <i class="fas fa-shield-alt me-1"></i> Modo Seguro: Apenas leitura de dados.
                        </small>
                    </div>
                </div>

                <div class="mb-4">
                    <h6 class="text-muted text-uppercase font-weight-bold text-xs mb-3">Sugestões Rápidas:</h6>
                    <div class="row g-3">
                        <div class="col-md-4 col-sm-6">
                            <div class="card h-100 border-left-primary shadow-sm py-2 cursor-pointer ai-example"
                                 data-pergunta="Quais veículos estão ativos?">
                                <div class="card-body d-flex align-items-center">
                                    <div class="me-3 text-primary">
                                        <i class="fas fa-car fa-2x"></i>
                                    </div>
                                    <div>
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Frota</div>
                                        <div class="h6 mb-0 font-weight-bold text-gray-800">Veículos Ativos</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 col-sm-6">
                            <div class="card h-100 border-left-success shadow-sm py-2 cursor-pointer ai-example"
                                 data-pergunta="Faça um resumo financeiro dos pagamentos deste ano">
                                <div class="card-body d-flex align-items-center">
                                    <div class="me-3 text-success">
                                        <i class="fas fa-dollar-sign fa-2x"></i>
                                    </div>
                                    <div>
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Financeiro</div>
                                        <div class="h6 mb-0 font-weight-bold text-gray-800">Resumo Anual</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 col-sm-6">
                            <div class="card h-100 border-left-warning shadow-sm py-2 cursor-pointer ai-example"
                                 data-pergunta="Liste os eventos pendentes com prioridade alta">
                                <div class="card-body d-flex align-items-center">
                                    <div class="me-3 text-warning">
                                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                                    </div>
                                    <div>
                                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Pendências</div>
                                        <div class="h6 mb-0 font-weight-bold text-gray-800">Eventos Críticos</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <div id="aiResultados" class="mt-4">
                    <div class="text-center text-muted py-5 opacity-50">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <p>Os resultados da análise aparecerão aqui.</p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</section>

<th:block layout:fragment="scripts">
    <script>
        (function() {
            'use strict';

            // Configuração de Ícones para Feedback (Bootstrap Icons ou FontAwesome)
            const ICONS = {
                loading: '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>',
                magic: '<i class="fas fa-magic me-2"></i>',
                error: '<i class="fas fa-exclamation-circle me-2"></i>',
                info: '<i class="fas fa-info-circle me-2"></i>'
            };

            function inicializarRelatoriosIA() {
                const exemplos = document.querySelectorAll('.ai-example');
                const btnGerar = document.getElementById('aiBtn');
                const inputPergunta = document.getElementById('aiPergunta');

                // Clique nos cards de exemplo
                exemplos.forEach(card => {
                    card.addEventListener('click', function() {
                        const pergunta = this.getAttribute('data-pergunta');
                        inputPergunta.value = pergunta;
                        inputPergunta.focus();
                        // Efeito visual de clique
                        this.style.backgroundColor = '#eef2f7';
                        setTimeout(() => this.style.backgroundColor = '', 200);

                        gerarRelatorioIA();
                    });
                });

                // Botão de Ação
                if (btnGerar) {
                    btnGerar.addEventListener('click', function(e) {
                        e.preventDefault();
                        gerarRelatorioIA();
                    });
                }

                // Enter no input
                if (inputPergunta) {
                    inputPergunta.addEventListener('keypress', function(event) {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            gerarRelatorioIA();
                        }
                    });
                }
            }

            async function gerarRelatorioIA() {
                const perguntaInput = document.getElementById('aiPergunta');
                const pergunta = perguntaInput.value.trim();
                const btnElement = document.getElementById('aiBtn');
                const resultadosDiv = document.getElementById('aiResultados');

                if (!pergunta) {
                    perguntaInput.classList.add('is-invalid');
                    return;
                }
                perguntaInput.classList.remove('is-invalid');

                // Estado de Carregamento
                const textoOriginal = btnElement.innerHTML;
                btnElement.disabled = true;
                btnElement.innerHTML = `${ICONS.loading} Analisando...`;

                resultadosDiv.innerHTML = `
                    <div class="alert alert-info border-0 shadow-sm">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border text-info me-3" role="status"></div>
                            <div>
                                <strong>Consultando a Inteligência Artificial...</strong><br>
                                <small>Lendo dados do sistema, cruzando informações e gerando insights.</small>
                            </div>
                        </div>
                    </div>
                `;

                try {
                    // Token CSRF (Segurança do Spring)
                    const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

                    const headers = { 'Content-Type': 'application/json' };
                    if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;

                    const response = await fetch('/api/relatorios-ia/analisar', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({ pergunta: pergunta })
                    });

                    const data = await response.json();

                    if (response.ok && data.sucesso) {
                        // Sucesso: Renderiza o HTML da IA dentro de um card limpo
                        resultadosDiv.innerHTML = `
                            <div class="card border-left-success shadow-sm animate__animated animate__fadeIn">
                                <div class="card-body">
                                    <h5 class="card-title text-success mb-3"><i class="fas fa-check-circle me-2"></i>Análise Concluída</h5>
                                    <div class="mt-3 text-dark">
                                        ${data.html}
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent border-0 text-end">
                                    <small class="text-muted">Gerado por Gemini AI ${new Date().toLocaleTimeString()}</small>
                                </div>
                            </div>
                        `;
                    } else {
                        // Erro de Negócio (ex: pergunta vazia ou erro no service)
                        throw new Error(data.mensagem || 'Não foi possível analisar os dados.');
                    }

                } catch (error) {
                    console.error('Erro:', error);
                    resultadosDiv.innerHTML = `
                        <div class="alert alert-danger shadow-sm d-flex align-items-center" role="alert">
                            ${ICONS.error}
                            <div>
                                <strong>Ops! Algo deu errado.</strong><br>
                                ${error.message}
                            </div>
                        </div>
                    `;
                } finally {
                    // Restaura o botão
                    btnElement.disabled = false;
                    btnElement.innerHTML = textoOriginal;
                }
            }

            // Inicializa
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', inicializarRelatoriosIA);
            } else {
                inicializarRelatoriosIA();
            }
        })();
    </script>
</th:block>
</body>
</html>