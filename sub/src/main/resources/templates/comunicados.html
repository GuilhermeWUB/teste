<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>SUB - Comunicados</title>
</head>
<body>
<section layout:fragment="content">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
        <div>
            <h1 class="mb-0">Comunicados</h1>
            <p class="text-muted mb-0">Acompanhe as notícias e informações importantes</p>
        </div>
    </div>

    <!-- Mensagens de sucesso/erro -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Alerta caso o associado não seja encontrado -->
    <div th:if="${userPartner == null}" class="alert alert-warning alert-dismissible fade show mb-4" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong>Atenção!</strong> Não foi possível localizar seus dados de associado no sistema.
        Isso pode acontecer porque:
        <ul class="mb-2 mt-2">
            <li>Você ainda não foi cadastrado como associado</li>
            <li>O email da sua conta não corresponde ao email cadastrado no sistema</li>
        </ul>
        <strong>Entre em contato com o administrador para resolver este problema.</strong>
        <br>
        <small class="text-muted">Verifique também se está usando a conta de usuário correta (associado, não administrador).</small>
    </div>

    <!-- Botão para vistorias (apenas para usuários logados) -->
    <div th:if="${userPartner != null}" class="mb-3">
        <a th:href="@{/vistorias}" class="btn btn-warning text-dark">
            <i class="bi bi-camera-fill me-1"></i>Vistorias de Acidentes
        </a>
        <small class="text-muted ms-2">Envie fotos dos seus comunicados que estão aguardando vistoria</small>
    </div>

    <!-- Botão para abrir formulário de novo evento -->
    <div class="mb-4 d-flex justify-content-between align-items-center">
        <div>
            <h4 class="fw-semibold mb-0"><i class="bi bi-calendar-event me-2"></i>Reportar Evento</h4>
            <p class="text-muted small mb-0">Comunique ocorrências relacionadas aos seus veículos</p>
        </div>
        <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#formNovoEvento"
                aria-expanded="false" aria-controls="formNovoEvento">
            <i class="bi bi-plus-circle me-1"></i>Novo Comunicado
        </button>
    </div>

    <!-- Formulário para criar evento (inicialmente oculto) -->
    <div class="collapse mb-4" id="formNovoEvento">
        <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Reportar um Evento</h5>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">Utilize este formulário para reportar ocorrências, sinistros ou comunicar eventos relacionados aos seus veículos.</p>

            <div th:if="${userPartner == null}" class="alert alert-warning" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                Não foi possível localizar seus dados de associado. Entre em contato com o administrador para resolver este problema.
            </div>

            <form th:if="${userPartner != null}"
                  th:action="@{/comunicados/criar-evento}"
                  th:object="${event}"
                  method="post"
                  enctype="multipart/form-data"
                  id="formCriarEvento">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" th:field="*{partner.id}" />
                <input type="hidden" th:field="*{status}" />

                <!-- Campos ocultos para Data da Comunicação (preenchidos automaticamente) -->
                <input type="hidden" id="dataComunicacao" name="dataComunicacao" />
                <input type="hidden" id="horaComunicacao" name="horaComunicacao" />

                <div class="row mb-3">
                    <div class="col-md-12">
                        <label for="titulo" class="form-label fw-semibold">Título do Evento *</label>
                        <input type="text" class="form-control" id="titulo" th:field="*{titulo}"
                               placeholder="Ex: Colisão no estacionamento" maxlength="200" required>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('titulo')}" th:errors="*{titulo}"></div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-12">
                        <label for="descricao" class="form-label fw-semibold">Descrição do Ocorrido *</label>
                        <textarea class="form-control" id="descricao" th:field="*{descricao}"
                                  rows="4" placeholder="Descreva detalhadamente o que aconteceu..." required></textarea>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('descricao')}" th:errors="*{descricao}"></div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="motivo" class="form-label fw-semibold">Tipo de Ocorrência *</label>
                        <select class="form-select" id="motivo" th:field="*{motivo}" required>
                            <option value="">Selecione...</option>
                            <option th:each="motivo : ${motivoOptions}"
                                    th:value="${motivo}"
                                    th:text="${motivo}">Motivo</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="envolvimento" class="form-label fw-semibold">Envolvimento *</label>
                        <select class="form-select" id="envolvimento" th:field="*{envolvimento}" required>
                            <option value="">Selecione...</option>
                            <option th:each="envolvimento : ${envolvimentoOptions}"
                                    th:value="${envolvimento}"
                                    th:text="${envolvimento}">Envolvimento</option>
                        </select>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="placaManual" class="form-label fw-semibold">Placa do Veículo</label>
                        <input type="text" class="form-control" id="placaManual" th:field="*{placaManual}"
                               placeholder="Ex: ABC-1234" maxlength="10">
                        <small class="form-text text-muted">Informe a placa do veículo envolvido (opcional)</small>
                    </div>
                    <div class="col-md-6">
                        <label for="dataAconteceu" class="form-label fw-semibold">Data do Ocorrido</label>
                        <input type="date" class="form-control" id="dataAconteceu" th:field="*{dataAconteceu}">
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-12">
                        <label for="observacoes" class="form-label fw-semibold">Observações Adicionais</label>
                        <textarea class="form-control" id="observacoes" th:field="*{observacoes}"
                                  rows="2" placeholder="Informações complementares..."></textarea>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <i class="bi bi-paperclip text-primary fs-5"></i>
                        <div>
                            <h6 class="mb-0">Documentos do Evento</h6>
                            <p class="text-muted small mb-0">Envie os arquivos de apoio em seus respectivos campos. Aceitamos PDF, JPG ou PNG.</p>
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6 col-lg-4">
                            <label for="docCrlv" class="form-label fw-semibold">CRLV do veículo</label>
                            <input type="file" class="form-control" id="docCrlv" name="docCrlv" accept="application/pdf,image/*">
                            <small class="text-muted">Documento obrigatório apenas quando solicitado.</small>
                        </div>
                        <div class="col-md-6 col-lg-4">
                            <label for="docCnh" class="form-label fw-semibold">CNH do condutor</label>
                            <input type="file" class="form-control" id="docCnh" name="docCnh" accept="application/pdf,image/*">
                            <small class="text-muted">Envie a habilitação atualizada do motorista.</small>
                        </div>
                        <div class="col-md-6 col-lg-4">
                            <label for="docBo" class="form-label fw-semibold">Boletim de Ocorrência</label>
                            <input type="file" class="form-control" id="docBo" name="docBo" accept="application/pdf,image/*">
                            <small class="text-muted">Caso o B.O. esteja disponível, anexe aqui.</small>
                        </div>
                        <div class="col-md-6 col-lg-4">
                            <label for="docComprovanteResidencia" class="form-label fw-semibold">Comprovante de residência</label>
                            <input type="file" class="form-control" id="docComprovanteResidencia" name="docComprovanteResidencia" accept="application/pdf,image/*">
                            <small class="text-muted">Último comprovante em nome do associado.</small>
                        </div>
                        <div class="col-md-6 col-lg-4">
                            <label for="docTermoAbertura" class="form-label fw-semibold">Termo de abertura</label>
                            <input type="file" class="form-control" id="docTermoAbertura" name="docTermoAbertura" accept="application/pdf,image/*">
                            <small class="text-muted">Use este campo para anexar o termo de abertura do sinistro.</small>
                        </div>
                    </div>
                </div>

                <!-- Seção de Fotos do Acidente -->
                <div class="mb-4">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <i class="bi bi-camera text-primary fs-5"></i>
                        <div>
                            <h6 class="mb-0">Fotos do Acidente</h6>
                            <p class="text-muted small mb-0">Envie fotos do local do acidente, dos danos no veículo e quaisquer outros detalhes relevantes.</p>
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label for="fotosAcidente" class="form-label fw-semibold">Fotos do acidente</label>
                            <input type="file" class="form-control" id="fotosAcidente" name="fotosAcidente"
                                   accept="image/*" multiple>
                            <small class="text-muted">Você pode selecionar múltiplas fotos. Formatos aceitos: JPG, PNG.</small>
                        </div>
                    </div>
                </div>

                <!-- Seção de Terceiro Envolvido -->
                <div class="mb-4">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="terceiroEnvolvido" name="terceiroEnvolvido" value="true">
                        <label class="form-check-label fw-semibold" for="terceiroEnvolvido">
                            <i class="bi bi-person-plus text-warning me-1"></i>
                            Há terceiro envolvido no acidente?
                        </label>
                    </div>

                    <div id="documentosTerceiro" style="display: none;">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <i class="bi bi-file-earmark-person text-warning fs-5"></i>
                            <div>
                                <h6 class="mb-0">Documentos do Terceiro</h6>
                                <p class="text-muted small mb-0">Envie os documentos do terceiro envolvido no acidente.</p>
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6 col-lg-4">
                                <label for="docTerceiroCnh" class="form-label fw-semibold">CNH do terceiro</label>
                                <input type="file" class="form-control" id="docTerceiroCnh" name="docTerceiroCnh" accept="application/pdf,image/*">
                                <small class="text-muted">Habilitação do condutor terceiro.</small>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <label for="docTerceiroCrlv" class="form-label fw-semibold">CRLV do veículo do terceiro</label>
                                <input type="file" class="form-control" id="docTerceiroCrlv" name="docTerceiroCrlv" accept="application/pdf,image/*">
                                <small class="text-muted">Documento do veículo do terceiro.</small>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <label for="docTerceiroOutros" class="form-label fw-semibold">Outros documentos</label>
                                <input type="file" class="form-control" id="docTerceiroOutros" name="docTerceiroOutros" accept="application/pdf,image/*">
                                <small class="text-muted">Outros documentos do terceiro (seguro, etc).</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2 justify-content-end">
                    <button type="reset" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-counterclockwise me-1"></i>Limpar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send-fill me-1"></i>Enviar Evento
                    </button>
                </div>
            </form>
        </div>
        </div>
    </div>

    <!-- Seção de Meus Eventos -->
    <div class="mb-3">
        <h4 class="fw-semibold"><i class="bi bi-calendar-event me-2"></i>Meus Eventos</h4>
        <p class="text-muted small mb-3">Acompanhe o status dos eventos que você reportou</p>
    </div>

    <div th:if="${userPartner == null}" class="alert alert-warning mb-4" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        Não foi possível localizar seus dados de associado. Entre em contato com o administrador.
    </div>

    <div th:if="${userPartner != null && #lists.isEmpty(userEvents)}" class="alert alert-info mb-4" role="alert">
        <i class="bi bi-info-circle-fill me-2"></i>
        Você ainda não possui eventos reportados. Utilize o formulário acima para reportar um novo evento.
    </div>

    <div th:if="${userPartner != null && !#lists.isEmpty(userEvents)}" class="mb-4">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Título</th>
                        <th>Tipo</th>
                        <th>Status</th>
                        <th>Placa</th>
                        <th>Data Ocorrido</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="evt : ${userEvents}" th:attr="data-event-row=${evt.id}">
                        <td>
                            <div class="fw-semibold" th:text="${evt.titulo}"></div>
                            <small class="text-muted" th:text="${evt.descricao != null && evt.descricao.length() > 80 ? evt.descricao.substring(0, 80) + '...' : evt.descricao}"></small>
                        </td>
                        <td>
                            <span class="badge bg-secondary" th:text="${evt.motivo}"></span>
                        </td>
                        <td>
                            <span class="badge"
                                  th:classappend="${evt.status.name() == 'A_FAZER' ? 'bg-secondary' :
                                                   evt.status.name() == 'EM_ANDAMENTO' ? 'bg-info' :
                                                   evt.status.name() == 'CONCLUIDO' ? 'bg-success' :
                                                   evt.status.name() == 'CANCELADO' ? 'bg-danger' : 'bg-secondary'}"
                                  th:text="${evt.statusFormatted}"></span>
                        </td>
                        <td>
                            <span th:if="${evt.vehicle != null && evt.vehicle.plaque != null}"
                                  th:text="${evt.vehicle.plaque}"></span>
                            <span th:if="${evt.placaManual != null && !evt.placaManual.isEmpty()}"
                                  th:text="${evt.placaManual}"></span>
                            <span th:if="${(evt.vehicle == null || evt.vehicle.plaque == null) && (evt.placaManual == null || evt.placaManual.isEmpty())}"
                                  class="text-muted">-</span>
                        </td>
                        <td>
                            <span th:if="${evt.dataAconteceu != null}"
                                  th:text="${#temporals.format(evt.dataAconteceu, 'dd/MM/yyyy')}"></span>
                            <span th:if="${evt.dataAconteceu == null}" class="text-muted">-</span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary btn-open-event-details"
                                        th:data-event-id="${evt.id}"
                                        data-focus="descricao"
                                        title="Editar Comunicado">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary btn-open-event-details"
                                        th:data-event-id="${evt.id}"
                                        data-focus="observacoes"
                                        title="Editar Observações e Fotos">
                                    <i class="bi bi-chat-left-text"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Seção de Comunicados -->
    <div class="mb-3">
        <h4 class="fw-semibold"><i class="bi bi-megaphone me-2"></i>Avisos e Comunicados</h4>
    </div>

    <div th:if="${#lists.isEmpty(comunicados)}" class="alert alert-info" role="alert">
        Não há comunicados no momento.
    </div>

    <div th:if="${!#lists.isEmpty(comunicados)}" class="row g-4">
        <div class="col-12" th:each="comunicado : ${comunicados}">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title fw-bold" th:text="${comunicado.titulo}"></h5>
                    <div class="card-text mb-3" style="white-space: pre-wrap;" th:text="${comunicado.mensagem}"></div>
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 text-muted small">
                        <div>
                            <span th:if="${comunicado.autor != null && !comunicado.autor.isEmpty()}">
                                <i class="bi bi-person-fill me-1"></i>
                                <span th:text="${comunicado.autor}"></span>
                            </span>
                        </div>
                        <div class="d-flex gap-3">
                            <span>
                                <i class="bi bi-calendar-fill me-1"></i>
                                <span th:text="${#temporals.format(comunicado.dataCriacao, 'dd/MM/yyyy HH:mm')}"></span>
                            </span>
                            <span th:if="${comunicado.dataExpiracao != null}" class="text-warning">
                                <i class="bi bi-clock-fill me-1"></i>
                                Expira em: <span th:text="${#temporals.format(comunicado.dataExpiracao, 'dd/MM/yyyy HH:mm')}"></span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal completo com informações e edição -->
    <div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-labelledby="eventDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h5 class="modal-title mb-0" id="eventDetailsModalLabel">
                            <i class="bi bi-pencil-square me-2"></i>Meu Comunicado
                        </h5>
                        <small class="text-muted" id="eventDetailsSubtitle"></small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="eventDetailsLoading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3 text-muted">Carregando informações do comunicado...</p>
                    </div>
                    <div id="eventDetailsContent" class="d-none">
                        <div id="eventDetailsFeedback" class="alert d-none" role="alert"></div>
                        <div class="row g-4">
                            <div class="col-12 col-lg-5">
                                <div class="card shadow-sm h-100">
                                    <div class="card-body">
                                        <h6 class="text-uppercase text-muted fw-semibold mb-3">Resumo do Comunicado</h6>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="text-muted small">Status atual</span>
                                                <span id="eventStatusBadge" class="badge bg-secondary">-</span>
                                            </div>
                                            <small class="text-muted" id="eventPhaseLabel"></small>
                                        </div>
                                        <dl class="row mb-0 small">
                                            <dt class="col-5 text-muted">Motivo</dt>
                                            <dd class="col-7" id="eventMotivoValue">-</dd>
                                            <dt class="col-5 text-muted">Envolvimento</dt>
                                            <dd class="col-7" id="eventEnvolvimentoValue">-</dd>
                                            <dt class="col-5 text-muted">Associado</dt>
                                            <dd class="col-7" id="eventPartnerValue">-</dd>
                                            <dt class="col-5 text-muted">Veículo</dt>
                                            <dd class="col-7" id="eventVehicleValue">-</dd>
                                            <dt class="col-5 text-muted">Data do ocorrido</dt>
                                            <dd class="col-7" id="eventDataAconteceu">-</dd>
                                            <dt class="col-5 text-muted">Data da comunicação</dt>
                                            <dd class="col-7" id="eventDataComunicacao">-</dd>
                                        </dl>
                                        <div class="mt-4">
                                            <h6 class="fw-semibold mb-2"><i class="bi bi-paperclip me-2"></i>Documentos enviados</h6>
                                            <div id="eventAttachmentsList" class="d-flex flex-column gap-2 small text-break">
                                                <span class="text-muted">Nenhum documento foi anexado.</span>
                                            </div>
                                        </div>
                                        <div class="mt-4">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="fw-semibold mb-0"><i class="bi bi-images me-2"></i>Fotos da vistoria</h6>
                                                <span class="badge bg-dark-subtle text-dark" id="eventPhotosBadge">0</span>
                                            </div>
                                            <div id="eventPhotosGrid" class="row g-2 mt-3"></div>
                                            <p class="text-muted small mb-0" id="eventPhotosEmpty">Nenhuma foto enviada até o momento.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-lg-7">
                                <form id="eventDetailsForm" class="card shadow-sm h-100" novalidate>
                                    <div class="card-body">
                                        <input type="hidden" id="eventDetailsId" />
                                        <div class="mb-4">
                                            <label for="eventDescricao" class="form-label fw-semibold">Descrição do Comunicado *</label>
                                            <textarea id="eventDescricao" class="form-control" name="descricao" rows="6" required></textarea>
                                            <div class="invalid-feedback">Informe a descrição do comunicado.</div>
                                        </div>
                                        <div class="mb-4">
                                            <label for="eventObservacoes" class="form-label fw-semibold">Observações</label>
                                            <textarea id="eventObservacoes" class="form-control" name="observacoes" rows="5"
                                                      placeholder="Registre observações importantes"></textarea>
                                        </div>
                                        <div>
                                            <label for="eventNovasFotos" class="form-label fw-semibold">Enviar novas fotos</label>
                                            <input type="file" id="eventNovasFotos" name="novasFotos" class="form-control" accept="image/*" multiple>
                                            <small class="text-muted">Você pode selecionar múltiplas imagens para complementar o comunicado.</small>
                                        </div>
                                    </div>
                                    <div class="card-footer d-flex justify-content-between align-items-center">
                                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                            <i class="bi bi-x-circle"></i> Fechar
                                        </button>
                                        <button type="submit" class="btn btn-primary" id="eventDetailsSubmit">
                                            <span class="spinner-border spinner-border-sm me-2 d-none" id="eventDetailsSavingSpinner" role="status"></span>
                                            <i class="bi bi-check-circle"></i> Salvar alterações
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script layout:fragment="scripts">
    document.addEventListener('DOMContentLoaded', function() {
        // Abre automaticamente o formulário se houver erros de validação
        var formErrors = document.querySelector('#formNovoEvento .invalid-feedback');
        if (formErrors) {
            var collapseElement = document.getElementById('formNovoEvento');
            var collapse = new bootstrap.Collapse(collapseElement, {
                show: true
            });
        }

        // Adiciona comportamento de scroll suave ao abrir o formulário
        var toggleButton = document.querySelector('[data-bs-target="#formNovoEvento"]');
        if (toggleButton) {
            toggleButton.addEventListener('click', function() {
                setTimeout(function() {
                    var formElement = document.getElementById('formNovoEvento');
                    if (formElement && formElement.classList.contains('show')) {
                        formElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 350); // Aguarda a animação do collapse
            });
        }

        // Auto-preenche Data da Comunicação e Hora da Comunicação ao submeter o formulário
        var formCriarEvento = document.getElementById('formCriarEvento');
        if (formCriarEvento) {
            formCriarEvento.addEventListener('submit', function(event) {
                // Obtém a data e hora atual
                var agora = new Date();

                // Formata a data no padrão ISO (yyyy-MM-dd) para o campo de data
                var ano = agora.getFullYear();
                var mes = String(agora.getMonth() + 1).padStart(2, '0');
                var dia = String(agora.getDate()).padStart(2, '0');
                var dataFormatada = ano + '-' + mes + '-' + dia;

                // Obtém a hora no formato HHmm (ex: 1430 para 14:30)
                var horas = String(agora.getHours()).padStart(2, '0');
                var minutos = String(agora.getMinutes()).padStart(2, '0');
                var horaFormatada = parseInt(horas + minutos);

                // Preenche os campos ocultos
                document.getElementById('dataComunicacao').value = dataFormatada;
                document.getElementById('horaComunicacao').value = horaFormatada;

                console.log('Data da Comunicação preenchida automaticamente:', dataFormatada, horaFormatada);
            });
        }

        // Controla a exibição dos campos de documentos de terceiro
        var terceiroEnvolvidoCheckbox = document.getElementById('terceiroEnvolvido');
        var documentosTerceiroDiv = document.getElementById('documentosTerceiro');
        if (terceiroEnvolvidoCheckbox && documentosTerceiroDiv) {
            terceiroEnvolvidoCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    documentosTerceiroDiv.style.display = 'block';
                } else {
                    documentosTerceiroDiv.style.display = 'none';
                    // Limpa os campos de upload quando desmarcado
                    document.getElementById('docTerceiroCnh').value = '';
                    document.getElementById('docTerceiroCrlv').value = '';
                    document.getElementById('docTerceiroOutros').value = '';
                }
            });
        }

        const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
        const modalElement = document.getElementById('eventDetailsModal');
        const modalInstance = modalElement ? new bootstrap.Modal(modalElement) : null;
        const loadingWrapper = document.getElementById('eventDetailsLoading');
        const contentWrapper = document.getElementById('eventDetailsContent');
        const feedbackAlert = document.getElementById('eventDetailsFeedback');
        const formElement = document.getElementById('eventDetailsForm');
        const descricaoField = document.getElementById('eventDescricao');
        const observacoesField = document.getElementById('eventObservacoes');
        const fotosField = document.getElementById('eventNovasFotos');
        const submitButton = document.getElementById('eventDetailsSubmit');
        const savingSpinner = document.getElementById('eventDetailsSavingSpinner');
        const statusBadge = document.getElementById('eventStatusBadge');
        const phaseLabel = document.getElementById('eventPhaseLabel');
        const motivoValue = document.getElementById('eventMotivoValue');
        const envolvimentoValue = document.getElementById('eventEnvolvimentoValue');
        const partnerValue = document.getElementById('eventPartnerValue');
        const vehicleValue = document.getElementById('eventVehicleValue');
        const dataAconteceu = document.getElementById('eventDataAconteceu');
        const dataComunicacao = document.getElementById('eventDataComunicacao');
        const attachmentsList = document.getElementById('eventAttachmentsList');
        const photosGrid = document.getElementById('eventPhotosGrid');
        const photosBadge = document.getElementById('eventPhotosBadge');
        const photosEmpty = document.getElementById('eventPhotosEmpty');
        const modalTitle = document.getElementById('eventDetailsModalLabel');
        const modalSubtitle = document.getElementById('eventDetailsSubtitle');
        const eventIdInput = document.getElementById('eventDetailsId');
        let currentEventId = null;

        const openButtons = document.querySelectorAll('.btn-open-event-details');
        openButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (!modalInstance) return;
                currentEventId = button.getAttribute('data-event-id');
                const focusField = button.getAttribute('data-focus') || 'descricao';
                resetModalState();
                modalInstance.show();
                loadEventDetails(currentEventId, focusField);
            });
        });

        async function loadEventDetails(eventId, focusField) {
            if (!eventId) {
                showFeedback('Comunicado inválido.', 'danger');
                return;
            }
            try {
                const response = await fetch(`/comunicados/api/events/${eventId}`);
                const data = await response.json();
                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Não foi possível carregar o comunicado.');
                }
                populateModal(data, focusField);
            } catch (error) {
                showFeedback(error.message, 'danger');
            }
        }

        function populateModal(data, focusField) {
            loadingWrapper.classList.add('d-none');
            contentWrapper.classList.remove('d-none');
            formElement.classList.remove('was-validated');

            modalTitle.textContent = data.titulo || 'Meu Comunicado';
            modalSubtitle.textContent = data.statusFormatted
                ? `${data.statusFormatted}${data.statusPhaseName ? ' · ' + data.statusPhaseName : ''}`
                : '';
            statusBadge.textContent = data.statusFormatted || '-';
            statusBadge.className = `badge ${data.statusBadgeClass || 'bg-secondary'}`;
            phaseLabel.textContent = data.statusPhaseName ? `Fase ${data.statusPhase}: ${data.statusPhaseName}` : '';
            motivoValue.textContent = data.motivoDescricao || '-';
            envolvimentoValue.textContent = data.envolvimentoDescricao || '-';
            partnerValue.textContent = data.partnerName || '-';
            vehicleValue.textContent = data.vehiclePlaque ? `${data.vehiclePlaque}${data.vehicleModel ? ' · ' + data.vehicleModel : ''}` : '-';
            dataAconteceu.textContent = formatDateWithFallback(data.dataAconteceu, data.horaAconteceu);
            dataComunicacao.textContent = formatDateWithFallback(data.dataComunicacao, data.horaComunicacao);

            renderAttachments(data.attachments);
            renderPhotos(data.photos, data.photoCount);

            descricaoField.value = data.descricao || '';
            observacoesField.value = data.observacoes || '';
            fotosField.value = '';
            eventIdInput.value = data.id || '';
            currentEventId = data.id;

            setTimeout(() => {
                if (focusField === 'observacoes') {
                    observacoesField.focus();
                } else {
                    descricaoField.focus();
                }
            }, 200);
        }

        function renderAttachments(attachments) {
            attachmentsList.innerHTML = '';
            if (!attachments || attachments.length === 0) {
                attachmentsList.innerHTML = '<span class="text-muted">Nenhum documento foi anexado.</span>';
                return;
            }
            attachments.forEach(doc => {
                const link = document.createElement('a');
                link.href = doc.url;
                link.target = '_blank';
                link.rel = 'noopener';
                link.className = 'd-flex align-items-center gap-2';
                link.innerHTML = `<i class="bi bi-file-earmark-text"></i><span>${doc.label} (${doc.filename})</span>`;
                attachmentsList.appendChild(link);
            });
        }

        function renderPhotos(photos, count) {
            photosGrid.innerHTML = '';
            const total = count ?? (photos ? photos.length : 0);
            photosBadge.textContent = total;
            if (!photos || photos.length === 0) {
                photosEmpty.classList.remove('d-none');
                return;
            }
            photosEmpty.classList.add('d-none');
            photos.forEach(photo => {
                if (!photo.url) {
                    return;
                }
                const col = document.createElement('div');
                col.className = 'col-4';
                const anchor = document.createElement('a');
                anchor.href = photo.url;
                anchor.target = '_blank';
                anchor.rel = 'noopener';
                anchor.className = 'd-block rounded border overflow-hidden';
                const img = document.createElement('img');
                img.src = photo.url;
                img.alt = 'Foto da vistoria';
                img.className = 'img-fluid';
                anchor.appendChild(img);
                col.appendChild(anchor);
                photosGrid.appendChild(col);
            });
        }

        function showFeedback(message, type) {
            feedbackAlert.textContent = message;
            feedbackAlert.className = `alert alert-${type}`;
            feedbackAlert.classList.remove('d-none');
            loadingWrapper.classList.add('d-none');
        }

        function resetModalState() {
            feedbackAlert.classList.add('d-none');
            feedbackAlert.textContent = '';
            loadingWrapper.classList.remove('d-none');
            contentWrapper.classList.add('d-none');
            formElement.classList.remove('was-validated');
            fotosField.value = '';
        }

        function toggleSaving(isSaving) {
            submitButton.disabled = isSaving;
            savingSpinner.classList.toggle('d-none', !isSaving);
        }

        function formatDateWithFallback(date, time) {
            if (!date) {
                return '-';
            }
            return time ? `${date} ${time}` : date;
        }

        formElement.addEventListener('submit', async function(event) {
            event.preventDefault();
            if (!currentEventId) {
                showFeedback('Selecione um comunicado válido.', 'danger');
                return;
            }
            if (!formElement.checkValidity()) {
                formElement.classList.add('was-validated');
                return;
            }
            try {
                toggleSaving(true);
                const formData = new FormData();
                formData.append('descricao', descricaoField.value || '');
                formData.append('observacoes', observacoesField.value || '');
                if (fotosField.files && fotosField.files.length > 0) {
                    Array.from(fotosField.files).forEach(file => formData.append('novasFotos', file));
                }
                const response = await fetch(`/comunicados/api/events/${currentEventId}/update`, {
                    method: 'POST',
                    headers: csrfHeader && csrfToken ? { [csrfHeader]: csrfToken } : undefined,
                    body: formData
                });
                const data = await response.json();
                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Não foi possível salvar as alterações.');
                }
                showFeedback(data.message || 'Alterações salvas com sucesso!', 'success');
                populateModal(data, 'descricao');
                atualizarLinhaDaTabela(data);
            } catch (error) {
                showFeedback(error.message, 'danger');
            } finally {
                toggleSaving(false);
            }
        });

        function atualizarLinhaDaTabela(data) {
            if (!data || !data.id) {
                return;
            }
            const row = document.querySelector(`[data-event-row="${data.id}"]`);
            if (!row) {
                return;
            }
            const resumo = data.descricaoResumo || '';
            const snippet = row.querySelector('small.text-muted');
            if (snippet) {
                snippet.textContent = resumo;
            }
        }
    });
</script>

</body>
</html>
