<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout-financeiro}">
<head>
    <title>SUB - Financeiro | Relat√≥rios</title>
    <style>
        .ai-report-section {
            margin-top: 2rem;
        }

        .ai-input-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .ai-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            font-size: 1rem;
        }

        .ai-btn {
            padding: 0.75rem 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .ai-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .ai-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .ai-results {
            margin-top: 1.5rem;
        }

        .ai-table {
            width: 100%;
            margin-top: 1rem;
            border-collapse: collapse;
        }

        .ai-table th {
            background-color: #f8f9fa;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        .ai-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #dee2e6;
        }

        .ai-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .ai-alert {
            padding: 1rem;
            border-radius: 0.375rem;
            margin-top: 1rem;
        }

        .ai-alert-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .ai-alert-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .ai-alert-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .ai-loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .ai-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.375rem 0.375rem 0 0;
            font-size: 1.25rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
<section layout:fragment="content" class="financeiro-section">
    <div class="page-header d-flex align-items-center justify-content-between flex-wrap gap-3">
    </div>

    <!-- Gr√°ficos Existentes -->
    <div class="row mt-4">
        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div th:utext="${chartEntradaSaida}"></div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div th:utext="${chartCategorias}"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Nova Se√ß√£o: Relat√≥rios com IA -->
    <div class="row ai-report-section">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="ai-card-header">
                    ü§ñ Relat√≥rios Din√¢micos com IA
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">
                        Fa√ßa perguntas em linguagem natural e obtenha dados do sistema.
                        Exemplos: "Quantos ve√≠culos ativos temos?", "Liste os 5 parceiros mais recentes",
                        "Qual o total de mensalidades?"
                    </p>

                    <div class="ai-input-group">
                        <input
                            type="text"
                            id="aiPergunta"
                            class="ai-input"
                            placeholder="Digite sua pergunta aqui..."
                            onkeypress="if(event.key === 'Enter') gerarRelatorioIA()"
                        />
                        <button id="aiBtn" class="ai-btn" onclick="gerarRelatorioIA()">
                            Gerar com IA
                        </button>
                    </div>

                    <div id="aiResultados" class="ai-results"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<script th:inline="javascript">
/**
 * Fun√ß√£o para gerar relat√≥rio usando IA
 */
async function gerarRelatorioIA() {
    const pergunta = document.getElementById('aiPergunta').value.trim();
    const btnElement = document.getElementById('aiBtn');
    const resultadosDiv = document.getElementById('aiResultados');

    // Validar entrada
    if (!pergunta) {
        resultadosDiv.innerHTML = '<div class="ai-alert ai-alert-error">Por favor, digite uma pergunta.</div>';
        return;
    }

    // Desabilitar bot√£o e mostrar loading
    btnElement.disabled = true;
    btnElement.innerHTML = '<span class="ai-loading"></span>Gerando...';
    resultadosDiv.innerHTML = '<div class="ai-alert ai-alert-info">üîÑ Processando sua pergunta com IA...</div>';

    try {
        // Fazer requisi√ß√£o para API
        const response = await fetch('/api/relatorios-ia/gerar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ pergunta: pergunta })
        });

        const data = await response.json();

        if (data.sucesso && data.dados && data.dados.length > 0) {
            // Renderizar tabela com resultados
            renderizarTabela(data.dados);

            // Mostrar mensagem de sucesso
            const mensagem = `
                <div class="ai-alert ai-alert-success">
                    ‚úÖ ${data.mensagem} - ${data.totalLinhas} linha(s) encontrada(s)
                </div>
            `;
            resultadosDiv.insertAdjacentHTML('afterbegin', mensagem);

        } else if (data.sucesso && data.dados && data.dados.length === 0) {
            resultadosDiv.innerHTML = '<div class="ai-alert ai-alert-info">‚ÑπÔ∏è Nenhum resultado encontrado para sua pergunta.</div>';

        } else {
            // Mostrar mensagem de erro
            resultadosDiv.innerHTML = `<div class="ai-alert ai-alert-error">‚ùå ${data.mensagem || 'Erro ao gerar relat√≥rio'}</div>`;
        }

    } catch (error) {
        console.error('Erro ao gerar relat√≥rio:', error);
        resultadosDiv.innerHTML = `<div class="ai-alert ai-alert-error">‚ùå Erro de conex√£o: ${error.message}</div>`;

    } finally {
        // Reabilitar bot√£o
        btnElement.disabled = false;
        btnElement.innerHTML = 'Gerar com IA';
    }
}

/**
 * Renderiza tabela HTML com os dados retornados
 */
function renderizarTabela(dados) {
    const resultadosDiv = document.getElementById('aiResultados');

    // Obter colunas do primeiro registro
    const colunas = Object.keys(dados[0]);

    // Construir tabela
    let tabelaHTML = '<table class="ai-table">';

    // Cabe√ßalho
    tabelaHTML += '<thead><tr>';
    colunas.forEach(coluna => {
        tabelaHTML += `<th>${formatarNomeColuna(coluna)}</th>`;
    });
    tabelaHTML += '</tr></thead>';

    // Corpo
    tabelaHTML += '<tbody>';
    dados.forEach(linha => {
        tabelaHTML += '<tr>';
        colunas.forEach(coluna => {
            const valor = linha[coluna];
            tabelaHTML += `<td>${formatarValor(valor)}</td>`;
        });
        tabelaHTML += '</tr>';
    });
    tabelaHTML += '</tbody></table>';

    resultadosDiv.innerHTML += tabelaHTML;
}

/**
 * Formata nome da coluna para exibi√ß√£o
 */
function formatarNomeColuna(nome) {
    // Converter snake_case para T√≠tulo
    return nome
        .split('_')
        .map(palavra => palavra.charAt(0).toUpperCase() + palavra.slice(1).toLowerCase())
        .join(' ');
}

/**
 * Formata valor para exibi√ß√£o
 */
function formatarValor(valor) {
    if (valor === null || valor === undefined) {
        return '<em>-</em>';
    }

    // Formatar n√∫meros
    if (typeof valor === 'number') {
        // Se for um n√∫mero grande, pode ser um valor monet√°rio
        if (Number.isInteger(valor) && valor > 1000000) {
            return valor.toLocaleString('pt-BR');
        }
        // Se tiver decimais, pode ser valor monet√°rio
        if (!Number.isInteger(valor)) {
            return 'R$ ' + valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        return valor.toLocaleString('pt-BR');
    }

    // Formatar datas (formato ISO)
    if (typeof valor === 'string' && /^\d{4}-\d{2}-\d{2}/.test(valor)) {
        const data = new Date(valor);
        if (!isNaN(data.getTime())) {
            return data.toLocaleDateString('pt-BR');
        }
    }

    return valor;
}
</script>
</body>
</html>