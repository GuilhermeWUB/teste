<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" data-theme="light">
<script src="/js/layout.js"></script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>
    <title th:text="${pageTitle} ?: 'SUB - CRM'">SUB - CRM</title>
    <link rel="icon" type="image/svg+xml" th:href="@{/images/favicon.svg}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/custom-dark-mode.css}">
    <link rel="stylesheet" th:href="@{/css/layout-fragment.css}">
</head>
<body>

<!-- ========================================
     USA O FRAGMENTO HEADER-CRM
     ======================================== -->
<div th:replace="~{fragments/header-crm :: header-crm}"></div>

<main class="page">
    <div class="container">
        <div class="page-content">
            <section layout:fragment="content"></section>
        </div>
    </div>
</main>

<footer class="site-footer">
    <div class="container">
        <p>&copy; <span th:text="${T(java.time.Year).now()}"></span> SUB - CRM. Todos os direitos reservados.</p>
    </div>
</footer>

<button type="button" class="back-to-top" id="back-to-top" aria-hidden="true" tabindex="-1">
    <span class="back-to-top__icon" aria-hidden="true">⬆</span>
    <span class="back-to-top__text">Voltar ao topo</span>
</button>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- ========================================
     SCRIPTS DO LAYOUT (MESMOS DO LAYOUT.HTML)
     ======================================== -->
<script>
    (function () {
        const docElement = document.documentElement;
        const themeToggles = document.querySelectorAll('[data-theme-toggle]');
        const navToggle = document.getElementById('navToggle');
        const navLinks = document.querySelectorAll('.nav-links a');
        const navDropdownItems = document.querySelectorAll('.nav-item-dropdown');
        const navDropdownToggles = document.querySelectorAll('[data-nav-dropdown]');
        const backToTopButton = document.getElementById('back-to-top');
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
        const disableDarkBlurRegion = document.querySelector('[data-no-dark-blur]');

        if (document.body) {
            if (disableDarkBlurRegion) {
                document.body.classList.add('no-dark-blur');
            } else {
                document.body.classList.remove('no-dark-blur');
            }
        }

        const storedTheme = localStorage.getItem('theme');
        if (storedTheme === 'dark' || (!storedTheme && prefersDarkScheme.matches)) {
            docElement.setAttribute('data-theme', 'dark');
        }

        function closeAllNavDropdowns(except) {
            navDropdownItems.forEach(function (item) {
                if (item !== except) {
                    item.classList.remove('is-open');
                    const toggle = item.querySelector('[data-nav-dropdown]');
                    if (toggle) {
                        toggle.setAttribute('aria-expanded', 'false');
                    }
                }
            });
        }

        navDropdownToggles.forEach(function (toggle) {
            const dropdownItem = toggle.closest('.nav-item-dropdown');
            if (!dropdownItem) {
                return;
            }

            toggle.addEventListener('click', function (event) {
                event.preventDefault();
                const isOpen = dropdownItem.classList.toggle('is-open');
                toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
                if (isOpen) {
                    closeAllNavDropdowns(dropdownItem);
                } else {
                    closeAllNavDropdowns();
                }
            });
        });

        document.addEventListener('click', function (event) {
            if (!event.target.closest('.nav-item-dropdown')) {
                closeAllNavDropdowns();
            }
        });

        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                closeAllNavDropdowns();
            }
        });

        function toggleTheme() {
            const isDark = docElement.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            docElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        themeToggles.forEach(function (button) {
            button.addEventListener('click', function () {
                toggleTheme();
            });
        });

        prefersDarkScheme.addEventListener('change', function (event) {
            const saved = localStorage.getItem('theme');
            if (!saved) {
                docElement.setAttribute('data-theme', event.matches ? 'dark' : 'light');
            }
        });

        navLinks.forEach(function (link) {
            link.addEventListener('click', function () {
                closeAllNavDropdowns();
                if (navToggle && navToggle.checked) {
                    navToggle.checked = false;
                }
            });
        });

        if (navToggle) {
            navToggle.addEventListener('change', function () {
                if (!navToggle.checked) {
                    closeAllNavDropdowns();
                }
            });
        }

        function handleBackToTopVisibility() {
            if (!backToTopButton) {
                return;
            }
            if (window.scrollY > 300) {
                backToTopButton.classList.add('is-visible');
            } else {
                backToTopButton.classList.remove('is-visible');
            }
        }

        if (backToTopButton) {
            backToTopButton.addEventListener('click', function () {
                window.scrollTo({top: 0, behavior: 'smooth'});
            });
        }

        window.addEventListener('scroll', handleBackToTopVisibility, {passive: true});
        handleBackToTopVisibility();
    })();
</script>

<!-- ========================================
     SCRIPT PARA DESTACAR PÁGINA ATIVA
     ======================================== -->
<script>
    (function () {
        'use strict';

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', highlightActiveNavItem);
        } else {
            highlightActiveNavItem();
        }

        function highlightActiveNavItem() {
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-links a:not(.btn), .nav-links a[data-nav-highlight="true"]');
            const dropdownToggles = document.querySelectorAll('.nav-dropdown-toggle');
            const dropdownLinks = document.querySelectorAll('.nav-dropdown-link');

            navLinks.forEach(link => link.classList.remove('active'));
            dropdownToggles.forEach(toggle => toggle.classList.remove('active'));
            dropdownLinks.forEach(link => link.classList.remove('active'));

            navLinks.forEach(link => {
                const href = link.getAttribute('href');

                if (!href || href === '#' || href === '/') {
                    return;
                }

                if (currentPath === href || currentPath.startsWith(href + '/')) {
                    link.classList.add('active');
                }
            });

            console.log('✅ Página ativa destacada na navbar (CRM):', currentPath);
        }
    })();
</script>

<!-- ========================================
     JAVASCRIPT DO SISTEMA DE NOTIFICAÇÕES
     ======================================== -->
<script>
    (function () {
        'use strict';

        const bellBtn = document.getElementById('notificationBellBtn');
        const dropdown = document.getElementById('notificationDropdown');
        const badge = document.getElementById('notificationBadge');
        const mobileBadge = document.getElementById('mobileNotificationBadge');
        const notificationList = document.getElementById('notificationList');
        const markAllReadBtn = document.getElementById('markAllReadBtn');

        if (!bellBtn || !dropdown) {
            return;
        }

        bellBtn.setAttribute('aria-expanded', 'false');

        let isDropdownOpen = false;
        let unreadCount = 0;

        fetchUnreadCount();
        setInterval(fetchUnreadCount, 30000);

        bellBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (isDropdownOpen) {
                closeDropdown();
            } else {
                openDropdown();
            }
        });

        document.addEventListener('click', function(e) {
            if (isDropdownOpen && !dropdown.contains(e.target) && !bellBtn.contains(e.target)) {
                closeDropdown();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (isDropdownOpen && e.key === 'Escape') {
                closeDropdown();
                bellBtn.focus();
            }
        });

        if (markAllReadBtn) {
            markAllReadBtn.addEventListener('click', function() {
                markAllAsRead();
            });
        }

        function openDropdown() {
            dropdown.style.display = 'block';
            isDropdownOpen = true;
            bellBtn.classList.add('is-open');
            bellBtn.setAttribute('aria-expanded', 'true');
            loadNotifications();
        }

        function closeDropdown() {
            dropdown.style.display = 'none';
            isDropdownOpen = false;
            bellBtn.classList.remove('is-open');
            bellBtn.setAttribute('aria-expanded', 'false');
        }

        function fetchUnreadCount() {
            fetch('/notifications/api/unread-count', {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                unreadCount = data.unreadCount || 0;
                updateBadge();
            })
            .catch(error => {
                console.error('Erro ao buscar contador de notificações:', error);
            });
        }

        function updateBadge() {
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.style.display = 'block';
                if (mobileBadge) {
                    mobileBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    mobileBadge.style.display = 'inline-block';
                }
                bellBtn.classList.add('has-notifications');
            } else {
                badge.style.display = 'none';
                if (mobileBadge) {
                    mobileBadge.style.display = 'none';
                }
                bellBtn.classList.remove('has-notifications');
            }
        }

        function loadNotifications() {
            notificationList.innerHTML = '<div class="text-center py-4 text-muted"><div class="spinner-border spinner-border-sm mb-2" role="status"><span class="visually-hidden">Carregando...</span></div><p class="small mb-0">Carregando notificações...</p></div>';

            fetch('/notifications/api/recent/10', {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                renderNotifications(data);
            })
            .catch(error => {
                console.error('Erro ao carregar notificações:', error);
                notificationList.innerHTML = '<div class="notification-empty"><i class="bi bi-exclamation-circle"></i><p class="mb-0">Erro ao carregar notificações</p></div>';
            });
        }

        function renderNotifications(notifications) {
            if (!notifications || notifications.length === 0) {
                notificationList.innerHTML = '<div class="notification-empty"><i class="bi bi-bell-slash"></i><p class="mb-0">Nenhuma notificação</p></div>';
                markAllReadBtn.style.display = 'none';
                return;
            }

            const hasUnread = notifications.some(n => n.status === 'UNREAD');
            markAllReadBtn.style.display = hasUnread ? 'block' : 'none';

            const html = notifications.map(notification => {
                const isUnread = notification.status === 'UNREAD';
                const icon = getNotificationIcon(notification.type);
                const timeAgo = formatTimeAgo(notification.createdAt);
                const url = notification.actionUrl || '/notifications/' + notification.id;

                return `
                    <a href="${escapeHtml(url)}" class="notification-item ${isUnread ? 'unread' : ''}" data-notification-id="${notification.id}">
                        <div class="notification-item-icon notification-icon-${notification.type}">
                            <i class="${icon}"></i>
                        </div>
                        <div class="notification-item-content">
                            <div class="notification-item-title">${escapeHtml(notification.title)}</div>
                            <div class="notification-item-message">${escapeHtml(notification.message)}</div>
                            <div class="notification-item-time">${timeAgo}</div>
                        </div>
                    </a>
                `;
            }).join('');

            notificationList.innerHTML = html;

            notificationList.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    const notificationId = this.getAttribute('data-notification-id');
                    if (this.classList.contains('unread')) {
                        markAsRead(notificationId);
                    }
                });
            });
        }

        function markAsRead(notificationId) {
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

            const headers = {
                'X-Requested-With': 'XMLHttpRequest'
            };
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }

            fetch('/notifications/api/' + notificationId + '/mark-read', {
                method: 'POST',
                headers: headers
            })
            .then(() => {
                fetchUnreadCount();
            })
            .catch(error => {
                console.error('Erro ao marcar notificação como lida:', error);
            });
        }

        function markAllAsRead() {
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

            const headers = {
                'X-Requested-With': 'XMLHttpRequest'
            };
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }

            fetch('/notifications/api/mark-all-read', {
                method: 'POST',
                headers: headers
            })
            .then(() => {
                fetchUnreadCount();
                loadNotifications();
            })
            .catch(error => {
                console.error('Erro ao marcar todas como lidas:', error);
            });
        }

        function getNotificationIcon(type) {
            const icons = {
                'EVENT': 'bi bi-calendar-event',
                'DEMAND': 'bi bi-list-task',
                'PAYMENT': 'bi bi-credit-card',
                'BANK_SLIP': 'bi bi-file-earmark-text',
                'ALERT': 'bi bi-exclamation-triangle',
                'SYSTEM': 'bi bi-gear',
                'COMUNICADO': 'bi bi-megaphone',
                'PARTNER': 'bi bi-person',
                'VEHICLE': 'bi bi-car-front',
                'INFO': 'bi bi-info-circle'
            };
            return icons[type] || 'bi bi-bell';
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Agora';
            if (diffMins < 60) return diffMins + ' min atrás';
            if (diffHours < 24) return diffHours + 'h atrás';
            if (diffDays < 7) return diffDays + 'd atrás';

            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    })();
</script>

<th:block layout:fragment="scripts"></th:block>
</body>
</html>
