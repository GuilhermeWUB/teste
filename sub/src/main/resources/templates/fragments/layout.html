<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" data-theme="light">
<script src="/js/layout.js"></script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>
    <title th:text="${pageTitle} ?: 'SUB'">SUB</title>
    <link rel="icon" type="image/svg+xml" th:href="@{/images/favicon.svg}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/custom-dark-mode.css}">
</head>
<body>
<header class="topbar">
    <div class="brand">
        <a class="brand-link" th:href="${isLoggedIn} ? (${isAdmin} ? @{/dashboard} : @{/me/plan}) : @{/}">
            <img class="brand-logo" th:src="@{/images/ub_02_2.jpeg}" alt="SUB" title="Ir para a p√°gina inicial">
            <span class="brand-title">SUB</span>
        </a>
    </div>

    <input type="checkbox" id="navToggle" class="nav-toggle" aria-hidden="true">
    <label class="nav-toggle-label" for="navToggle" aria-label="Alternar navega√ß√£o">
        <span></span>
        <span></span>
        <span></span>
    </label>

    <nav class="topbar-nav" aria-label="Navega√ß√£o principal">
        <ul class="nav-links">
            <li th:if="${!isAdmin and isLoggedIn}">
                <a th:href="@{/me/plan}">Meu Plano</a>
            </li>
            <li th:if="${isAdmin}">
                <a th:href="@{/dashboard}">Dashboard</a>
            </li>
            <li th:if="${isAdmin}">
                <a th:href="@{/partners}">Associados</a>
            </li>
            <li th:if="${isAdmin}">
                <a th:href="@{/vehicles}">Ve√≠culos</a>
            </li>
            <li th:if="${isAdmin}">
                <a th:href="@{/events}">Eventos</a>
            </li>

            <li th:if="${hasDemandsAccess}" class="nav-item nav-item-dropdown">
                <button type="button" class="nav-dropdown-toggle" data-nav-dropdown aria-expanded="false" aria-haspopup="true">
                    <span>Demandas</span>
                    <i class="bi bi-chevron-down nav-dropdown-icon" aria-hidden="true"></i>
                </button>
                <ul class="nav-dropdown-menu" role="menu">
                    <li th:if="${canCreateDemands}" role="none">
                        <a role="menuitem" th:href="@{/demands/director}" class="nav-dropdown-link">
                            <i class="bi bi-plus-circle" aria-hidden="true"></i>
                            <span>Criar Demanda</span>
                        </a>
                    </li>
                    <li th:if="${canAccessMyDemands}" role="none">
                        <a role="menuitem" th:href="@{/demands/my-demands}" class="nav-dropdown-link">
                            <i class="bi bi-list-check" aria-hidden="true"></i>
                            <span>Minhas Demandas</span>
                        </a>
                    </li>
                </ul>
            </li>

            <li th:if="${isAdmin}" class="nav-item nav-item-dropdown">
                <button type="button" class="nav-dropdown-toggle" data-nav-dropdown aria-expanded="false" aria-haspopup="true">
                    <span>Relat√≥rios</span>
                    <i class="bi bi-chevron-down nav-dropdown-icon" aria-hidden="true"></i>
                </button>
                <ul class="nav-dropdown-menu" role="menu">
                    <li role="none">
                        <a role="menuitem" th:href="@{/reports/vehicles}" class="nav-dropdown-link">
                            <i class="bi bi-car-front" aria-hidden="true"></i>
                            <span>Relat√≥rio de Ve√≠culos</span>
                        </a>
                    </li>
                    <li role="none">
                        <a role="menuitem" th:href="@{/reports/partners}" class="nav-dropdown-link">
                            <i class="bi bi-people" aria-hidden="true"></i>
                            <span>Relat√≥rio de Associados</span>
                        </a>
                    </li>
                </ul>
            </li>

            <li th:if="${isAdmin}" class="nav-item nav-item-dropdown">
                <button type="button" class="nav-dropdown-toggle" data-nav-dropdown aria-expanded="false" aria-haspopup="true">
                    <span>Jur√≠dico</span>
                    <i class="bi bi-chevron-down nav-dropdown-icon" aria-hidden="true"></i>
                </button>
                <ul class="nav-dropdown-menu" role="menu">
                    <li role="none">
                        <a role="menuitem" th:href="@{/juridico/cobranca}" class="nav-dropdown-link">
                            <i class="bi bi-file-earmark-text" aria-hidden="true"></i>
                            <span>Cobran√ßa</span>
                        </a>
                    </li>
                    <li role="none">
                        <a role="menuitem" th:href="@{/juridico/processos}" class="nav-dropdown-link">
                            <i class="bi bi-briefcase" aria-hidden="true"></i>
                            <span>Processos em Geral</span>
                        </a>
                    </li>
                    <li role="none">
                        <a role="menuitem" th:href="@{/juridico/acordos}" class="nav-dropdown-link">
                            <i class="bi bi-clipboard-check" aria-hidden="true"></i>
                            <span>Acordos a pagar</span>
                        </a>
                    </li>
                </ul>
            </li>

            <li th:if="${isAdmin}">
                <a th:href="@{/admin/users}">Usu√°rios</a>
            </li>
            <li th:if="${!isAdmin and isLoggedIn}">
                <a th:href="@{/me/vehicles}">Meus Ve√≠culos</a>
            </li>
            <li th:if="${!isAdmin and isLoggedIn}">
                <a th:href="@{/me/comunicado}">Comunicado</a>
            </li>
            <li th:if="${!isLoggedIn}">
                <a th:href="@{/register}">Quero ser associado</a>
            </li>
            <li class="nav-item-mobile-action" th:if="${isLoggedIn}">
                <a th:href="@{/notifications}">
                    <i class="bi bi-bell-fill me-1"></i>
                    <span>Notifica√ß√µes</span>
                    <span class="badge bg-primary ms-2" id="mobileNotificationBadge" style="display: none;">0</span>
                </a>
            </li>
            <li class="nav-item-theme nav-item-mobile-action">
                <button type="button" class="theme-toggle" data-theme-toggle>
                    <span class="theme-toggle__icon theme-toggle__icon--dark" aria-hidden="true">üåô</span>
                    <span class="theme-toggle__icon theme-toggle__icon--light" aria-hidden="true">
                        <i class="bi bi-sun-fill"></i></span>
                    <span class="theme-toggle__label"></span>
                </button>
            </li>
            <li class="nav-item-mobile-action" th:if="${isLoggedIn}">
                <a class="btn btn-outline" th:href="@{/logout}">
                    <i class="bi bi-box-arrow-right me-1"></i>
                    <span>Sair</span>
                </a>
            </li>
            <li class="nav-item-mobile-action" th:unless="${isLoggedIn}">
                <a class="btn btn-primary" th:href="@{/login}">
                    <i class="bi bi-box-arrow-in-right me-1"></i>
                    <span>Entrar</span>
                </a>
            </li>
        </ul>
    </nav>

    <div class="topbar-actions">
        <!-- Bot√£o de Notifica√ß√µes (Desktop) -->
        <div class="notification-bell-wrapper" th:if="${isLoggedIn}">
            <button type="button"
                    class="notification-bell-button"
                    id="notificationBellBtn"
                    aria-label="Notifica√ß√µes"
                    aria-haspopup="true"
                    aria-expanded="false">
                <i class="bi bi-bell-fill" aria-hidden="true"></i>
                <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
            </button>

            <!-- Dropdown de Notifica√ß√µes -->
            <div class="notification-dropdown" id="notificationDropdown" style="display: none;">
                <div class="notification-dropdown-header">
                    <h6 class="mb-0">Notifica√ß√µes</h6>
                    <button type="button" class="btn btn-sm btn-link text-decoration-none p-0" id="markAllReadBtn" style="display: none;">
                        Marcar todas como lidas
                    </button>
                </div>
                <div class="notification-dropdown-body" id="notificationList">
                    <div class="text-center py-4 text-muted">
                        <div class="spinner-border spinner-border-sm mb-2" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="small mb-0">Carregando notifica√ß√µes...</p>
                    </div>
                </div>
                <div class="notification-dropdown-footer">
                    <a th:href="@{/notifications}" class="btn btn-sm btn-link text-decoration-none w-100">
                        Ver todas as notifica√ß√µes
                    </a>
                </div>
            </div>
        </div>

        <button type="button" class="theme-toggle" data-theme-toggle>
            <span class="theme-toggle__icon theme-toggle__icon--dark" aria-hidden="true"><i class="bi bi-moon-fill"></i></span>
            <span class="theme-toggle__icon theme-toggle__icon--light" aria-hidden="true"><i class="bi bi-sun-fill"></i></span>
            <span class="theme-toggle__label"></span>
        </button>
        <a class="btn btn-outline" th:if="${isLoggedIn}" th:href="@{/logout}">
            <i class="bi bi-box-arrow-right me-1"></i>
            <span>Sair</span>
        </a>
        <a class="btn btn-primary" th:unless="${isLoggedIn}" th:href="@{/login}">
            <i class="bi bi-box-arrow-in-right me-1"></i>
            <span>Entrar</span>
        </a>
    </div>
</header>

<main class="page">
    <div class="container">
        <div class="page-content">
            <section layout:fragment="content"></section>
        </div>
    </div>
</main>

<footer class="site-footer">
    <div class="container">
        <p>&copy; <span th:text="${T(java.time.Year).now()}"></span> SUB - System. Todos os direitos reservados.</p>
    </div>
</footer>

<button type="button" class="back-to-top" id="back-to-top" aria-hidden="true" tabindex="-1">
    <span class="back-to-top__icon" aria-hidden="true">‚¨Ü</span>
    <span class="back-to-top__text">Voltar ao topo</span>
</button>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    (function () {
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
        const FETCH_HEADERS = {
            'X-Requested-With': 'XMLHttpRequest'
        };

        if (csrfToken && csrfHeader) {
            FETCH_HEADERS[csrfHeader] = csrfToken;
        }

        const DATE_TIME_FORMATTER = new Intl.DateTimeFormat('pt-BR', {dateStyle: 'short', timeStyle: 'short'});

        function escapeHtml(value) {
            if (value === null || value === undefined) {
                return '';
            }
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function toDisplay(value, fallback = '‚Äî') {
            if (value === null || value === undefined || value === '') {
                return escapeHtml(fallback);
            }
            return escapeHtml(String(value));
        }

        function renderVehicleResults(data) {
            if (!data || data.hasVehicles === false) {
                const message = data && data.message ? data.message : 'N√£o h√° ve√≠culos cadastrados para gerar o relat√≥rio.';
                return '<div class="alert alert-warning d-flex align-items-center gap-2"><i class="bi bi-exclamation-triangle-fill fs-4"></i><span>' + toDisplay(message) + '</span></div>';
            }

            const sections = [];

            if (data.summary) {
                sections.push(renderVehicleSummary(data.summary));
            }

            const distributionColumns = [];
            if (Object.prototype.hasOwnProperty.call(data, 'fuelDistribution')) {
                distributionColumns.push(renderDistributionColumn('Distribui√ß√£o por combust√≠vel', 'bi bi-fuel-pump-fill', data.fuelDistribution, 'Nenhuma informa√ß√£o dispon√≠vel.'));
            }
            if (Object.prototype.hasOwnProperty.call(data, 'makerDistribution')) {
                distributionColumns.push(renderDistributionColumn('Montadoras com mais ve√≠culos', 'bi bi-building', data.makerDistribution, 'Nenhuma informa√ß√£o dispon√≠vel.'));
            }
            if (distributionColumns.length) {
                sections.push('<div class="report-section"><div class="row g-4">' + distributionColumns.join('') + '</div></div>');
            }

            if (Object.prototype.hasOwnProperty.call(data, 'vehicles')) {
                sections.push(renderVehicleTable(Array.isArray(data.vehicles) ? data.vehicles : []));
            }

            if (!sections.length) {
                sections.push('<div class="alert alert-info mb-0">Nenhuma se√ß√£o foi selecionada para exibi√ß√£o.</div>');
            }

            return sections.join('');
        }

        function renderVehicleSummary(summary) {
            return `
                <div class="report-section">
                    <div class="row g-4">
                        <div class="col-md-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <span class="text-muted text-uppercase fw-semibold small">Ve√≠culos cadastrados</span>
                                    <div class="d-flex align-items-center justify-content-between mt-2">
                                        <h2 class="fw-bold mb-0">${toDisplay(summary.totalVehicles ?? 0, "0")}</h2>
                                        <span class="display-6 text-primary"><i class="bi bi-car-front"></i></span>
                                    </div>
                                    <p class="text-muted small mb-0">Quantidade total de ve√≠culos ativos no sistema.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <span class="text-muted text-uppercase fw-semibold small">Ve√≠culos ativos</span>
                                    <div class="d-flex align-items-center justify-content-between mt-2">
                                        <h2 class="fw-bold mb-0">${toDisplay(summary.activeVehicles ?? 0, "0")}</h2>
                                        <span class="display-6 text-success"><i class="bi bi-check-circle"></i></span>
                                    </div>
                                    <p class="text-muted small mb-0">Ve√≠culos com mensalidade em dia.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <span class="text-muted text-uppercase fw-semibold small">Ve√≠culos pendentes</span>
                                    <div class="d-flex align-items-center justify-content-between mt-2">
                                        <h2 class="fw-bold mb-0">${toDisplay(summary.pendingVehicles ?? 0, "0")}</h2>
                                        <span class="display-6 text-warning"><i class="bi bi-hourglass-split"></i></span>
                                    </div>
                                    <p class="text-muted small mb-0">Ve√≠culos aguardando regulariza√ß√£o.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <span class="text-muted text-uppercase fw-semibold small">Mensalidade m√©dia</span>
                                    <div class="d-flex align-items-center justify-content-between mt-2">
                                        <h2 class="fw-bold mb-0">${toDisplay(summary.averageMonthlyValue, "R$ 0,00")}</h2>
                                        <span class="display-6 text-primary"><i class="bi bi-coin"></i></span>
                                    </div>
                                    <p class="text-muted small mb-0">Valor m√©dio das mensalidades registradas.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDistributionColumn(title, icon, distribution, emptyMessage) {
            const hasItems = distribution && Array.isArray(distribution.items) && distribution.items.length;
            const listItems = hasItems
                ? distribution.items.map((item) => `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>${toDisplay(item.label, 'N√£o informado')}</span>
                            <span class="badge bg-primary rounded-pill">${toDisplay(item.value, '0')}</span>
                        </li>
                    `).join('')
                : '';

            return `
                <div class="col-lg-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h5 class="card-title mb-0 d-flex align-items-center gap-2">
                                <i class="${icon} text-primary"></i>
                                <span>${toDisplay(title, 'Distribui√ß√£o')}</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            ${hasItems ? `<ul class="list-group list-group-flush">${listItems}</ul>` : `<div class="text-muted">${toDisplay(emptyMessage)}</div>`}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderVehicleTable(items) {
            const hasItems = Array.isArray(items) && items.length;
            const rows = hasItems
                ? items.map((item) => `
                        <tr>
                            <td>
                                <div class="fw-semibold">${toDisplay(item.description, 'N√£o informado')}</div>
                                <small class="text-muted">${toDisplay(item.modelYear, 'Ano n√£o informado')}</small>
                            </td>
                            <td>${toDisplay(item.plaque, '‚Äî')}</td>
                            <td>${toDisplay(item.partnerName, '‚Äî')}</td>
                            <td><span class="badge bg-light text-dark">${toDisplay(item.status, 'N√£o informado')}</span></td>
                            <td>${toDisplay(item.fuelType, 'N√£o informado')}</td>
                            <td>${toDisplay(item.monthlyValue, '‚Äî')}</td>
                        </tr>
                    `).join('')
                : '';

            return `
                <div class="report-section report-results-table card border-0 shadow-sm">
                    <div class="card-header bg-transparent border-0 pb-0">
                        <h5 class="card-title mb-0 d-flex align-items-center gap-2">
                            <i class="bi bi-card-checklist text-primary"></i>
                            <span>Detalhamento dos ve√≠culos</span>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        ${hasItems ? `
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead>
                                        <tr>
                                            <th>Ve√≠culo</th>
                                            <th>Placa</th>
                                            <th>Associado</th>
                                            <th>Status</th>
                                            <th>Combust√≠vel</th>
                                            <th>Mensalidade</th>
                                        </tr>
                                    </thead>
                                    <tbody>${rows}</tbody>
                                </table>
                            </div>` : '<div class="p-4 text-muted">Nenhum ve√≠culo encontrado para os filtros selecionados.</div>'}
                    </div>
                </div>
            `;
        }

        function renderPartnerResults(data) {
            if (!data || data.hasPartners === false) {
                const message = data && data.message ? data.message : 'N√£o h√° associados cadastrados para gerar o relat√≥rio.';
                return '<div class="alert alert-warning d-flex align-items-center gap-2"><i class="bi bi-exclamation-triangle-fill fs-4"></i><span>' + toDisplay(message) + '</span></div>';
            }

            const sections = [];

            if (data.summary) {
                sections.push(renderPartnerSummary(data.summary));
            }

            const insights = [];
            if (Object.prototype.hasOwnProperty.call(data, 'topCities')) {
                insights.push(renderTopCitiesColumn(Array.isArray(data.topCities) ? data.topCities : []));
            }
            if (Object.prototype.hasOwnProperty.call(data, 'generalIndicators')) {
                insights.push(renderPartnerIndicatorsColumn(data.generalIndicators || {}));
            }
            if (insights.length) {
                sections.push('<div class="report-section"><div class="row g-4">' + insights.join('') + '</div></div>');
            }

            if (Object.prototype.hasOwnProperty.call(data, 'partners')) {
                sections.push(renderPartnerTable(Array.isArray(data.partners) ? data.partners : []));
            }

            if (!sections.length) {
                sections.push('<div class="alert alert-info mb-0">Nenhuma se√ß√£o foi selecionada para exibi√ß√£o.</div>');
            }

            return sections.join('');
        }

        function renderPartnerSummary(summary) {
            return `
                <div class="report-section">
                    <div class="row g-4">
                        <div class="col-md-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <span class="text-muted text-uppercase fw-semibold small">Associados cadastrados</span>
                                    <div class="d-flex align-items-center justify-content-between mt-2">
                                        <h2 class="fw-bold mb-0">${toDisplay(summary.totalPartners ?? 0, "0")}</h2>
                                        <span class="display-6 text-primary"><i class="bi bi-people"></i></span>
                                    </div>
                                    <p class="text-muted small mb-0">Todos os associados ativos no sistema.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <span class="text-muted text-uppercase fw-semibold small">Com ve√≠culos</span>
                                    <div class="d-flex align-items-center justify-content-between mt-2">
                                        <h2 class="fw-bold mb-0">${toDisplay(summary.partnersWithVehicles ?? 0, "0")}</h2>
                                        <span class="display-6 text-success"><i class="bi bi-truck"></i></span>
                                    </div>
                                    <p class="text-muted small mb-0">Associados que possuem pelo menos um ve√≠culo ativo.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <span class="text-muted text-uppercase fw-semibold small">Sem ve√≠culos</span>
                                    <div class="d-flex align-items-center justify-content-between mt-2">
                                        <h2 class="fw-bold mb-0">${toDisplay(summary.partnersWithoutVehicles ?? 0, "0")}</h2>
                                        <span class="display-6 text-warning"><i class="bi bi-person-dash"></i></span>
                                    </div>
                                    <p class="text-muted small mb-0">Associados que ainda n√£o possuem ve√≠culos cadastrados.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <span class="text-muted text-uppercase fw-semibold small">M√©dia de ve√≠culos</span>
                                    <div class="d-flex align-items-center justify-content-between mt-2">
                                        <h2 class="fw-bold mb-0">${toDisplay(summary.averageVehiclesPerPartner, "0,00")}</h2>
                                        <span class="display-6 text-primary"><i class="bi bi-speedometer2"></i></span>
                                    </div>
                                    <p class="text-muted small mb-0">Quantidade m√©dia de ve√≠culos por associado.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTopCitiesColumn(items) {
            const hasItems = Array.isArray(items) && items.length;
            const limited = hasItems ? items.slice(0, 5) : [];
            const listItems = limited
                .map((item) => `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>${toDisplay(item.label, 'N√£o informado')}</span>
                            <span class="badge bg-primary rounded-pill">${toDisplay(item.value, '0')}</span>
                        </li>
                    `).join('');

            return `
                <div class="col-lg-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h5 class="card-title mb-0 d-flex align-items-center gap-2">
                                <i class="bi bi-geo-alt-fill text-primary"></i>
                                <span>Cidades com mais associados</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            ${hasItems ? `<ul class="list-group list-group-flush">${listItems}</ul><p class="text-muted small mb-0 mt-3">Exibindo as cinco cidades com maior volume de associados.</p>` : '<div class="text-muted">Nenhuma informa√ß√£o dispon√≠vel.</div>'}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPartnerIndicatorsColumn(indicators) {
            return `
                <div class="col-lg-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h5 class="card-title mb-0 d-flex align-items-center gap-2">
                                <i class="bi bi-graph-up text-primary"></i>
                                <span>Indicadores gerais</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-sm-6">
                                    <div class="border rounded-3 p-3 h-100">
                                        <span class="text-muted text-uppercase small">Total de ve√≠culos</span>
                                        <h4 class="fw-bold mt-2 mb-0">${toDisplay(indicators.totalVehicles ?? 0, "0")}</h4>
                                        <p class="text-muted small mb-0">Ve√≠culos vinculados a todos os associados.</p>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="border rounded-3 p-3 h-100">
                                        <span class="text-muted text-uppercase small">Percentual ativo</span>
                                        <h4 class="fw-bold mt-2 mb-0">${toDisplay(indicators.activePercentage, '0%')}</h4>
                                        <p class="text-muted small mb-0">Participa√ß√£o de associados com ve√≠culos cadastrados.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPartnerTable(items) {
            const hasItems = Array.isArray(items) && items.length;
            const rows = hasItems
                ? items.map((item) => `
                        <tr>
                            <td>
                                <div class="fw-semibold">${toDisplay(item.name, 'N√£o informado')}</div>
                                <small class="text-muted">${toDisplay(item.addressSummary, 'N√£o informado')}</small>
                            </td>
                            <td>${toDisplay(item.cpf, 'N√£o informado')}</td>
                            <td>${toDisplay(item.email, 'N√£o informado')}</td>
                            <td>${toDisplay(item.city, '‚Äî')}</td>
                            <td>${toDisplay(item.vehicleCount ?? 0, '0')}</td>
                            <td><span class="badge bg-light text-dark">${toDisplay(item.status, 'N√£o informado')}</span></td>
                            <td>${toDisplay(item.registrationDate, '‚Äî')}</td>
                        </tr>
                    `).join('')
                : '';

            return `
                <div class="report-section report-results-table card border-0 shadow-sm">
                    <div class="card-header bg-transparent border-0 pb-0">
                        <h5 class="card-title mb-0 d-flex align-items-center gap-2">
                            <i class="bi bi-list-check text-primary"></i>
                            <span>Lista de associados</span>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        ${hasItems ? `
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead>
                                        <tr>
                                            <th>Associado</th>
                                            <th>CPF</th>
                                            <th>E-mail</th>
                                            <th>Cidade</th>
                                            <th>Ve√≠culos</th>
                                            <th>Status</th>
                                            <th>Cadastro</th>
                                        </tr>
                                    </thead>
                                    <tbody>${rows}</tbody>
                                </table>
                            </div>` : '<div class="p-4 text-muted">Nenhum associado encontrado para os filtros selecionados.</div>'}
                    </div>
                </div>
            `;
        }

        function initializeReportPages() {
            const reportPages = document.querySelectorAll('[data-report-page]');
            if (!reportPages.length) {
                return;
            }

            reportPages.forEach(function (page) {
                const type = page.getAttribute('data-report-page');
                setupReportPage({page, type});
            });
        }

        function setupReportPage(settings) {
            if (!settings || !settings.page || !settings.type) {
                return;
            }

            const {page, type} = settings;
            const overlay = page.querySelector('[data-report-overlay]');
            const overlayContent = overlay ? overlay.querySelector('[data-report-overlay-content]') : null;
            const resultsWrapper = page.querySelector('[data-report-results-wrapper]');
            const resultsContainer = page.querySelector('[data-report-results]');
            const resultsTitle = page.querySelector('[data-report-results-title]');
            const resultsSubtitle = page.querySelector('[data-report-results-subtitle]');
            const emptyState = page.querySelector('[data-report-empty]');
            const openButtons = page.querySelectorAll('[data-report-open]');
            const clearButton = page.querySelector('[data-report-clear]');
            const pageTitle = page.getAttribute('data-report-title');

            function showOverlay() {
                if (!overlay) {
                    return;
                }

                overlay.classList.add('is-visible');
                document.addEventListener('keydown', onKeyDown);

                if (!overlayContent) {
                    return;
                }

                overlayContent.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary mb-3" role="status" aria-label="Carregando filtros" style="width: 3rem; height: 3rem;"></div><p class="mb-2 fw-bold fs-5">Carregando filtros...</p><p class="text-muted small mb-0">Estamos preparando as op√ß√µes do relat√≥rio para voc√™.</p></div>';

                const templateId = 'report-filters-' + type;
                fetchReportFilters(templateId)
                    .then(function (html) {
                        overlayContent.innerHTML = html;
                        bindFilterForm();
                    })
                    .catch(function () {
                        overlayContent.innerHTML = '<div class="alert alert-danger mb-0 d-flex align-items-start gap-3"><i class="bi bi-exclamation-octagon-fill fs-3"></i><div><strong>N√£o foi poss√≠vel carregar os filtros</strong><p class="mb-2 mt-1">Verifique sua conex√£o e tente novamente.</p><button type="button" class="btn btn-sm btn-outline-danger" data-report-close>Fechar</button></div></div>';
                        const closeBtn = overlayContent.querySelector('[data-report-close]');
                        if (closeBtn) {
                            closeBtn.addEventListener('click', closeOverlay);
                        }
                    });
            }

            function onKeyDown(event) {
                if (event.key === 'Escape') {
                    closeOverlay();
                }
            }

            function fetchReportFilters(templateId) {
                return fetch('/reports/' + templateId + '.html', {headers: FETCH_HEADERS})
                    .then(function (response) {
                        if (!response.ok) {
                            throw new Error('Erro ao carregar filtros: ' + response.status);
                        }
                        return response.text();
                    });
            }

            function bindFilterForm() {
                if (!overlayContent) {
                    return;
                }
                const form = overlayContent.querySelector('[data-report-form]');
                if (!form) {
                    return;
                }
                const errorBox = overlayContent.querySelector('[data-report-error]');

                form.addEventListener('submit', function (event) {
                    event.preventDefault();
                    const selectedSections = form.querySelectorAll('input[name="sections"]:checked');
                    if (!selectedSections.length) {
                        if (errorBox) {
                            errorBox.innerHTML = '<i class="bi bi-exclamation-circle-fill me-2"></i>Selecione pelo menos uma se√ß√£o para gerar o relat√≥rio.';
                            errorBox.classList.remove('d-none');
                        }
                        return;
                    }
                    if (errorBox) {
                        errorBox.classList.add('d-none');
                    }

                    overlayContent.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary mb-3" role="status" aria-label="Gerando relat√≥rio" style="width: 3rem; height: 3rem;"></div><p class="mb-2 fw-bold fs-5">Gerando relat√≥rio...</p><p class="text-muted small mb-0">Por favor, aguarde enquanto processamos os dados.</p></div>';
                    const params = new URLSearchParams(new FormData(form));
                    fetchReportData(params);
                });
            }

            function fetchReportData(params) {
                const query = params.toString();
                const url = '/reports/' + type + '/data' + (query ? '?' + query : '');
                fetch(url, {headers: FETCH_HEADERS})
                    .then(function (response) {
                        if (!response.ok) {
                            throw new Error('Erro ao buscar dados do relat√≥rio: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(function (data) {
                        if (overlayContent) {
                            overlayContent.innerHTML = '<div class="text-center py-5"><div class="text-success mb-3" style="font-size: 4rem;"><i class="bi bi-check-circle-fill"></i></div><p class="mb-2 fw-bold fs-5 text-success">Relat√≥rio gerado com sucesso!</p><p class="text-muted small mb-0">Carregando visualiza√ß√£o...</p></div>';
                        }

                        setTimeout(function() {
                            renderResults(data);
                            closeOverlay();
                        }, 800);
                    })
                    .catch(function (error) {
                        console.error(error);
                        if (overlayContent) {
                            overlayContent.innerHTML = '<div class="alert alert-danger mb-0 d-flex align-items-start gap-3"><i class="bi bi-exclamation-triangle-fill fs-3"></i><div><strong>N√£o foi poss√≠vel gerar o relat√≥rio</strong><p class="mb-2 mt-1">Ocorreu um erro ao processar sua solicita√ß√£o. Por favor, tente novamente.</p><button type="button" class="btn btn-sm btn-outline-danger" data-report-close>Fechar</button></div></div>';

                            const closeBtn = overlayContent.querySelector('[data-report-close]');
                            if (closeBtn) {
                                closeBtn.addEventListener('click', closeOverlay);
                            }
                        }
                    });
            }

            function renderResults(data) {
                if (!resultsContainer || !resultsWrapper) {
                    return;
                }
                const executedAt = DATE_TIME_FORMATTER.format(new Date());
                const renderer = type === 'vehicles' ? renderVehicleResults : renderPartnerResults;
                const content = renderer(data);
                const finalTitle = pageTitle || (type === 'vehicles' ? 'Relat√≥rio de Ve√≠culos' : 'Relat√≥rio de Associados');

                if (resultsTitle) {
                    resultsTitle.textContent = finalTitle;
                }
                if (resultsSubtitle) {
                    resultsSubtitle.textContent = 'Consulta realizada em ' + executedAt + '.';
                }

                resultsContainer.innerHTML = content;
                resultsWrapper.classList.remove('d-none');
                if (emptyState) {
                    emptyState.classList.add('d-none');
                }
                resultsWrapper.scrollIntoView({behavior: 'smooth', block: 'start'});
            }

            function closeOverlay() {
                if (!overlay) return;

                const dialog = overlay.querySelector('.report-overlay-dialog');
                if (dialog) {
                    dialog.style.opacity = '0';
                    dialog.style.transform = 'scale(0.9) translateY(20px)';
                }

                setTimeout(function() {
                    overlay.classList.remove('is-visible');
                    if (dialog) {
                        dialog.style.opacity = '';
                        dialog.style.transform = '';
                    }
                }, 200);

                document.removeEventListener('keydown', onKeyDown);
            }

            function clearResults() {
                if (resultsContainer) {
                    resultsContainer.innerHTML = '';
                }
                if (resultsWrapper) {
                    resultsWrapper.classList.add('d-none');
                }
                if (emptyState) {
                    emptyState.classList.remove('d-none');
                }
                if (resultsSubtitle) {
                    resultsSubtitle.textContent = 'Consulta din√¢mica do relat√≥rio.';
                }
            }

            openButtons.forEach(function (button) {
                button.addEventListener('click', function (event) {
                    event.preventDefault();
                    const targetType = button.getAttribute('data-report-type') || type;
                    if (targetType === type) {
                        showOverlay();
                    }
                });
            });

            if (clearButton) {
                clearButton.addEventListener('click', function (event) {
                    event.preventDefault();
                    clearResults();
                });
            }

            if (overlay) {
                overlay.addEventListener('click', function (event) {
                    const closeTrigger = event.target.closest('[data-report-close]');
                    if (closeTrigger) {
                        event.preventDefault();
                        closeOverlay();
                        return;
                    }
                    if (event.target === overlay) {
                        closeOverlay();
                    }
                });
            }
        }

        initializeReportPages();
    })();
</script>
<script>
    (function () {
        const docElement = document.documentElement;
        const themeToggles = document.querySelectorAll('[data-theme-toggle]');
        const navToggle = document.getElementById('navToggle');
        const navLinks = document.querySelectorAll('.nav-links a');
        const navDropdownItems = document.querySelectorAll('.nav-item-dropdown');
        const navDropdownToggles = document.querySelectorAll('[data-nav-dropdown]');
        const backToTopButton = document.getElementById('backToTop');
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
        const disableDarkBlurRegion = document.querySelector('[data-no-dark-blur]');

        if (document.body) {
            if (disableDarkBlurRegion) {
                document.body.classList.add('no-dark-blur');
            } else {
                document.body.classList.remove('no-dark-blur');
            }
        }

        const storedTheme = localStorage.getItem('theme');
        if (storedTheme === 'dark' || (!storedTheme && prefersDarkScheme.matches)) {
            docElement.setAttribute('data-theme', 'dark');
        }

        function closeAllNavDropdowns(except) {
            navDropdownItems.forEach(function (item) {
                if (item !== except) {
                    item.classList.remove('is-open');
                    const toggle = item.querySelector('[data-nav-dropdown]');
                    if (toggle) {
                        toggle.setAttribute('aria-expanded', 'false');
                    }
                }
            });
        }

        navDropdownToggles.forEach(function (toggle) {
            const dropdownItem = toggle.closest('.nav-item-dropdown');
            if (!dropdownItem) {
                return;
            }

            toggle.addEventListener('click', function (event) {
                event.preventDefault();
                const isOpen = dropdownItem.classList.toggle('is-open');
                toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
                if (isOpen) {
                    closeAllNavDropdowns(dropdownItem);
                } else {
                    closeAllNavDropdowns();
                }
            });
        });

        document.addEventListener('click', function (event) {
            if (!event.target.closest('.nav-item-dropdown')) {
                closeAllNavDropdowns();
            }
        });

        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                closeAllNavDropdowns();
            }
        });

        function toggleTheme() {
            const isDark = docElement.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            docElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        themeToggles.forEach(function (button) {
            button.addEventListener('click', function () {
                toggleTheme();
            });
        });

        prefersDarkScheme.addEventListener('change', function (event) {
            const saved = localStorage.getItem('theme');
            if (!saved) {
                docElement.setAttribute('data-theme', event.matches ? 'dark' : 'light');
            }
        });

        navLinks.forEach(function (link) {
            link.addEventListener('click', function () {
                closeAllNavDropdowns();
                if (navToggle && navToggle.checked) {
                    navToggle.checked = false;
                }
            });
        });

        if (navToggle) {
            navToggle.addEventListener('change', function () {
                if (!navToggle.checked) {
                    closeAllNavDropdowns();
                }
            });
        }

        function handleBackToTopVisibility() {
            if (!backToTopButton) {
                return;
            }
            if (window.scrollY > 300) {
                backToTopButton.classList.add('is-visible');
            } else {
                backToTopButton.classList.remove('is-visible');
            }
        }

        if (backToTopButton) {
            backToTopButton.addEventListener('click', function () {
                window.scrollTo({top: 0, behavior: 'smooth'});
            });
        }

        window.addEventListener('scroll', handleBackToTopVisibility, {passive: true});
        handleBackToTopVisibility();
    })();
</script>

<!-- ========================================
     SCRIPT PARA DESTACAR P√ÅGINA ATIVA
     ======================================== -->
<script>
    (function () {
        'use strict';

        // Aguarda o DOM estar pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', highlightActiveNavItem);
        } else {
            highlightActiveNavItem();
        }

        function highlightActiveNavItem() {
            // Pega o caminho atual da URL
            const currentPath = window.location.pathname;

            // Seleciona todos os links da navbar (exceto bot√µes)
            const navLinks = document.querySelectorAll('.nav-links a:not(.btn)');
            const dropdownToggles = document.querySelectorAll('.nav-dropdown-toggle');
            const dropdownLinks = document.querySelectorAll('.nav-dropdown-link');

            // Remove qualquer classe 'active' existente
            navLinks.forEach(link => link.classList.remove('active'));
            dropdownToggles.forEach(toggle => toggle.classList.remove('active'));
            dropdownLinks.forEach(link => link.classList.remove('active'));

            // Marca o link correspondente como ativo
            navLinks.forEach(link => {
                const href = link.getAttribute('href');

                // Ignora links vazios ou apenas '#'
                if (!href || href === '#' || href === '/') {
                    return;
                }

                // Verifica se o caminho atual come√ßa com o href do link
                if (currentPath === href || currentPath.startsWith(href + '/')) {
                    link.classList.add('active');
                }
            });

            // Marca o dropdown "Relat√≥rios" como ativo se estiver em uma p√°gina de relat√≥rio
            if (currentPath.includes('/reports/')) {
                dropdownToggles.forEach(toggle => {
                    const parentLi = toggle.closest('li');
                    const dropdownMenu = parentLi?.querySelector('.nav-dropdown-menu');

                    if (dropdownMenu) {
                        const links = dropdownMenu.querySelectorAll('a');

                        links.forEach(link => {
                            const href = link.getAttribute('href');

                            if (href && (currentPath === href || currentPath.startsWith(href + '/'))) {
                                toggle.classList.add('active');
                                link.classList.add('active');
                            }
                        });
                    }
                });
            }

            console.log('‚úÖ P√°gina ativa destacada na navbar:', currentPath);
        }
    })();

</script>

<!-- ========================================
     CSS DO SISTEMA DE NOTIFICA√á√ïES
     ======================================== -->
<style>
    /* Bot√£o de sino */
    .notification-bell-wrapper {
        position: relative;
        display: inline-flex;
        align-items: stretch;
    }

    .theme-toggle,
    .notification-bell-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.45rem 0.9rem;
        border-radius: var(--radius-sm, 8px);
        border: 1px solid rgba(255, 255, 255, 0.35);
        background: rgba(255, 255, 255, 0.12);
        color: var(--color-topbar-text, #f5f3ff);
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, border 0.2s ease, background 0.2s ease;
    }

    .topbar-actions .theme-toggle,
    .topbar-actions .notification-bell-button {
        width: 2.75rem;
        height: 2.75rem;
        min-width: 2.75rem;
        min-height: 2.75rem;
        padding: 0;
        gap: 0;
    }

    .topbar-actions .theme-toggle .theme-toggle__icon,
    .topbar-actions .notification-bell-button .bi {
        font-size: 1.1rem;
    }

    .theme-toggle:hover,
    .theme-toggle:focus,
    .notification-bell-button:hover,
    .notification-bell-button:focus {
        transform: translateY(-1px);
        box-shadow: 0 12px 25px rgba(124, 58, 237, 0.3);
        border-color: rgba(255, 255, 255, 0.45);
        background: rgba(255, 255, 255, 0.16);
    }

    .theme-toggle:focus-visible,
    .notification-bell-button:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px var(--color-input-focus-ring, rgba(167, 139, 250, 0.35)), 0 12px 25px rgba(124, 58, 237, 0.3);
    }

    [data-theme="dark"] .theme-toggle,
    [data-theme="dark"] .notification-bell-button {
        border-color: rgba(168, 85, 247, 0.35);
        background: rgba(124, 58, 237, 0.18);
        color: #ede9fe;
    }

    [data-theme="dark"] .theme-toggle:hover,
    [data-theme="dark"] .theme-toggle:focus,
    [data-theme="dark"] .notification-bell-button:hover,
    [data-theme="dark"] .notification-bell-button:focus {
        border-color: rgba(196, 181, 253, 0.55);
        background: rgba(124, 58, 237, 0.26);
    }

    .notification-bell-button {
        position: relative;
    }

    .notification-bell-button .bi {
        font-size: 1.1rem;
        line-height: 1;
    }

    .notification-bell-button.has-notifications {
        animation: bellRing 0.5s ease-in-out;
    }

    .notification-bell-button.is-open {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.55);
    }

    [data-theme="dark"] .notification-bell-button.is-open {
        background: rgba(124, 58, 237, 0.32);
        border-color: rgba(196, 181, 253, 0.65);
    }

    @keyframes bellRing {
        0%, 100% { transform: rotate(0deg); }
        10%, 30%, 50%, 70%, 90% { transform: rotate(-10deg); }
        20%, 40%, 60%, 80% { transform: rotate(10deg); }
    }

    /* Badge de contador */
    .notification-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        background-color: #dc3545;
        color: #fff;
        border-radius: 10px;
        padding: 0.2rem 0.45rem;
        font-size: 0.7rem;
        font-weight: 700;
        min-width: 20px;
        text-align: center;
        line-height: 1;
        box-shadow: 0 0 0 2px rgba(76, 29, 149, 0.25);
    }

    /* Dropdown */
    .notification-dropdown {
        position: absolute;
        top: calc(100% + 12px);
        right: 0;
        width: 380px;
        max-width: 90vw;
        background: var(--color-surface-elevated, #ffffff);
        border-radius: 12px;
        border: 1px solid var(--color-border, rgba(139, 92, 246, 0.18));
        box-shadow: 0 18px 40px rgba(15, 8, 32, 0.22);
        z-index: 1050;
        overflow: hidden;
        animation: dropdownFadeIn 0.2s ease-out;
    }

    [data-theme="dark"] .notification-dropdown {
        background: var(--color-surface-alt, #2d2d2d);
        border-color: var(--color-border, rgba(168, 85, 247, 0.35));
        box-shadow: 0 22px 48px rgba(10, 6, 20, 0.55);
    }

    @keyframes dropdownFadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .notification-dropdown-header {
        padding: 1rem;
        border-bottom: 1px solid rgba(139, 92, 246, 0.16);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    [data-theme="dark"] .notification-dropdown-header {
        border-bottom-color: rgba(168, 85, 247, 0.35);
    }

    .notification-dropdown-header h6 {
        font-weight: 600;
        color: var(--color-text-primary, #1f1147);
    }

    .notification-dropdown-body {
        max-height: 400px;
        overflow-y: auto;
    }

    .notification-dropdown-body::-webkit-scrollbar {
        width: 6px;
    }

    .notification-dropdown-body::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
    }

    .notification-item {
        padding: 0.875rem 1rem;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: flex;
        gap: 0.75rem;
        text-decoration: none;
        color: inherit;
    }

    [data-theme="dark"] .notification-item {
        border-bottom-color: #3a3a3a;
    }

    .notification-item:hover {
        background-color: #f8f9fa;
    }

    [data-theme="dark"] .notification-item:hover {
        background-color: #3a3a3a;
    }

    .notification-item.unread {
        background-color: #e7f3ff;
    }

    [data-theme="dark"] .notification-item.unread {
        background-color: #1a3a52;
    }

    .notification-item-icon {
        flex-shrink: 0;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 1rem;
    }

    .notification-item-content {
        flex: 1;
        min-width: 0;
    }

    .notification-item-title {
        font-weight: 600;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
        color: var(--text-color, #333);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .notification-item-message {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .notification-item-time {
        font-size: 0.75rem;
        color: #6c757d;
    }

    .notification-dropdown-footer {
        padding: 0.75rem 1rem;
        border-top: 1px solid #e9ecef;
        text-align: center;
    }

    [data-theme="dark"] .notification-dropdown-footer {
        border-top-color: #444;
    }

    .notification-empty {
        text-align: center;
        padding: 2rem 1rem;
        color: #6c757d;
    }

    .notification-empty i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    /* √çcones por tipo de notifica√ß√£o */
    .notification-icon-EVENT { background-color: #0d6efd; color: white; }
    .notification-icon-DEMAND { background-color: #ffc107; color: black; }
    .notification-icon-PAYMENT { background-color: #198754; color: white; }
    .notification-icon-BANK_SLIP { background-color: #0dcaf0; color: black; }
    .notification-icon-ALERT { background-color: #dc3545; color: white; }
    .notification-icon-SYSTEM { background-color: #6c757d; color: white; }
    .notification-icon-COMUNICADO { background-color: #6f42c1; color: white; }
    .notification-icon-INFO { background-color: #0dcaf0; color: black; }

    /* Responsivo */
    @media (max-width: 768px) {
        .notification-dropdown {
            width: 320px;
            right: -60px;
        }
    }
</style>

<!-- ========================================
     JAVASCRIPT DO SISTEMA DE NOTIFICA√á√ïES
     ======================================== -->
<script>
    (function () {
        'use strict';

        const bellBtn = document.getElementById('notificationBellBtn');
        const dropdown = document.getElementById('notificationDropdown');
        const badge = document.getElementById('notificationBadge');
        const mobileBadge = document.getElementById('mobileNotificationBadge');
        const notificationList = document.getElementById('notificationList');
        const markAllReadBtn = document.getElementById('markAllReadBtn');

        if (!bellBtn || !dropdown) {
            return; // Usu√°rio n√£o est√° logado
        }

        bellBtn.setAttribute('aria-expanded', 'false');

        let isDropdownOpen = false;
        let unreadCount = 0;

        // Buscar contador de notifica√ß√µes ao carregar a p√°gina
        fetchUnreadCount();

        // Atualizar contador a cada 30 segundos
        setInterval(fetchUnreadCount, 30000);

        // Toggle dropdown
        bellBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (isDropdownOpen) {
                closeDropdown();
            } else {
                openDropdown();
            }
        });

        // Fechar dropdown ao clicar fora
        document.addEventListener('click', function(e) {
            if (isDropdownOpen && !dropdown.contains(e.target) && !bellBtn.contains(e.target)) {
                closeDropdown();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (isDropdownOpen && e.key === 'Escape') {
                closeDropdown();
                bellBtn.focus();
            }
        });

        // Marcar todas como lidas
        if (markAllReadBtn) {
            markAllReadBtn.addEventListener('click', function() {
                markAllAsRead();
            });
        }

        function openDropdown() {
            dropdown.style.display = 'block';
            isDropdownOpen = true;
            bellBtn.classList.add('is-open');
            bellBtn.setAttribute('aria-expanded', 'true');
            loadNotifications();
        }

        function closeDropdown() {
            dropdown.style.display = 'none';
            isDropdownOpen = false;
            bellBtn.classList.remove('is-open');
            bellBtn.setAttribute('aria-expanded', 'false');
        }

        function fetchUnreadCount() {
            fetch('/notifications/api/unread-count', {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                unreadCount = data.unreadCount || 0;
                updateBadge();
            })
            .catch(error => {
                console.error('Erro ao buscar contador de notifica√ß√µes:', error);
            });
        }

        function updateBadge() {
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.style.display = 'block';
                if (mobileBadge) {
                    mobileBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    mobileBadge.style.display = 'inline-block';
                }
                bellBtn.classList.add('has-notifications');
            } else {
                badge.style.display = 'none';
                if (mobileBadge) {
                    mobileBadge.style.display = 'none';
                }
                bellBtn.classList.remove('has-notifications');
            }
        }

        function loadNotifications() {
            notificationList.innerHTML = '<div class="text-center py-4 text-muted"><div class="spinner-border spinner-border-sm mb-2" role="status"><span class="visually-hidden">Carregando...</span></div><p class="small mb-0">Carregando notifica√ß√µes...</p></div>';

            fetch('/notifications/api/recent/10', {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                renderNotifications(data);
            })
            .catch(error => {
                console.error('Erro ao carregar notifica√ß√µes:', error);
                notificationList.innerHTML = '<div class="notification-empty"><i class="bi bi-exclamation-circle"></i><p class="mb-0">Erro ao carregar notifica√ß√µes</p></div>';
            });
        }

        function renderNotifications(notifications) {
            if (!notifications || notifications.length === 0) {
                notificationList.innerHTML = '<div class="notification-empty"><i class="bi bi-bell-slash"></i><p class="mb-0">Nenhuma notifica√ß√£o</p></div>';
                markAllReadBtn.style.display = 'none';
                return;
            }

            const hasUnread = notifications.some(n => n.status === 'UNREAD');
            markAllReadBtn.style.display = hasUnread ? 'block' : 'none';

            const html = notifications.map(notification => {
                const isUnread = notification.status === 'UNREAD';
                const icon = getNotificationIcon(notification.type);
                const timeAgo = formatTimeAgo(notification.createdAt);
                const url = notification.actionUrl || '/notifications/' + notification.id;

                return `
                    <a href="${escapeHtml(url)}" class="notification-item ${isUnread ? 'unread' : ''}" data-notification-id="${notification.id}">
                        <div class="notification-item-icon notification-icon-${notification.type}">
                            <i class="${icon}"></i>
                        </div>
                        <div class="notification-item-content">
                            <div class="notification-item-title">${escapeHtml(notification.title)}</div>
                            <div class="notification-item-message">${escapeHtml(notification.message)}</div>
                            <div class="notification-item-time">${timeAgo}</div>
                        </div>
                    </a>
                `;
            }).join('');

            notificationList.innerHTML = html;

            // Adicionar event listeners para marcar como lida ao clicar
            notificationList.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    const notificationId = this.getAttribute('data-notification-id');
                    if (this.classList.contains('unread')) {
                        markAsRead(notificationId);
                    }
                });
            });
        }

        function markAsRead(notificationId) {
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

            const headers = {
                'X-Requested-With': 'XMLHttpRequest'
            };
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }

            fetch('/notifications/api/' + notificationId + '/mark-read', {
                method: 'POST',
                headers: headers
            })
            .then(() => {
                fetchUnreadCount();
            })
            .catch(error => {
                console.error('Erro ao marcar notifica√ß√£o como lida:', error);
            });
        }

        function markAllAsRead() {
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

            const headers = {
                'X-Requested-With': 'XMLHttpRequest'
            };
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }

            fetch('/notifications/api/mark-all-read', {
                method: 'POST',
                headers: headers
            })
            .then(() => {
                fetchUnreadCount();
                loadNotifications();
            })
            .catch(error => {
                console.error('Erro ao marcar todas como lidas:', error);
            });
        }

        function getNotificationIcon(type) {
            const icons = {
                'EVENT': 'bi bi-calendar-event',
                'DEMAND': 'bi bi-list-task',
                'PAYMENT': 'bi bi-credit-card',
                'BANK_SLIP': 'bi bi-file-earmark-text',
                'ALERT': 'bi bi-exclamation-triangle',
                'SYSTEM': 'bi bi-gear',
                'COMUNICADO': 'bi bi-megaphone',
                'PARTNER': 'bi bi-person',
                'VEHICLE': 'bi bi-car-front',
                'INFO': 'bi bi-info-circle'
            };
            return icons[type] || 'bi bi-bell';
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Agora';
            if (diffMins < 60) return diffMins + ' min atr√°s';
            if (diffHours < 24) return diffHours + 'h atr√°s';
            if (diffDays < 7) return diffDays + 'd atr√°s';

            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    })();
</script>

        <th:block layout:fragment="scripts"></th:block>
</body>
</html>