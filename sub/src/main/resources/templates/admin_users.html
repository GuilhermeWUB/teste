<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>SUB - Usuários</title>
    <link rel="stylesheet" th:href="@{/css/admin.css}">
</head>
<body>
<section layout:fragment="content" class="admin-users">
    <div class="admin-users__background" aria-hidden="true"></div>

    <div class="admin-users__container">
        <header class="admin-users__header" aria-labelledby="adminUsersHeading">
            <div class="admin-users__heading">
                <span class="admin-users__eyebrow">Gestão de acesso</span>
                <h1 id="adminUsersHeading" class="admin-users__title">Central de usuários</h1>
                <p class="admin-users__subtitle">
                    Visualize os perfis cadastrados, ajuste permissões em poucos cliques e acompanhe indicadores do time.
                </p>
            </div>
            <button type="button" class="admin-users__primary-btn" data-bs-toggle="modal" data-bs-target="#createUserModal">
                <i class="bi bi-person-plus" aria-hidden="true"></i>
                <span>Adicionar usuário</span>
            </button>
        </header>

        <div class="admin-users__cards">
            <article class="admin-users__summary-card" aria-live="polite">
                <div class="admin-users__summary-icon" aria-hidden="true">
                    <i class="bi bi-people-fill"></i>
                </div>
                <div>
                    <span class="admin-users__summary-label">Total cadastrados</span>
                    <strong class="admin-users__summary-value" th:text="${users != null ? users.size() : 0}">0</strong>
                </div>
            </article>
            <article class="admin-users__summary-card admin-users__summary-card--highlight">
                <div class="admin-users__summary-icon" aria-hidden="true">
                    <i class="bi bi-shield-lock"></i>
                </div>
                <div>
                    <span class="admin-users__summary-label">Perfis disponíveis</span>
                    <strong class="admin-users__summary-value" th:text="${availableRoles != null ? availableRoles.size() : 0}">0</strong>
                </div>
            </article>
            <article class="admin-users__summary-card admin-users__summary-card--soft">
                <div class="admin-users__summary-icon" aria-hidden="true">
                    <i class="bi bi-clock-history"></i>
                </div>
                <div>
                    <span class="admin-users__summary-label">Última atualização</span>
                    <strong class="admin-users__summary-value">
                        <time th:text="${#temporals.format(#temporals.createNow(), 'dd/MM/yyyy')}"
                              th:attr="datetime=${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}" >Hoje</time>
                    </strong>
                </div>
            </article>
        </div>

        <div class="admin-users__panel" role="region" aria-label="Lista de usuários">
            <div class="admin-users__toolbar">
                <div class="admin-users__search">
                    <label class="visually-hidden" for="usersSearch">Buscar usuário</label>
                    <i class="bi bi-search" aria-hidden="true"></i>
                    <input id="usersSearch" type="search" placeholder="Busque por nome, usuário ou e-mail" autocomplete="off">
                </div>
                <div class="admin-users__toolbar-actions">
                    <div class="admin-users__filter">
                        <label class="visually-hidden" for="roleFilter">Filtrar por permissão</label>
                        <select id="roleFilter">
                            <option value="">Todas as permissões</option>
                            <option th:each="role : ${availableRoles}"
                                    th:value="${role.code}"
                                    th:text="${role.displayName}">Permissão</option>
                        </select>
                        <i class="bi bi-sliders" aria-hidden="true"></i>
                    </div>
                    <button type="button" class="admin-users__secondary-btn" id="clearFilters" aria-label="Limpar filtros">
                        <i class="bi bi-arrow-counterclockwise" aria-hidden="true"></i>
                        <span>Limpar</span>
                    </button>
                </div>
            </div>

            <div th:if="${successMessage}" class="admin-users__alert admin-users__alert--success" role="status">
                <i class="bi bi-check-circle-fill" aria-hidden="true"></i>
                <span th:text="${successMessage}"></span>
            </div>

            <div th:if="${errorMessage}" class="admin-users__alert admin-users__alert--error" role="alert">
                <i class="bi bi-exclamation-triangle-fill" aria-hidden="true"></i>
                <span th:text="${errorMessage}"></span>
            </div>

            <div class="admin-users__table-wrapper" th:classappend="${users == null or users.isEmpty()} ? ' admin-users__table-wrapper--empty'">
                <div class="table-responsive" th:if="${users != null and !users.isEmpty()}">
                    <table class="table admin-users-table align-middle">
                        <thead>
                        <tr>
                            <th scope="col">Usuário</th>
                            <th scope="col">E-mail</th>
                            <th scope="col">Permissão</th>
                            <th scope="col" class="text-center">Ações</th>
                        </tr>
                        </thead>
                        <tbody id="usersTableBody">
                        <tr th:each="user : ${users}"
                            th:data-role="${user.role}" class="admin-users__row">
                            <td>
                                <div class="admin-users__person">
                                    <div class="admin-users__avatar" aria-hidden="true">
                                        <span th:text="${user.fullName != null and #strings.length(user.fullName) > 0 ? #strings.substring(user.fullName, 0, 1) : 'U'}">U</span>
                                    </div>
                                    <div class="admin-users__person-info">
                                        <strong class="admin-users__person-name" th:text="${user.fullName != null ? user.fullName : 'Sem nome'}">Nome do Usuário</strong>
                                        <span class="admin-users__person-username">@<span th:text="${user.username}">username</span></span>
                                    </div>
                                </div>
                            </td>
                            <td class="admin-users__email" th:text="${user.email}">email@example.com</td>
                            <td>
                                <span class="admin-users__role-badge" th:text="${user.role}">ROLE</span>
                            </td>
                            <td>
                                <form th:action="@{/admin/users/{id}/role(id=${user.id})}" method="post" class="admin-users__actions">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                    <label class="visually-hidden" th:for="${'role-' + user.id}">Atualizar permissão</label>
                                    <select class="admin-users__role-select" th:id="${'role-' + user.id}" name="role">
                                        <option th:each="role : ${availableRoles}"
                                                th:value="${role.code}"
                                                th:selected="${role.code == user.role}"
                                                th:text="${role.displayName}">Role</option>
                                    </select>
                                    <button type="submit" class="admin-users__action-btn" title="Atualizar permissão">
                                        <i class="bi bi-arrow-repeat" aria-hidden="true"></i>
                                        <span class="visually-hidden">Atualizar</span>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div class="admin-users__empty" th:if="${users == null or users.isEmpty()}">
                    <div class="admin-users__empty-icon" aria-hidden="true">
                        <i class="bi bi-emoji-neutral"></i>
                    </div>
                    <p class="admin-users__empty-title">Nenhum usuário cadastrado ainda</p>
                    <p class="admin-users__empty-text">Cadastre novos usuários ou ajuste os filtros para visualizar resultados.</p>
                    <button type="button" class="admin-users__primary-btn" data-bs-toggle="modal" data-bs-target="#createUserModal">
                        <i class="bi bi-person-plus" aria-hidden="true"></i>
                        <span>Criar primeiro usuário</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content admin-users__modal">
                <div class="admin-users__modal-header">
                    <div>
                        <p class="admin-users__modal-eyebrow">Cadastro rápido</p>
                        <h5 class="modal-title" id="createUserModalLabel">Adicionar novo usuário</h5>
                        <p class="admin-users__modal-subtitle">Complete os campos para liberar o acesso ao sistema.</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <form th:action="@{/admin/users/create}" method="post" class="admin-users__modal-form">
                    <div class="admin-users__modal-body">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                        <div class="admin-users__modal-grid">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="fullName" name="fullName" placeholder=" " required>
                                <label for="fullName"><i class="bi bi-person"></i> Nome completo</label>
                            </div>

                            <div class="form-floating">
                                <input type="text" class="form-control" id="username" name="username" placeholder=" " required
                                       pattern="[a-zA-Z0-9_]+" title="Apenas letras, números e underscore">
                                <label for="username"><i class="bi bi-at"></i> Nome de usuário</label>
                            </div>

                            <div class="form-floating">
                                <input type="email" class="form-control" id="email" name="email" placeholder=" " required>
                                <label for="email"><i class="bi bi-envelope"></i> E-mail</label>
                            </div>

                            <div class="form-floating admin-users__password-field">
                                <input type="password" class="form-control" id="password" name="password" placeholder=" " required minlength="6">
                                <label for="password"><i class="bi bi-key"></i> Senha</label>
                                <button type="button" class="password-toggle" onclick="togglePassword()" aria-label="Mostrar ou ocultar senha">
                                    <i class="bi bi-eye" id="toggleIcon" aria-hidden="true"></i>
                                </button>
                                <small>Mínimo de 6 caracteres</small>
                            </div>

                            <div class="form-floating">
                                <select class="form-select" id="role" name="role" required>
                                    <option value="">Selecione uma permissão</option>
                                    <option th:each="role : ${availableRoles}"
                                            th:value="${role.code}"
                                            th:text="${role.displayName}">Role</option>
                                </select>
                                <label for="role"><i class="bi bi-shield-check"></i> Permissão</label>
                            </div>
                        </div>
                    </div>
                    <div class="admin-users__modal-footer">
                        <button type="button" class="admin-users__secondary-btn" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="admin-users__primary-btn">
                            <i class="bi bi-check-lg" aria-hidden="true"></i>
                            <span>Criar usuário</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('toggleIcon');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.replace('bi-eye', 'bi-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.replace('bi-eye-slash', 'bi-eye');
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const alerts = document.querySelectorAll('.admin-users__alert');
            const searchInput = document.getElementById('usersSearch');
            const roleFilter = document.getElementById('roleFilter');
            const clearFilters = document.getElementById('clearFilters');
            const tableWrapper = document.querySelector('.admin-users__table-wrapper');
            const rows = Array.from(document.querySelectorAll('#usersTableBody .admin-users__row'));

            alerts.forEach(function (alert) {
                setTimeout(function () {
                    alert.classList.add('admin-users__alert--hidden');
                    setTimeout(function () {
                        alert.remove();
                    }, 400);
                }, 5000);
            });

            function normalise(text) {
                return text
                    .toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '');
            }

            function applyFilters() {
                const searchTerm = normalise(searchInput.value || '');
                const role = roleFilter.value;
                let visibleCount = 0;

                rows.forEach(function (row) {
                    const roleMatch = !role || row.dataset.role === role;
                    const searchableText = normalise(row.textContent);
                    const searchMatch = !searchTerm || searchableText.includes(searchTerm);
                    const isVisible = roleMatch && searchMatch;

                    row.style.display = isVisible ? '' : 'none';
                    if (isVisible) {
                        visibleCount += 1;
                    }
                });

                if (tableWrapper) {
                    tableWrapper.classList.toggle('admin-users__table-wrapper--has-results', visibleCount > 0);
                }
            }

            if (searchInput && roleFilter) {
                searchInput.addEventListener('input', applyFilters);
                roleFilter.addEventListener('change', applyFilters);
            }

            if (clearFilters) {
                clearFilters.addEventListener('click', function () {
                    if (searchInput) {
                        searchInput.value = '';
                        searchInput.focus();
                    }
                    if (roleFilter) {
                        roleFilter.value = '';
                    }
                    applyFilters();
                });
            }

            applyFilters();
        });
    </script>
</section>
</body>
</html>
