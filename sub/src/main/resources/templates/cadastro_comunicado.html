<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>SUB - Criar Comunicado</title>
    <link rel="stylesheet" th:href="@{/css/cadastro.css}">
    <link rel="stylesheet" th:href="@{/css/cadastro-evento.css}">
</head>
<body>

<section layout:fragment="content">
    <div class="event-form py-4">
        <!-- Botão para acessar Vistorias de Acidentes -->
        <div class="mb-4">
            <a th:href="@{/vistorias}" class="btn btn-warning btn-lg">
                <i class="bi bi-camera-fill me-2"></i>Vistorias de Acidentes
            </a>
            <p class="text-muted small mt-2 mb-0">
                <i class="bi bi-info-circle me-1"></i>
                Se você possui comunicados aguardando vistoria, clique aqui para enviar as fotos do acidente.
            </p>
        </div>

        <!-- Lista de Comunicados Criados -->
        <div class="card shadow mb-4" th:if="${myEvents != null and !myEvents.isEmpty()}">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-list-check"></i> Meus Comunicados</h4>
                <p class="text-muted small mb-0 mt-2">Acompanhe o status dos seus comunicados</p>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Título</th>
                                <th>Status</th>
                                <th>Motivo</th>
                                <th>Data Comunicação</th>
                                <th>Placa</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="ev : ${myEvents}">
                                <td><span class="badge bg-secondary" th:text="${ev.id}">1</span></td>
                                <td>
                                    <strong th:text="${ev.titulo}">Título do evento</strong>
                                    <br>
                                    <small class="text-muted" th:text="${#strings.abbreviate(ev.descricao, 60)}">Descrição...</small>
                                </td>
                                <td>
                                    <span class="badge"
                                          th:classappend="${ev.status.getPhase() == 1 ? 'bg-info' :
                                                          ev.status.getPhase() == 2 ? 'bg-warning text-dark' :
                                                          ev.status.getPhase() == 3 ? 'bg-primary' :
                                                          ev.status.getPhase() == 4 ? 'bg-success' :
                                                          ev.status.getPhase() == 5 ? 'bg-danger' : 'bg-secondary'}"
                                          th:text="${ev.status.displayName}">Status</span>
                                </td>
                                <td th:text="${ev.motivo}">Motivo</td>
                                <td th:text="${ev.dataComunicacao != null ? #temporals.format(ev.dataComunicacao, 'dd/MM/yyyy') : '-'}">01/01/2025</td>
                                <td>
                                    <span th:if="${ev.placaManual != null and !#strings.isEmpty(ev.placaManual)}"
                                          th:text="${ev.placaManual}">ABC-1234</span>
                                    <span th:if="${ev.placaManual == null or #strings.isEmpty(ev.placaManual)}"
                                          class="text-muted">-</span>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-primary btn-edit-description"
                                                th:data-event-id="${ev.id}"
                                                th:data-description="${ev.descricao}"
                                                title="Editar Descrição">
                                            <i class="bi bi-pencil"></i> Descrição
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary btn-edit-observations"
                                                th:data-event-id="${ev.id}"
                                                th:data-observations="${ev.observacoes}"
                                                title="Editar Observações">
                                            <i class="bi bi-chat-left-text"></i> Observações
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Mensagem quando não há comunicados -->
        <div class="alert alert-info mb-4" th:if="${myEvents == null or myEvents.isEmpty()}">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Você ainda não criou nenhum comunicado.</strong>
            Preencha o formulário abaixo para criar seu primeiro comunicado.
        </div>

        <!-- Formulário de Criação -->
        <div class="card shadow event-form__card">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-megaphone"></i> Criar Novo Comunicado</h4>
                <p class="text-muted small mb-0 mt-2">Registre aqui comunicações sobre eventos relacionados ao seu veículo</p>
            </div>
            <div class="card-body">
                <div class="alert alert-success" th:if="${successMessage}" th:text="${successMessage}"></div>
                <div class="alert alert-danger" th:if="${formError}" th:text="${formError}"></div>

                <form th:action="@{/me/comunicado}" th:object="${event}" method="post" class="event-form__body" id="comunicadoForm" enctype="multipart/form-data">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <input type="hidden" th:field="*{partner.id}" />

                    <!-- Campos ocultos para Data da Comunicação (preenchidos automaticamente) -->
                    <input type="hidden" id="dataComunicacao" name="dataComunicacao" />
                    <input type="hidden" id="horaComunicacao" name="horaComunicacao" />

                    <!-- Informações do Associado (Read-only) -->
                    <div class="section-title">
                        <h5><i class="bi bi-person-circle"></i> Seus Dados</h5>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Associado:</strong> <span th:text="${partner?.name}">Nome do Associado</span>
                        <span class="mx-2">|</span>
                        <strong>CPF:</strong> <span th:text="${partner?.cpf}">000.000.000-00</span>
                    </div>

                    <!-- Informações Básicas -->
                    <div class="section-title">
                        <h5><i class="bi bi-info-circle"></i> Informações do Comunicado</h5>
                    </div>

                    <!-- Campo Status oculto com valor padrão COMUNICADO -->
                    <input type="hidden" th:field="*{status}" th:value="COMUNICADO" />

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="titulo" class="form-label">Título *</label>
                            <input type="text" class="form-control" id="titulo" th:field="*{titulo}"
                                   placeholder="Ex: Colisão no estacionamento, Roubo de veículo, etc." maxlength="200" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('titulo')}" th:errors="*{titulo}"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="descricao" class="form-label">Descrição *</label>
                            <textarea class="form-control" id="descricao" th:field="*{descricao}"
                                      rows="5" placeholder="Descreva detalhadamente o que aconteceu..." required></textarea>
                            <small class="form-text text-muted">Descreva o ocorrido com o máximo de detalhes possível</small>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('descricao')}" th:errors="*{descricao}"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="motivo" class="form-label">Motivo *</label>
                            <select class="form-select" id="motivo" th:field="*{motivo}" required>
                                <option value="">Selecione...</option>
                                <option th:each="motivo : ${motivoOptions}"
                                        th:value="${motivo}"
                                        th:text="${motivo}">Motivo</option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('motivo')}" th:errors="*{motivo}"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="envolvimento" class="form-label">Envolvimento *</label>
                            <select class="form-select" id="envolvimento" th:field="*{envolvimento}" required>
                                <option value="">Selecione...</option>
                                <option th:each="envolvimento : ${envolvimentoOptions}"
                                        th:value="${envolvimento}"
                                        th:text="${envolvimento}">Envolvimento</option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('envolvimento')}" th:errors="*{envolvimento}"></div>
                        </div>
                    </div>

                    <!-- Informações do Veículo -->
                    <div class="section-title">
                        <h5><i class="bi bi-car-front"></i> Veículo Envolvido</h5>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="placaManual" class="form-label">Selecione o Veículo</label>
                            <select class="form-select" id="placaManual" th:field="*{placaManual}">
                                <option value="">Selecione um veículo...</option>
                                <option th:each="vehicle : ${myVehicles}"
                                        th:value="${vehicle.plaque}"
                                        th:text="${vehicle.plaque + ' - ' + vehicle.maker + ' ' + vehicle.model + ' (' + vehicle.year_mod + ')'}">
                                    ABC-1234 - Honda Civic (2020)
                                </option>
                            </select>
                            <small class="form-text text-muted">
                                <span th:if="${myVehicles != null and !myVehicles.isEmpty()}">
                                    Selecione um dos seus veículos cadastrados
                                </span>
                                <span th:if="${myVehicles == null or myVehicles.isEmpty()}" class="text-warning">
                                    <i class="bi bi-exclamation-triangle"></i> Você não possui veículos cadastrados. Deixe em branco se não aplicável.
                                </span>
                            </small>
                        </div>
                    </div>

                    <!-- Datas -->
                    <div class="section-title">
                        <h5><i class="bi bi-calendar"></i> Datas e Horários</h5>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="dataAconteceu" class="form-label">Data do Ocorrido</label>
                            <input type="date" class="form-control" id="dataAconteceu" th:field="*{dataAconteceu}">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('dataAconteceu')}" th:errors="*{dataAconteceu}"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="horaAconteceu" class="form-label">Hora do Ocorrido (HHMM)</label>
                            <input type="number" class="form-control" id="horaAconteceu" th:field="*{horaAconteceu}"
                                   min="0" max="2359" step="1" placeholder="Ex: 0900, 1430">
                            <small class="text-muted">Formato: 0900 para 9h, 1430 para 14h30</small>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('horaAconteceu')}" th:errors="*{horaAconteceu}"></div>
                        </div>
                    </div>

                    <!-- Documentos -->
                    <div class="section-title">
                        <h5><i class="bi bi-paperclip"></i> Documentos</h5>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Anexe os documentos relacionados ao ocorrido (opcional). Formatos aceitos: PDF, JPG, JPEG, PNG
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="docCrlv" class="form-label">
                                <i class="bi bi-file-earmark-text"></i> CRLV (Certificado de Registro e Licenciamento de Veículo)
                            </label>
                            <input type="file" class="form-control" id="docCrlv" name="docCrlv" accept=".pdf,.jpg,.jpeg,.png">
                            <small class="form-text text-muted">Documento do veículo</small>
                        </div>
                        <div class="col-md-6">
                            <label for="docCnh" class="form-label">
                                <i class="bi bi-file-earmark-text"></i> CNH (Carteira Nacional de Habilitação)
                            </label>
                            <input type="file" class="form-control" id="docCnh" name="docCnh" accept=".pdf,.jpg,.jpeg,.png">
                            <small class="form-text text-muted">Carteira de habilitação do condutor</small>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="docBo" class="form-label">
                                <i class="bi bi-file-earmark-text"></i> B.O. (Boletim de Ocorrência)
                            </label>
                            <input type="file" class="form-control" id="docBo" name="docBo" accept=".pdf,.jpg,.jpeg,.png">
                            <small class="form-text text-muted">Boletim de ocorrência policial</small>
                        </div>
                        <div class="col-md-6">
                            <label for="docComprovanteResidencia" class="form-label">
                                <i class="bi bi-file-earmark-text"></i> Comprovante de Residência
                            </label>
                            <input type="file" class="form-control" id="docComprovanteResidencia" name="docComprovanteResidencia" accept=".pdf,.jpg,.jpeg,.png">
                            <small class="form-text text-muted">Comprovante de endereço atual</small>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="docTermoAbertura" class="form-label">
                                <i class="bi bi-file-earmark-text"></i> Termo de Abertura
                            </label>
                            <input type="file" class="form-control" id="docTermoAbertura" name="docTermoAbertura" accept=".pdf,.jpg,.jpeg,.png">
                            <small class="form-text text-muted">Termo de abertura assinado</small>
                        </div>
                    </div>

                    <!-- Observações -->
                    <div class="section-title">
                        <h5><i class="bi bi-card-text"></i> Informações Adicionais</h5>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="observacoes" class="form-label">Observações</label>
                            <textarea class="form-control" id="observacoes" th:field="*{observacoes}"
                                      rows="3" placeholder="Observações adicionais sobre o comunicado..."></textarea>
                        </div>
                    </div>

                    <!-- Botões -->
                    <div class="form-actions">
                        <a th:href="@{/me/vehicles}" class="btn btn-light btn-action">
                            <i class="bi bi-arrow-left"></i>
                            <span>Voltar para meus veículos</span>
                        </a>
                        <div class="form-actions__buttons">
                            <button type="reset" class="btn btn-outline-primary btn-action">
                                <i class="bi bi-arrow-counterclockwise"></i>
                                <span>Limpar campos</span>
                            </button>
                            <button type="submit" class="btn btn-primary btn-action btn-action--primary">
                                <i class="bi bi-send"></i>
                                <span>Enviar Comunicado</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal de Edição de Descrição -->
        <div class="modal fade" id="editDescriptionModal" tabindex="-1" aria-labelledby="editDescriptionModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editDescriptionModalLabel">
                            <i class="bi bi-pencil-square"></i> Editar Descrição do Comunicado
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="editDescriptionForm" method="post" th:action="@{/me/comunicado/update-description}">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" id="editEventId" name="eventId" />
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="editDescricao" class="form-label">Descrição *</label>
                                <textarea class="form-control" id="editDescricao" name="descricao" rows="8" required></textarea>
                                <small class="form-text text-muted">Atualize a descrição do seu comunicado</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal de Edição de Observações -->
        <div class="modal fade" id="editObservationsModal" tabindex="-1" aria-labelledby="editObservationsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editObservationsModalLabel">
                            <i class="bi bi-chat-left-text-fill"></i> Editar Observações do Comunicado
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="editObservationsForm" method="post" th:action="@{/me/comunicado/update-observations}">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" id="editObsEventId" name="eventId" />
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="editObservacoes" class="form-label">Observações</label>
                                <textarea class="form-control" id="editObservacoes" name="observacoes" rows="8"
                                          placeholder="Digite suas observações sobre o comunicado..."></textarea>
                                <small class="form-text text-muted">
                                    <i class="bi bi-info-circle"></i> As alterações neste campo serão registradas no histórico
                                </small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<script layout:fragment="scripts">
    document.addEventListener('DOMContentLoaded', function () {
        'use strict';
        console.log('[COMUNICADO FORM] Formulário de comunicado carregado');

        // Define status padrão como COMUNICADO
        const statusSelect = document.getElementById('status');
        if (statusSelect && !statusSelect.value) {
            statusSelect.value = 'COMUNICADO';
        }

        // Auto-preenche Data da Comunicação e Hora da Comunicação ao submeter o formulário
        const comunicadoForm = document.getElementById('comunicadoForm');
        if (comunicadoForm) {
            comunicadoForm.addEventListener('submit', function(event) {
                // Obtém a data e hora atual
                const agora = new Date();

                // Formata a data no padrão ISO (yyyy-MM-dd) para o campo de data
                const ano = agora.getFullYear();
                const mes = String(agora.getMonth() + 1).padStart(2, '0');
                const dia = String(agora.getDate()).padStart(2, '0');
                const dataFormatada = ano + '-' + mes + '-' + dia;

                // Obtém a hora no formato HHmm (ex: 1430 para 14:30)
                const horas = String(agora.getHours()).padStart(2, '0');
                const minutos = String(agora.getMinutes()).padStart(2, '0');
                const horaFormatada = parseInt(horas + minutos);

                // Preenche os campos ocultos
                document.getElementById('dataComunicacao').value = dataFormatada;
                document.getElementById('horaComunicacao').value = horaFormatada;

                console.log('[COMUNICADO FORM] Data da Comunicação preenchida automaticamente:', dataFormatada, horaFormatada);
            });
        }

        // Adiciona event listeners aos botões de editar descrição
        const editButtons = document.querySelectorAll('.btn-edit-description');
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                const eventId = this.getAttribute('data-event-id');
                const currentDescription = this.getAttribute('data-description') || '';

                console.log('[EDIT MODAL] Abrindo modal de descrição para evento:', eventId);

                // Preenche os campos do modal
                document.getElementById('editEventId').value = eventId;
                document.getElementById('editDescricao').value = currentDescription;

                // Abre o modal usando Bootstrap 5
                const modal = new bootstrap.Modal(document.getElementById('editDescriptionModal'));
                modal.show();
            });
        });

        // Adiciona event listeners aos botões de editar observações
        const editObsButtons = document.querySelectorAll('.btn-edit-observations');
        editObsButtons.forEach(button => {
            button.addEventListener('click', function() {
                const eventId = this.getAttribute('data-event-id');
                const currentObservations = this.getAttribute('data-observations') || '';

                console.log('[EDIT MODAL] Abrindo modal de observações para evento:', eventId);

                // Preenche os campos do modal
                document.getElementById('editObsEventId').value = eventId;
                document.getElementById('editObservacoes').value = currentObservations;

                // Abre o modal usando Bootstrap 5
                const modal = new bootstrap.Modal(document.getElementById('editObservationsModal'));
                modal.show();
            });
        });
    });
</script>

</body>
</html>
