<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>SUB - Criar Comunicado</title>
    <link rel="stylesheet" th:href="@{/css/cadastro.css}">
    <link rel="stylesheet" th:href="@{/css/cadastro-evento.css}">
</head>
<body>

<section layout:fragment="content">
    <div class="event-form py-4">
        <!-- Lista de Comunicados Criados -->
        <div class="card shadow mb-4" th:if="${myEvents != null and !myEvents.isEmpty()}">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-list-check"></i> Meus Comunicados</h4>
                <p class="text-muted small mb-0 mt-2">Acompanhe o status dos seus comunicados</p>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Título</th>
                                <th>Status</th>
                                <th>Motivo</th>
                                <th>Data Criação</th>
                                <th>Placa</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="ev : ${myEvents}">
                                <td><span class="badge bg-secondary" th:text="${ev.id}">1</span></td>
                                <td>
                                    <strong th:text="${ev.titulo}">Título do evento</strong>
                                    <br>
                                    <small class="text-muted" th:text="${#strings.abbreviate(ev.descricao, 60)}">Descrição...</small>
                                </td>
                                <td>
                                    <span class="badge"
                                          th:classappend="${ev.status.phase == 1 ? 'bg-info' :
                                                          ev.status.phase == 2 ? 'bg-warning text-dark' :
                                                          ev.status.phase == 3 ? 'bg-primary' :
                                                          ev.status.phase == 4 ? 'bg-success' :
                                                          ev.status.phase == 5 ? 'bg-danger' : 'bg-secondary'}"
                                          th:text="${ev.status.displayName}">Status</span>
                                </td>
                                <td th:text="${ev.motivo}">Motivo</td>
                                <td th:text="${ev.createdAt != null ? #temporals.format(ev.createdAt, 'dd/MM/yyyy HH:mm') : '-'}">01/01/2025 10:00</td>
                                <td>
                                    <span th:if="${ev.placaManual != null and !#strings.isEmpty(ev.placaManual)}"
                                          th:text="${ev.placaManual}">ABC-1234</span>
                                    <span th:if="${ev.placaManual == null or #strings.isEmpty(ev.placaManual)}"
                                          class="text-muted">-</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Mensagem quando não há comunicados -->
        <div class="alert alert-info mb-4" th:if="${myEvents == null or myEvents.isEmpty()}">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Você ainda não criou nenhum comunicado.</strong>
            Preencha o formulário abaixo para criar seu primeiro comunicado.
        </div>

        <!-- Formulário de Criação -->
        <div class="card shadow event-form__card">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-megaphone"></i> Criar Novo Comunicado</h4>
                <p class="text-muted small mb-0 mt-2">Registre aqui comunicações sobre eventos relacionados ao seu veículo</p>
            </div>
            <div class="card-body">
                <div class="alert alert-success" th:if="${successMessage}" th:text="${successMessage}"></div>
                <div class="alert alert-danger" th:if="${formError}" th:text="${formError}"></div>

                <form th:action="@{/me/comunicado}" th:object="${event}" method="post" class="event-form__body" id="comunicadoForm">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <input type="hidden" th:field="*{partner.id}" />

                    <!-- Informações do Associado (Read-only) -->
                    <div class="section-title">
                        <h5><i class="bi bi-person-circle"></i> Seus Dados</h5>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Associado:</strong> <span th:text="${partner?.name}">Nome do Associado</span>
                        <span class="mx-2">|</span>
                        <strong>CPF:</strong> <span th:text="${partner?.cpf}">000.000.000-00</span>
                    </div>

                    <!-- Informações Básicas -->
                    <div class="section-title">
                        <h5><i class="bi bi-info-circle"></i> Informações do Comunicado</h5>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="titulo" class="form-label">Título *</label>
                            <input type="text" class="form-control" id="titulo" th:field="*{titulo}"
                                   placeholder="Ex: Colisão no estacionamento, Roubo de veículo, etc." maxlength="200" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('titulo')}" th:errors="*{titulo}"></div>
                        </div>
                        <div class="col-md-4">
                            <label for="status" class="form-label">Status *</label>
                            <select class="form-select" id="status" th:field="*{status}" required>
                                <option value="">Selecione...</option>
                                <option th:each="status : ${statusOptions}"
                                        th:value="${status}"
                                        th:text="${status.displayName}"
                                        th:selected="${status.name() == 'COMUNICADO'}">Status</option>
                            </select>
                            <small class="form-text text-muted">Inicie com "Comunicado"</small>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('status')}" th:errors="*{status}"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="descricao" class="form-label">Descrição *</label>
                            <textarea class="form-control" id="descricao" th:field="*{descricao}"
                                      rows="5" placeholder="Descreva detalhadamente o que aconteceu..." required></textarea>
                            <small class="form-text text-muted">Descreva o ocorrido com o máximo de detalhes possível</small>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('descricao')}" th:errors="*{descricao}"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="prioridade" class="form-label">Prioridade</label>
                            <select class="form-select" id="prioridade" th:field="*{prioridade}">
                                <option value="">Selecione...</option>
                                <option th:each="prioridade : ${prioridadeOptions}"
                                        th:value="${prioridade}"
                                        th:text="${prioridade.displayName}">Prioridade</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="motivo" class="form-label">Motivo *</label>
                            <select class="form-select" id="motivo" th:field="*{motivo}" required>
                                <option value="">Selecione...</option>
                                <option th:each="motivo : ${motivoOptions}"
                                        th:value="${motivo}"
                                        th:text="${motivo}">Motivo</option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('motivo')}" th:errors="*{motivo}"></div>
                        </div>
                        <div class="col-md-4">
                            <label for="envolvimento" class="form-label">Envolvimento *</label>
                            <select class="form-select" id="envolvimento" th:field="*{envolvimento}" required>
                                <option value="">Selecione...</option>
                                <option th:each="envolvimento : ${envolvimentoOptions}"
                                        th:value="${envolvimento}"
                                        th:text="${envolvimento}">Envolvimento</option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('envolvimento')}" th:errors="*{envolvimento}"></div>
                        </div>
                    </div>

                    <!-- Informações do Veículo -->
                    <div class="section-title">
                        <h5><i class="bi bi-car-front"></i> Veículo Envolvido</h5>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="placaManual" class="form-label">Placa do Veículo</label>
                            <input type="text" class="form-control" id="placaManual" th:field="*{placaManual}"
                                   placeholder="Ex: ABC-1234" maxlength="10">
                            <small class="form-text text-muted">Informe a placa do veículo envolvido no evento</small>
                        </div>
                    </div>

                    <!-- Datas -->
                    <div class="section-title">
                        <h5><i class="bi bi-calendar"></i> Datas e Horários</h5>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="dataAconteceu" class="form-label">Data do Ocorrido</label>
                            <input type="date" class="form-control" id="dataAconteceu" th:field="*{dataAconteceu}">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('dataAconteceu')}" th:errors="*{dataAconteceu}"></div>
                        </div>
                        <div class="col-md-2">
                            <label for="horaAconteceu" class="form-label">Hora (HHMM)</label>
                            <input type="number" class="form-control" id="horaAconteceu" th:field="*{horaAconteceu}"
                                   min="0" max="2359" step="1" placeholder="Ex: 0900">
                            <small class="text-muted">Formato: 0900, 1430</small>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('horaAconteceu')}" th:errors="*{horaAconteceu}"></div>
                        </div>
                        <div class="col-md-4">
                            <label for="dataComunicacao" class="form-label">Data da Comunicação</label>
                            <input type="date" class="form-control" id="dataComunicacao" th:field="*{dataComunicacao}">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('dataComunicacao')}" th:errors="*{dataComunicacao}"></div>
                        </div>
                        <div class="col-md-2">
                            <label for="horaComunicacao" class="form-label">Hora (HHMM)</label>
                            <input type="number" class="form-control" id="horaComunicacao" th:field="*{horaComunicacao}"
                                   min="0" max="2359" step="1" placeholder="Ex: 1430">
                            <small class="text-muted">Formato: 0900, 1430</small>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('horaComunicacao')}" th:errors="*{horaComunicacao}"></div>
                        </div>
                    </div>

                    <!-- Observações -->
                    <div class="section-title">
                        <h5><i class="bi bi-card-text"></i> Informações Adicionais</h5>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="observacoes" class="form-label">Observações</label>
                            <textarea class="form-control" id="observacoes" th:field="*{observacoes}"
                                      rows="3" placeholder="Observações adicionais sobre o comunicado..."></textarea>
                        </div>
                    </div>

                    <!-- Botões -->
                    <div class="form-actions">
                        <a th:href="@{/me/vehicles}" class="btn btn-light btn-action">
                            <i class="bi bi-arrow-left"></i>
                            <span>Voltar para meus veículos</span>
                        </a>
                        <div class="form-actions__buttons">
                            <button type="reset" class="btn btn-outline-primary btn-action">
                                <i class="bi bi-arrow-counterclockwise"></i>
                                <span>Limpar campos</span>
                            </button>
                            <button type="submit" class="btn btn-primary btn-action btn-action--primary">
                                <i class="bi bi-send"></i>
                                <span>Enviar Comunicado</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<script layout:fragment="scripts">
    document.addEventListener('DOMContentLoaded', function () {
        'use strict';
        console.log('[COMUNICADO FORM] Formulário de comunicado carregado');

        // Define status padrão como COMUNICADO
        const statusSelect = document.getElementById('status');
        if (statusSelect && !statusSelect.value) {
            statusSelect.value = 'COMUNICADO';
        }
    });
</script>

</body>
</html>
