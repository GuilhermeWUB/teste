<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title th:text="${pageTitle}">SUB - Notificações</title>
    <style>
        .notification-item {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        .notification-item:hover {
            background-color: #f8f9fa;
            transform: translateX(5px);
        }
        .notification-unread {
            background-color: #f0f7ff;
            border-left-color: #0d6efd;
            font-weight: 500;
        }
        .notification-read {
            background-color: #ffffff;
            opacity: 0.9;
        }
        .notification-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .notification-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 1.25rem;
        }
        .priority-badge-URGENTE { background-color: #dc3545; color: white; }
        .priority-badge-ALTA { background-color: #fd7e14; color: white; }
        .priority-badge-MEDIA { background-color: #ffc107; color: black; }
        .priority-badge-BAIXA { background-color: #6c757d; color: white; }
    </style>
</head>
<body>
<section layout:fragment="content">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
        <div>
            <h1 class="mb-0">
                <i class="bi bi-bell-fill me-2"></i>Notificações
            </h1>
            <p class="text-muted mb-0">Acompanhe suas notificações e atualizações do sistema</p>
        </div>
        <div class="d-flex gap-2">
            <span class="badge bg-primary" th:text="${unreadCount} + ' não lidas'">0 não lidas</span>
            <span class="badge bg-secondary" th:text="${totalCount} + ' total'">0 total</span>
        </div>
    </div>

    <!-- Mensagens de sucesso/erro -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Filtros e Ações -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center">
                <div class="btn-group" role="group" aria-label="Filtros">
                    <a th:href="@{/notifications}"
                       th:class="${filter == 'all'} ? 'btn btn-primary' : 'btn btn-outline-primary'">
                        <i class="bi bi-list me-1"></i>Todas
                    </a>
                    <a th:href="@{/notifications(filter='unread')}"
                       th:class="${filter == 'unread'} ? 'btn btn-primary' : 'btn btn-outline-primary'">
                        <i class="bi bi-envelope me-1"></i>Não Lidas
                    </a>
                    <a th:href="@{/notifications(filter='archived')}"
                       th:class="${filter == 'archived'} ? 'btn btn-primary' : 'btn btn-outline-primary'">
                        <i class="bi bi-archive me-1"></i>Arquivadas
                    </a>
                </div>
                <button type="button" class="btn btn-success" id="markAllReadBtn" th:if="${unreadCount > 0}">
                    <i class="bi bi-check-all me-1"></i>Marcar Todas como Lidas
                </button>
            </div>
        </div>
    </div>

    <!-- Lista de Notificações -->
    <div th:if="${notifications.isEmpty()}" class="alert alert-info text-center" role="alert">
        <i class="bi bi-info-circle me-2"></i>
        <span th:if="${filter == 'unread'}">Você não tem notificações não lidas.</span>
        <span th:if="${filter == 'archived'}">Você não tem notificações arquivadas.</span>
        <span th:if="${filter == 'all'}">Você não tem notificações.</span>
    </div>

    <div class="list-group shadow-sm" th:if="${!notifications.isEmpty()}">
        <div th:each="notification : ${notifications}"
             th:class="'list-group-item list-group-item-action notification-item ' +
                      (${notification.status.name() == 'UNREAD'} ? 'notification-unread' : 'notification-read')"
             th:data-notification-id="${notification.id}">

            <div class="d-flex align-items-start gap-3">
                <!-- Ícone do tipo de notificação -->
                <div class="notification-icon flex-shrink-0"
                     th:classappend="${notification.type.name() == 'EVENT'} ? 'bg-primary text-white' :
                                   ${notification.type.name() == 'DEMAND'} ? 'bg-warning text-dark' :
                                   ${notification.type.name() == 'PAYMENT'} ? 'bg-success text-white' :
                                   ${notification.type.name() == 'BANK_SLIP'} ? 'bg-info text-white' :
                                   ${notification.type.name() == 'ALERT'} ? 'bg-danger text-white' :
                                   ${notification.type.name() == 'SYSTEM'} ? 'bg-secondary text-white' :
                                   'bg-light text-dark'">
                    <i th:class="${notification.type.name() == 'EVENT'} ? 'bi bi-calendar-event' :
                                 ${notification.type.name() == 'DEMAND'} ? 'bi bi-list-task' :
                                 ${notification.type.name() == 'PAYMENT'} ? 'bi bi-credit-card' :
                                 ${notification.type.name() == 'BANK_SLIP'} ? 'bi bi-file-earmark-text' :
                                 ${notification.type.name() == 'ALERT'} ? 'bi bi-exclamation-triangle' :
                                 ${notification.type.name() == 'SYSTEM'} ? 'bi bi-gear' :
                                 'bi bi-info-circle'"></i>
                </div>

                <!-- Conteúdo da notificação -->
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <h6 class="mb-0" th:text="${notification.title}">Título da Notificação</h6>
                        <div class="d-flex gap-1 flex-shrink-0">
                            <span class="badge notification-badge"
                                  th:classappend="${notification.type.name() == 'EVENT'} ? 'bg-primary' :
                                                ${notification.type.name() == 'DEMAND'} ? 'bg-warning text-dark' :
                                                ${notification.type.name() == 'PAYMENT'} ? 'bg-success' :
                                                ${notification.type.name() == 'BANK_SLIP'} ? 'bg-info' :
                                                ${notification.type.name() == 'ALERT'} ? 'bg-danger' :
                                                'bg-secondary'"
                                  th:text="${notification.type.displayName}">Tipo</span>
                            <span th:if="${notification.priority != null}"
                                  class="badge notification-badge"
                                  th:classappend="'priority-badge-' + ${notification.priority.name()}"
                                  th:text="${notification.priority.name()}">Prioridade</span>
                        </div>
                    </div>

                    <p class="mb-2 text-muted small" th:text="${notification.message}">Mensagem da notificação</p>

                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="bi bi-clock me-1"></i>
                            <span th:text="${#temporals.format(notification.createdAt, 'dd/MM/yyyy HH:mm')}">Data</span>
                        </small>

                        <div class="btn-group btn-group-sm" role="group">
                            <a th:if="${notification.actionUrl != null}"
                               th:href="@{${notification.actionUrl}}"
                               class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-box-arrow-up-right me-1"></i>Visualizar
                            </a>
                            <button type="button"
                                    class="btn btn-outline-secondary btn-sm mark-read-btn"
                                    th:if="${notification.status.name() == 'UNREAD'}"
                                    th:data-id="${notification.id}">
                                <i class="bi bi-check me-1"></i>Marcar como lida
                            </button>
                            <button type="button"
                                    class="btn btn-outline-secondary btn-sm mark-unread-btn"
                                    th:if="${notification.status.name() == 'READ'}"
                                    th:data-id="${notification.id}">
                                <i class="bi bi-envelope me-1"></i>Marcar como não lida
                            </button>
                            <button type="button"
                                    class="btn btn-outline-warning btn-sm archive-btn"
                                    th:if="${notification.status.name() != 'ARCHIVED'}"
                                    th:data-id="${notification.id}">
                                <i class="bi bi-archive me-1"></i>Arquivar
                            </button>
                            <button type="button"
                                    class="btn btn-outline-danger btn-sm delete-btn"
                                    th:data-id="${notification.id}">
                                <i class="bi bi-trash me-1"></i>Deletar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Paginação -->
    <nav th:if="${totalPages > 1}" aria-label="Navegação de notificações" class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                <a class="page-link" th:href="@{/notifications(page=${currentPage - 1}, filter=${filter})}" aria-label="Anterior">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>

            <li th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}"
                th:if="${pageNum >= currentPage - 2 && pageNum <= currentPage + 2}"
                class="page-item"
                th:classappend="${pageNum == currentPage} ? 'active'">
                <a class="page-link" th:href="@{/notifications(page=${pageNum}, filter=${filter})}" th:text="${pageNum + 1}">1</a>
            </li>

            <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                <a class="page-link" th:href="@{/notifications(page=${currentPage + 1}, filter=${filter})}" aria-label="Próxima">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- JavaScript para ações das notificações -->
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const csrfToken = /*[[${_csrf.token}]]*/ '';
            const csrfHeader = /*[[${_csrf.headerName}]]*/ '';

            // Marcar como lida
            document.querySelectorAll('.mark-read-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.dataset.id;
                    markAsRead(id);
                });
            });

            // Marcar como não lida
            document.querySelectorAll('.mark-unread-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.dataset.id;
                    markAsUnread(id);
                });
            });

            // Arquivar
            document.querySelectorAll('.archive-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.dataset.id;
                    archiveNotification(id);
                });
            });

            // Deletar
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (confirm('Tem certeza que deseja deletar esta notificação?')) {
                        const id = this.dataset.id;
                        deleteNotification(id);
                    }
                });
            });

            // Marcar todas como lidas
            const markAllBtn = document.getElementById('markAllReadBtn');
            if (markAllBtn) {
                markAllBtn.addEventListener('click', function() {
                    markAllAsRead();
                });
            }

            function markAsRead(id) {
                fetch(`/notifications/api/${id}/mark-read`, {
                    method: 'POST',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        location.reload();
                    }
                })
                .catch(error => console.error('Erro:', error));
            }

            function markAsUnread(id) {
                fetch(`/notifications/api/${id}/mark-unread`, {
                    method: 'POST',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        location.reload();
                    }
                })
                .catch(error => console.error('Erro:', error));
            }

            function archiveNotification(id) {
                fetch(`/notifications/api/${id}/archive`, {
                    method: 'POST',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        location.reload();
                    }
                })
                .catch(error => console.error('Erro:', error));
            }

            function deleteNotification(id) {
                fetch(`/notifications/api/${id}`, {
                    method: 'DELETE',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        location.reload();
                    }
                })
                .catch(error => console.error('Erro:', error));
            }

            function markAllAsRead() {
                fetch('/notifications/api/mark-all-read', {
                    method: 'POST',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        location.reload();
                    }
                })
                .catch(error => console.error('Erro:', error));
            }
        });
    </script>
</section>
</body>
</html>
