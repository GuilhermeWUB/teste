<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>SUB - Notificacoes</title>
    <link rel="stylesheet" th:href="@{/css/notifications.css}">
</head>
<body>
<section layout:fragment="content">
    <main class="notif-page">
        <div class="container">
            <section class="notif-hero">
                <div class="notif-hero__halo"></div>
                <div class="notif-hero__breadcrumb">
                    <span class="notif-hero__dot"></span>
                    <span>Central de notificacoes</span>
                </div>
                <div class="notif-hero__header">
                    <div>
                        <h1>
                            <span class="notif-hero__icon">
                                <i class="bi bi-bell-fill"></i>
                            </span>
                            Notificacoes
                        </h1>
                        <p>Acompanhe atualizacoes, alertas e mensagens importantes em tempo real.</p>
                    </div>
                    <button type="button"
                            class="notif-button notif-button--primary"
                            id="markAllReadBtn"
                            th:if="${unreadCount > 0}">
                        <i class="bi bi-check-all"></i>
                        <span>Marcar tudo como lido</span>
                    </button>
                </div>
                <div class="notif-stats" role="status" aria-live="polite">
                    <article class="notif-stat notif-stat--accent">
                        <div class="notif-stat__icon">
                            <i class="bi bi-envelope-open"></i>
                        </div>
                        <div>
                            <p>Nao lidas</p>
                            <strong th:text="${unreadCount}">0</strong>
                        </div>
                    </article>
                    <article class="notif-stat">
                        <div class="notif-stat__icon">
                            <i class="bi bi-inbox"></i>
                        </div>
                        <div>
                            <p>Total</p>
                            <strong th:text="${totalCount}">0</strong>
                        </div>
                    </article>
                    <article class="notif-stat">
                        <div class="notif-stat__icon">
                            <i class="bi bi-funnel"></i>
                        </div>
                        <div>
                            <p>Filtro ativo</p>
                            <strong th:text="${filter == 'all'} ? 'Todas' : (${filter == 'unread'} ? 'Nao lidas' : 'Arquivadas')">Todas</strong>
                        </div>
                    </article>
                </div>
            </section>

            <div id="toastContainer" class="notif-toast__container"></div>

            <div th:if="${successMessage}" class="notif-alert notif-alert--success" role="alert">
                <i class="bi bi-check-circle-fill"></i>
                <p th:text="${successMessage}"></p>
                <button type="button" class="notif-alert__close" aria-label="Fechar">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div th:if="${errorMessage}" class="notif-alert notif-alert--error" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <p th:text="${errorMessage}"></p>
                <button type="button" class="notif-alert__close" aria-label="Fechar">
                    <i class="bi bi-x"></i>
                </button>
            </div>

            <section class="notif-toolbar">
                <div class="notif-tabs" aria-label="Filtrar notificacoes">
                    <a th:href="@{/notifications}"
                       class="notif-tab"
                       th:classappend="${filter == 'all'} ? ' is-active'"
                       aria-current="${filter == 'all'} ? 'page'">
                        <span> Todas </span>
                        <span class="notif-tab__badge" th:text="${totalCount}">0</span>
                    </a>
                    <a th:href="@{/notifications(filter='unread')}"
                       class="notif-tab"
                       th:classappend="${filter == 'unread'} ? ' is-active'"
                       aria-current="${filter == 'unread'} ? 'page'">
                        <span>Nao lidas</span>
                        <span class="notif-tab__badge notif-tab__badge--danger"
                              th:if="${unreadCount > 0}"
                              th:text="${unreadCount}">0</span>
                    </a>
                    <a th:href="@{/notifications(filter='archived')}"
                       class="notif-tab"
                       th:classappend="${filter == 'archived'} ? ' is-active'"
                       aria-current="${filter == 'archived'} ? 'page'">
                        <span>Arquivadas</span>
                    </a>
                </div>
                <label class="notif-search">
                    <i class="bi bi-search"></i>
                    <input id="notificationSearch"
                           type="search"
                           placeholder="Buscar notificacoes..."
                           autocomplete="off"
                           aria-label="Buscar notificacoes">
                    <kbd>Cmd+K</kbd>
                </label>
            </section>

            <section th:if="${notifications.isEmpty()}" class="notif-empty">
                <div class="notif-empty__glow"></div>
                <div class="notif-empty__icon">
                    <i class="bi bi-bell-slash"></i>
                </div>
                <h2>
                    <span th:if="${filter == 'unread'}">Tudo em dia!</span>
                    <span th:if="${filter == 'archived'}">Nenhuma arquivada</span>
                    <span th:if="${filter == 'all'}">Sem notificacoes</span>
                </h2>
                <p>
                    <span th:if="${filter == 'unread'}">Voce nao tem notificacoes nao lidas no momento.</span>
                    <span th:if="${filter == 'archived'}">Voce ainda nao arquivou nenhuma notificacao.</span>
                    <span th:if="${filter == 'all'}">Assim que receber notificacoes elas aparecerao aqui.</span>
                </p>
                <a th:if="${filter != 'all'}" th:href="@{/notifications}" class="notif-button notif-button--ghost">
                    <i class="bi bi-arrow-left"></i>
                    <span>Voltar para todas</span>
                </a>
            </section>

            <section th:if="${!notifications.isEmpty()}" class="notif-panel">
                <ul class="notif-list">
                    <li th:each="notification, iterStat : ${notifications}"
                        th:data-notification-id="${notification.id}"
                        th:class="'notif-card ' + (${notification.status.name() == 'UNREAD'} ? 'notif-card--unread' : (${notification.status.name() == 'ARCHIVED'} ? 'notif-card--archived' : ''))"
                        th:style="'--delay:' + ${iterStat.index * 0.04} + 's'"
                        th:attr="data-title=${notification.title}, data-message=${notification.message}, data-type=${notification.type.displayName}, data-priority=${notification.priority != null ? notification.priority.name() : ''}">
                        <div class="notif-card__indicator" th:if="${notification.status.name() == 'UNREAD'}"></div>
                        <div class="notif-card__icon"
                             th:classappend="${notification.type.name() == 'EVENT'} ? ' is-event' :
                                            ${notification.type.name() == 'DEMAND'} ? ' is-demand' :
                                            ${notification.type.name() == 'PAYMENT'} ? ' is-payment' :
                                            ${notification.type.name() == 'BANK_SLIP'} ? ' is-bankslip' :
                                            ${notification.type.name() == 'ALERT'} ? ' is-alert' :
                                            ${notification.type.name() == 'SYSTEM'} ? ' is-system' :
                                            ${notification.type.name() == 'COMUNICADO'} ? ' is-comunicado' :
                                            ' is-info'">
                            <i th:class="${notification.type.name() == 'EVENT'} ? 'bi bi-calendar-event' :
                                         ${notification.type.name() == 'DEMAND'} ? 'bi bi-list-task' :
                                         ${notification.type.name() == 'PAYMENT'} ? 'bi bi-credit-card' :
                                         ${notification.type.name() == 'BANK_SLIP'} ? 'bi bi-file-earmark-text' :
                                         ${notification.type.name() == 'ALERT'} ? 'bi bi-exclamation-octagon' :
                                         ${notification.type.name() == 'SYSTEM'} ? 'bi bi-cpu' :
                                         ${notification.type.name() == 'COMUNICADO'} ? 'bi bi-megaphone' :
                                         'bi bi-info-circle'"></i>
                        </div>
                        <div class="notif-card__body">
                            <header class="notif-card__header">
                                <div>
                                    <h3 th:text="${notification.title}">Titulo</h3>
                                    <div class="notif-card__tags">
                                        <span class="notif-tag"
                                              th:classappend="${notification.type.name() == 'EVENT'} ? ' tag-event' :
                                                              ${notification.type.name() == 'DEMAND'} ? ' tag-demand' :
                                                              ${notification.type.name() == 'PAYMENT'} ? ' tag-payment' :
                                                              ${notification.type.name() == 'BANK_SLIP'} ? ' tag-bankslip' :
                                                              ${notification.type.name() == 'ALERT'} ? ' tag-alert' :
                                                              ${notification.type.name() == 'SYSTEM'} ? ' tag-system' :
                                                              ${notification.type.name() == 'COMUNICADO'} ? ' tag-comunicado' :
                                                              ' tag-info'"
                                              th:text="${notification.type.displayName}">Tipo</span>
                                        <span th:if="${notification.priority != null}"
                                              class="notif-tag notif-tag--pill"
                                              th:classappend="' priority-' + ${notification.priority.name().toLowerCase()}">
                                            <i th:class="${notification.priority.name() == 'URGENTE'} ? 'bi bi-lightning-fill' :
                                                         ${notification.priority.name() == 'ALTA'} ? 'bi bi-arrow-up' :
                                                         ${notification.priority.name() == 'MEDIA'} ? 'bi bi-dash' :
                                                         'bi bi-arrow-down'"></i>
                                            <span th:text="${notification.priority.name()}">Prioridade</span>
                                        </span>
                                    </div>
                                </div>
                                <div class="notif-card__time">
                                    <strong th:text="${#temporals.format(notification.createdAt, 'dd MMM')}">12 Mai</strong>
                                    <small th:text="${#temporals.format(notification.createdAt, 'HH:mm')}">09:20</small>
                                </div>
                            </header>
                            <div class="notif-card__message">
                                <p th:id="'message-' + ${notification.id}"
                                   th:text="${notification.message}">
                                    Mensagem da notificacao
                                </p>
                                <button type="button"
                                        class="notif-link notif-message-toggle"
                                        th:attr="data-target='message-' + ${notification.id}">
                                    <span>Ver mais</span>
                                    <i class="bi bi-chevron-down"></i>
                                </button>
                            </div>
                            <footer class="notif-card__footer">
                                <span class="notif-card__meta">
                                    <i class="bi bi-clock"></i>
                                    <span th:text="${#temporals.format(notification.createdAt, 'dd/MM/yyyy')} + ' as ' + ${#temporals.format(notification.createdAt, 'HH:mm')}">12/05/2024 as 09:20</span>
                                </span>
                                <div class="notif-card__actions">
                                    <a th:if="${notification.actionUrl != null}"
                                       th:href="@{${notification.actionUrl}}"
                                       class="notif-button notif-button--ghost"
                                       title="Abrir">
                                        <i class="bi bi-arrow-up-right"></i>
                                    </a>
                                    <button type="button"
                                            class="notif-button notif-button--ghost mark-read-btn"
                                            th:if="${notification.status.name() == 'UNREAD'}"
                                            th:data-id="${notification.id}"
                                            title="Marcar como lida">
                                        <i class="bi bi-check2"></i>
                                    </button>
                                    <button type="button"
                                            class="notif-button notif-button--ghost mark-unread-btn"
                                            th:if="${notification.status.name() == 'READ'}"
                                            th:data-id="${notification.id}"
                                            title="Marcar como nao lida">
                                        <i class="bi bi-envelope"></i>
                                    </button>
                                    <button type="button"
                                            class="notif-button notif-button--ghost archive-btn"
                                            th:if="${notification.status.name() != 'ARCHIVED'}"
                                            th:data-id="${notification.id}"
                                            title="Arquivar">
                                        <i class="bi bi-archive"></i>
                                    </button>
                                    <button type="button"
                                            class="notif-button notif-button--ghost delete-btn"
                                            th:data-id="${notification.id}"
                                            title="Excluir">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </footer>
                        </div>
                    </li>
                </ul>
                <div class="notif-search-empty d-none" id="emptySearchState">
                    <i class="bi bi-search"></i>
                    <p>Nenhuma notificacao corresponde a sua busca.</p>
                </div>
            </section>

            <nav th:if="${totalPages > 1}" class="notif-pagination" aria-label="Paginacao de notificacoes">
                <a th:href="@{/notifications(page=${currentPage - 1}, filter=${filter})}"
                   class="notif-pagination__btn"
                   th:classappend="${currentPage == 0} ? ' is-disabled'"
                   th:tabindex="${currentPage == 0} ? '-1' : '0'"
                   aria-label="Pagina anterior">
                    <i class="bi bi-chevron-left"></i>
                </a>
                <div class="notif-pagination__pages">
                    <a th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}"
                       th:if="${pageNum >= currentPage - 2 && pageNum <= currentPage + 2}"
                       th:href="@{/notifications(page=${pageNum}, filter=${filter})}"
                       class="notif-pagination__page"
                       th:classappend="${pageNum == currentPage} ? ' is-active'"
                       th:text="${pageNum + 1}"
                       th:aria-current="${pageNum == currentPage} ? 'page'">1</a>
                </div>
                <a th:href="@{/notifications(page=${currentPage + 1}, filter=${filter})}"
                   class="notif-pagination__btn"
                   th:classappend="${currentPage == totalPages - 1} ? ' is-disabled'"
                   th:tabindex="${currentPage == totalPages - 1} ? '-1' : '0'"
                   aria-label="Proxima pagina">
                    <i class="bi bi-chevron-right"></i>
                </a>
                <span class="notif-pagination__summary">
                    Pagina <strong th:text="${currentPage + 1}">1</strong> de <strong th:text="${totalPages}">1</strong>
                </span>
            </nav>
        </div>
    </main>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', () => {
            const csrfToken = /*[[${_csrf.token}]]*/ '';
            const csrfHeader = /*[[${_csrf.headerName}]]*/ '';
            const notificationItems = Array.from(document.querySelectorAll('.notif-card'));
            const searchInput = document.getElementById('notificationSearch');
            const emptySearchState = document.getElementById('emptySearchState');
            const toastContainer = document.getElementById('toastContainer');

            const showToast = (message, type = 'success') => {
                const toast = document.createElement('div');
                toast.className = `notif-toast ${type === 'error' ? 'error' : ''}`;
                toast.innerHTML = `
                    <i class="bi ${type === 'error' ? 'bi-x-circle-fill' : 'bi-check-circle-fill'}"></i>
                    <span>${message}</span>
                `;
                toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateY(-10px)';
                    setTimeout(() => toast.remove(), 300);
                }, 3200);
            };

            const applySearchFilter = () => {
                if (!searchInput) return;
                const query = searchInput.value.trim().toLowerCase();
                let visible = 0;

                notificationItems.forEach(item => {
                    if (!query) {
                        item.classList.remove('d-none');
                        visible++;
                        return;
                    }
                    const haystack = [
                        item.dataset.title,
                        item.dataset.message,
                        item.dataset.type,
                        item.dataset.priority
                    ].filter(Boolean).join(' ').toLowerCase();

                    const match = haystack.includes(query);
                    item.classList.toggle('d-none', !match);
                    if (match) visible++;
                });

                if (emptySearchState) {
                    emptySearchState.classList.toggle('d-none', visible !== 0);
                }
            };

            if (searchInput) {
                searchInput.addEventListener('input', applySearchFilter);
                document.addEventListener('keydown', (event) => {
                    if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === 'k') {
                        event.preventDefault();
                        searchInput.focus();
                    }
                });
            }

            document.querySelectorAll('.notif-alert__close').forEach(btn => {
                btn.addEventListener('click', () => btn.parentElement.remove());
            });

            const toggleButtons = document.querySelectorAll('.notif-message-toggle');
            toggleButtons.forEach(btn => {
                const targetId = btn.getAttribute('data-target');
                const message = document.getElementById(targetId);
                if (!message) return;

                const needsToggle = message.scrollHeight > message.clientHeight + 4;
                if (!needsToggle) {
                    btn.style.display = 'none';
                    return;
                }

                btn.addEventListener('click', () => {
                    const expanded = message.classList.toggle('expanded');
                    btn.classList.toggle('is-open', expanded);
                    btn.querySelector('span').textContent = expanded ? 'Ver menos' : 'Ver mais';
                });
            });

            const apiCall = async (url, method = 'POST') => {
                const response = await fetch(url, {
                    method,
                    headers: {
                        [csrfHeader]: csrfToken,
                        'Content-Type': 'application/json'
                    }
                });
                return response.json();
            };

            const removeNotificationItem = (id) => {
                const item = document.querySelector(`[data-notification-id="${id}"]`);
                if (item) {
                    item.style.transition = '0.3s ease';
                    item.style.opacity = '0';
                    item.style.transform = 'translateY(-8px)';
                    setTimeout(() => {
                        item.remove();
                        if (!document.querySelectorAll('.notif-card').length) {
                            location.reload();
                        }
                    }, 280);
                }
            };

            const updateNotificationItem = (id, newStatus) => {
                const item = document.querySelector(`[data-notification-id="${id}"]`);
                if (!item) return;

                item.classList.remove('notif-card--unread', 'notif-card--archived');
                if (newStatus === 'UNREAD') item.classList.add('notif-card--unread');
                if (newStatus === 'ARCHIVED') item.classList.add('notif-card--archived');

                const indicator = item.querySelector('.notif-card__indicator');
                if (newStatus === 'UNREAD') {
                    if (!indicator) {
                        const dot = document.createElement('div');
                        dot.className = 'notif-card__indicator';
                        item.insertBefore(dot, item.firstChild);
                    }
                } else if (indicator) {
                    indicator.remove();
                }

                const markReadBtn = item.querySelector('.mark-read-btn');
                const markUnreadBtn = item.querySelector('.mark-unread-btn');

                if (newStatus === 'READ' && markReadBtn) {
                    markReadBtn.outerHTML = `
                        <button type="button" class="notif-button notif-button--ghost mark-unread-btn" data-id="${id}" title="Marcar como nao lida">
                            <i class="bi bi-envelope"></i>
                        </button>
                    `;
                    attachMarkUnreadHandler(item.querySelector('.mark-unread-btn'));
                }

                if (newStatus === 'UNREAD' && markUnreadBtn) {
                    markUnreadBtn.outerHTML = `
                        <button type="button" class="notif-button notif-button--ghost mark-read-btn" data-id="${id}" title="Marcar como lida">
                            <i class="bi bi-check2"></i>
                        </button>
                    `;
                    attachMarkReadHandler(item.querySelector('.mark-read-btn'));
                }
            };

            const updateUnreadCount = (delta) => {
                const statValue = document.querySelector('.notif-stats .notif-stat--accent strong');
                if (statValue) {
                    const next = Math.max(0, (parseInt(statValue.textContent) || 0) + delta);
                    statValue.textContent = next;
                }

                const bubble = document.querySelector('.notif-tab__badge--danger');
                if (bubble) {
                    const next = Math.max(0, (parseInt(bubble.textContent) || 0) + delta);
                    if (next <= 0) {
                        bubble.remove();
                    } else {
                        bubble.textContent = next;
                    }
                }
            };

            const attachMarkReadHandler = (btn) => {
                if (!btn) return;
                btn.addEventListener('click', async () => {
                    const id = btn.dataset.id;
                    try {
                        const data = await apiCall(`/notifications/api/${id}/mark-read`);
                        if (data.status === 'success') {
                            updateNotificationItem(id, 'READ');
                            updateUnreadCount(-1);
                            showToast('Notificacao marcada como lida');
                        }
                    } catch (error) {
                        showToast('Erro ao marcar como lida', 'error');
                    }
                });
            };

            const attachMarkUnreadHandler = (btn) => {
                if (!btn) return;
                btn.addEventListener('click', async () => {
                    const id = btn.dataset.id;
                    try {
                        const data = await apiCall(`/notifications/api/${id}/mark-unread`);
                        if (data.status === 'success') {
                            updateNotificationItem(id, 'UNREAD');
                            updateUnreadCount(1);
                            showToast('Notificacao marcada como nao lida');
                        }
                    } catch (error) {
                        showToast('Erro ao marcar como nao lida', 'error');
                    }
                });
            };

            document.querySelectorAll('.mark-read-btn').forEach(attachMarkReadHandler);
            document.querySelectorAll('.mark-unread-btn').forEach(attachMarkUnreadHandler);

            document.querySelectorAll('.archive-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.dataset.id;
                    try {
                        const data = await apiCall(`/notifications/api/${id}/archive`);
                        if (data.status === 'success') {
                            removeNotificationItem(id);
                            showToast('Notificacao arquivada');
                        }
                    } catch (error) {
                        showToast('Erro ao arquivar', 'error');
                    }
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    if (!confirm('Deseja excluir esta notificacao?')) return;
                    const id = btn.dataset.id;
                    try {
                        const data = await apiCall(`/notifications/api/${id}`, 'DELETE');
                        if (data.status === 'success') {
                            removeNotificationItem(id);
                            showToast('Notificacao excluida');
                        }
                    } catch (error) {
                        showToast('Erro ao excluir', 'error');
                    }
                });
            });

            const markAllBtn = document.getElementById('markAllReadBtn');
            if (markAllBtn) {
                markAllBtn.addEventListener('click', async () => {
                    try {
                        const data = await apiCall('/notifications/api/mark-all-read');
                        if (data.status === 'success') {
                            showToast('Notificacoes marcadas como lidas');
                            setTimeout(() => location.reload(), 900);
                        }
                    } catch (error) {
                        showToast('Erro ao marcar todas como lidas', 'error');
                    }
                });
            }
        });
    </script>
</section>
</body>
</html>
