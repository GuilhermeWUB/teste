<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" data-theme="light">
<head th:replace="~{fragments/layout :: head}"></head>
<body>
<header th:replace="~{fragments/layout :: header}"></header>

<link rel="stylesheet" th:href="@{/css/notifications.css}" />

<section class="notifications-page">
    <div class="notifications-container">
        <div class="hero-card">
            <div class="hero-content">
                <div class="hero-icon">
                    <i class="bi bi-bell-fill"></i>
                </div>
                <div>
                    <h1 class="hero-title">Notificações</h1>
                    <p class="hero-subtitle">Acompanhe alertas, comunicados e atualizações importantes do sistema</p>
                </div>
            </div>
            <div class="hero-actions">
                <div class="status-badges">
                    <span class="status-pill status-pill--primary">
                        <i class="bi bi-envelope-open me-1"></i>
                        <span th:text="${unreadCount}">0</span>
                        <span>não lidas</span>
                    </span>
                    <span class="status-pill">
                        <i class="bi bi-collection me-1"></i>
                        <span th:text="${totalCount}">0</span>
                        <span>no total</span>
                    </span>
                </div>
                <button type="button" class="btn btn-hero" id="markAllReadBtn" th:if="${unreadCount > 0}">
                    <i class="bi bi-check-all"></i>
                    Marcar todas como lidas
                </button>
            </div>
        </div>

        <div th:if="${successMessage}" class="feedback-card feedback-card--success alert alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill"></i>
            <div class="feedback-content">
                <h6>Ação concluída</h6>
                <p th:text="${successMessage}"></p>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
        </div>

        <div th:if="${errorMessage}" class="feedback-card feedback-card--danger alert alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <div class="feedback-content">
                <h6>Algo deu errado</h6>
                <p th:text="${errorMessage}"></p>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
        </div>

        <div class="filters-card">
            <div class="filters-group" role="group" aria-label="Filtros de notificações">
                <a th:href="@{/notifications}"
                   th:class="${filter == 'all'} ? 'filters-button active' : 'filters-button'">
                    <i class="bi bi-list"></i>
                    Todas
                </a>
                <a th:href="@{/notifications(filter='unread')}"
                   th:class="${filter == 'unread'} ? 'filters-button active' : 'filters-button'">
                    <i class="bi bi-envelope"></i>
                    Não lidas
                </a>
                <a th:href="@{/notifications(filter='archived')}"
                   th:class="${filter == 'archived'} ? 'filters-button active' : 'filters-button'">
                    <i class="bi bi-archive"></i>
                    Arquivadas
                </a>
            </div>
        </div>

        <div th:if="${notifications.isEmpty()}" class="empty-state" role="alert">
            <div class="empty-icon">
                <i class="bi bi-inbox"></i>
            </div>
            <h2>Nenhuma notificação por aqui</h2>
            <p th:if="${filter == 'unread'}">Você está em dia! Não há notificações não lidas.</p>
            <p th:if="${filter == 'archived'}">Você ainda não arquivou nenhuma notificação.</p>
            <p th:if="${filter == 'all'}">Assim que houver novidades, elas aparecerão aqui.</p>
        </div>

        <div class="notification-timeline" th:if="${!notifications.isEmpty()}">
            <div class="notification-card" th:each="notification : ${notifications}"
                 th:classappend="${notification.status.name() == 'UNREAD'} ? ' notification-card--unread' : ''"
                 th:data-notification-id="${notification.id}">
                <div class="notification-marker"></div>
                <div class="notification-header">
                    <div class="notification-icon"
                         th:classappend="${notification.type.name() == 'EVENT'} ? ' icon-event' :
                                        ${notification.type.name() == 'DEMAND'} ? ' icon-demand' :
                                        ${notification.type.name() == 'PAYMENT'} ? ' icon-payment' :
                                        ${notification.type.name() == 'BANK_SLIP'} ? ' icon-bank-slip' :
                                        ${notification.type.name() == 'ALERT'} ? ' icon-alert' :
                                        ${notification.type.name() == 'SYSTEM'} ? ' icon-system' :
                                        ' icon-default'">
                        <i th:class="${notification.type.name() == 'EVENT'} ? 'bi bi-calendar-event' :
                                     ${notification.type.name() == 'DEMAND'} ? 'bi bi-list-task' :
                                     ${notification.type.name() == 'PAYMENT'} ? 'bi bi-credit-card' :
                                     ${notification.type.name() == 'BANK_SLIP'} ? 'bi bi-file-earmark-text' :
                                     ${notification.type.name() == 'ALERT'} ? 'bi bi-exclamation-triangle' :
                                     ${notification.type.name() == 'SYSTEM'} ? 'bi bi-gear' :
                                     'bi bi-info-circle'"></i>
                    </div>
                    <div class="notification-title-group">
                        <h3 class="notification-title" th:text="${notification.title}">Título da Notificação</h3>
                        <div class="notification-tags">
                            <span class="tag"
                                  th:classappend="${notification.type.name() == 'EVENT'} ? ' tag-event' :
                                                ${notification.type.name() == 'DEMAND'} ? ' tag-demand' :
                                                ${notification.type.name() == 'PAYMENT'} ? ' tag-payment' :
                                                ${notification.type.name() == 'BANK_SLIP'} ? ' tag-bank-slip' :
                                                ${notification.type.name() == 'ALERT'} ? ' tag-alert' :
                                                ' tag-system'"
                                  th:text="${notification.type.displayName}">Tipo</span>
                            <span th:if="${notification.priority != null}"
                                  class="tag tag-priority"
                                  th:classappend="' tag-priority-' + ${notification.priority.name()}"
                                  th:text="${notification.priority.name()}">Prioridade</span>
                        </div>
                    </div>
                </div>

                <p class="notification-message" th:text="${notification.message}">Mensagem da notificação</p>

                <div class="notification-footer">
                    <div class="notification-meta">
                        <i class="bi bi-clock"></i>
                        <span th:text="${#temporals.format(notification.createdAt, 'dd/MM/yyyy HH:mm')}">Data</span>
                    </div>
                    <div class="notification-actions">
                        <a th:if="${notification.actionUrl != null}"
                           th:href="@{${notification.actionUrl}}"
                           class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-box-arrow-up-right"></i>
                            Visualizar
                        </a>
                        <button type="button"
                                class="btn btn-outline-secondary btn-sm mark-read-btn"
                                th:if="${notification.status.name() == 'UNREAD'}"
                                th:data-id="${notification.id}">
                            <i class="bi bi-check"></i>
                            Marcar como lida
                        </button>
                        <button type="button"
                                class="btn btn-outline-secondary btn-sm mark-unread-btn"
                                th:if="${notification.status.name() == 'READ'}"
                                th:data-id="${notification.id}">
                            <i class="bi bi-envelope"></i>
                            Marcar como não lida
                        </button>
                        <button type="button"
                                class="btn btn-outline-warning btn-sm archive-btn"
                                th:if="${notification.status.name() != 'ARCHIVED'}"
                                th:data-id="${notification.id}">
                            <i class="bi bi-archive"></i>
                            Arquivar
                        </button>
                        <button type="button"
                                class="btn btn-outline-danger btn-sm delete-btn"
                                th:data-id="${notification.id}">
                            <i class="bi bi-trash"></i>
                            Deletar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <nav th:if="${totalPages > 1}" aria-label="Navegação de notificações" class="pagination-wrapper">
            <ul class="pagination">
                <li class="page-item" th:classappend="${currentPage == 0} ? ' disabled'">
                    <a class="page-link" th:href="@{/notifications(page=${currentPage - 1}, filter=${filter})}" aria-label="Anterior">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>

                <li th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}"
                    th:if="${pageNum >= currentPage - 2 && pageNum <= currentPage + 2}"
                    class="page-item"
                    th:classappend="${pageNum == currentPage} ? ' active'">
                    <a class="page-link" th:href="@{/notifications(page=${pageNum}, filter=${filter})}" th:text="${pageNum + 1}">1</a>
                </li>

                <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? ' disabled'">
                    <a class="page-link" th:href="@{/notifications(page=${currentPage + 1}, filter=${filter})}" aria-label="Próxima">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</section>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const csrfToken = /*[[${_csrf.token}]]*/ '';
        const csrfHeader = /*[[${_csrf.headerName}]]*/ '';

        document.querySelectorAll('.mark-read-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.id;
                markAsRead(id);
            });
        });

        document.querySelectorAll('.mark-unread-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.id;
                markAsUnread(id);
            });
        });

        document.querySelectorAll('.archive-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.id;
                archiveNotification(id);
            });
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (confirm('Tem certeza que deseja deletar esta notificação?')) {
                    const id = this.dataset.id;
                    deleteNotification(id);
                }
            });
        });

        const markAllBtn = document.getElementById('markAllReadBtn');
        if (markAllBtn) {
            markAllBtn.addEventListener('click', function() {
                markAllAsRead();
            });
        }

        function markAsRead(id) {
            fetch(`/notifications/api/${id}/mark-read`, {
                method: 'POST',
                headers: {
                    [csrfHeader]: csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                }
            })
            .catch(error => console.error('Erro:', error));
        }

        function markAsUnread(id) {
            fetch(`/notifications/api/${id}/mark-unread`, {
                method: 'POST',
                headers: {
                    [csrfHeader]: csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                }
            })
            .catch(error => console.error('Erro:', error));
        }

        function archiveNotification(id) {
            fetch(`/notifications/api/${id}/archive`, {
                method: 'POST',
                headers: {
                    [csrfHeader]: csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                }
            })
            .catch(error => console.error('Erro:', error));
        }

        function deleteNotification(id) {
            fetch(`/notifications/api/${id}`, {
                method: 'DELETE',
                headers: {
                    [csrfHeader]: csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                }
            })
            .catch(error => console.error('Erro:', error));
        }

        function markAllAsRead() {
            fetch('/notifications/api/mark-all-read', {
                method: 'POST',
                headers: {
                    [csrfHeader]: csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                }
            })
            .catch(error => console.error('Erro:', error));
        }
    });
</script>

<script th:src="@{/js/notification-dropdown.js}"></script>
</body>
</html>
