<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>SUB - Cadastrar Comunicação</title>
    <link rel="stylesheet" th:href="@{/css/cadastro.css}">
    <link rel="stylesheet" th:href="@{/css/cadastro-evento.css}">
</head>
<body>

<section layout:fragment="content">
    <div class="event-form py-4">
        <div class="card shadow event-form__card">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-plus-circle"></i> Detalhes do Evento</h4>
            </div>
            <div class="card-body">
                <div class="alert alert-danger" th:if="${formError}" th:text="${formError}"></div>
                <form th:action="@{/events}" th:object="${event}" method="post" class="event-form__body" id="eventForm">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                    <!-- Informações Básicas -->
                    <div class="section-title">
                        <h5><i class="bi bi-info-circle"></i> Informações Básicas</h5>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="titulo" class="form-label">Título *</label>
                            <input type="text" class="form-control" id="titulo" th:field="*{titulo}"
                                   placeholder="Ex: Colisão no estacionamento" maxlength="200" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('titulo')}" th:errors="*{titulo}"></div>
                        </div>
                        <div class="col-md-4">
                            <label for="status" class="form-label">Status *</label>
                            <select class="form-select" id="status" th:field="*{status}" required>
                                <option value="">Selecione...</option>
                                <option th:each="status : ${statusOptions}"
                                        th:value="${status}"
                                        th:text="${status.displayName}">Status</option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('status')}" th:errors="*{status}"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="descricao" class="form-label">Descrição *</label>
                            <textarea class="form-control" id="descricao" th:field="*{descricao}"
                                      rows="4" placeholder="Descreva o que aconteceu..." required></textarea>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('descricao')}" th:errors="*{descricao}"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="prioridade" class="form-label">Prioridade</label>
                            <select class="form-select" id="prioridade" th:field="*{prioridade}">
                                <option value="">Selecione...</option>
                                <option th:each="prioridade : ${prioridadeOptions}"
                                        th:value="${prioridade}"
                                        th:text="${prioridade.displayName}">Prioridade</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="motivo" class="form-label">Motivo *</label>
                            <select class="form-select" id="motivo" th:field="*{motivo}" required>
                                <option value="">Selecione...</option>
                                <option th:each="motivo : ${motivoOptions}"
                                        th:value="${motivo}"
                                        th:text="${motivo}">Motivo</option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('motivo')}" th:errors="*{motivo}"></div>
                        </div>
                        <div class="col-md-4">
                            <label for="envolvimento" class="form-label">Envolvimento *</label>
                            <select class="form-select" id="envolvimento" th:field="*{envolvimento}" required>
                                <option value="">Selecione...</option>
                                <option th:each="envolvimento : ${envolvimentoOptions}"
                                        th:value="${envolvimento}"
                                        th:text="${envolvimento}">Envolvimento</option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('envolvimento')}" th:errors="*{envolvimento}"></div>
                        </div>
                    </div>

                    <!-- Associado e Veículo -->
                    <div class="section-title">
                        <h5><i class="bi bi-people"></i> Associado e Veículo</h5>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="partner" class="form-label">Associado *</label>
                            <select class="form-select" id="partner" th:field="*{partner.id}" required>
                                <option value="">Selecione o associado...</option>
                                <option th:each="partner : ${partners}"
                                        th:value="${partner.id}"
                                        th:text="${partner.name + ' - ' + partner.cpf}">Associado</option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('partner')}" th:errors="*{partner}"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="vehiclePlate" class="form-label">Veículo (Placa) *</label>
                            <input type="text" id="vehiclePlate" class="form-control" list="vehicleOptions" placeholder="Digite ou selecione a placa..." autocomplete="off" required />
                            <datalist id="vehicleOptions">
                                <option th:each="vehicle : ${vehicles}"
                                        th:value="${vehicle.plaque}"
                                        th:data-id="${vehicle.id}"
                                        th:text="${vehicle.plaque + ' - ' + vehicle.maker + ' ' + vehicle.model}"></option>
                            </datalist>
                            <input type="hidden" id="vehicleId" th:field="*{vehicle.id}" />
                            <input type="hidden" id="vehiclePlateHidden" th:field="*{vehicle.plaque}" />
                            <div class="invalid-feedback d-block" id="vehicleError" style="display:none">Selecione uma placa válida da lista.</div>
                        </div>
                    </div>

                    <!-- Datas -->
                    <div class="section-title">
                        <h5><i class="bi bi-calendar"></i> Datas e Horários</h5>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="dataAconteceu" class="form-label">Data do Ocorrido *</label>
                            <input type="date" class="form-control" id="dataAconteceu" th:field="*{dataAconteceu}" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('dataAconteceu')}" th:errors="*{dataAconteceu}"></div>
                        </div>
                        <div class="col-md-2">
                            <label for="horaAconteceu" class="form-label">Hora *</label>
                            <input type="time" class="form-control" id="horaAconteceu" th:field="*{horaAconteceu}" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('horaAconteceu')}" th:errors="*{horaAconteceu}"></div>
                        </div>
                        <div class="col-md-4">
                            <label for="dataComunicacao" class="form-label">Data da Comunicação *</label>
                            <input type="date" class="form-control" id="dataComunicacao" th:field="*{dataComunicacao}" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('dataComunicacao')}" th:errors="*{dataComunicacao}"></div>
                        </div>
                        <div class="col-md-2">
                            <label for="horaComunicacao" class="form-label">Hora *</label>
                            <input type="time" class="form-control" id="horaComunicacao" th:field="*{horaComunicacao}" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('horaComunicacao')}" th:errors="*{horaComunicacao}"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="dataVencimento" class="form-label">Data de Vencimento *</label>
                            <input type="date" class="form-control" id="dataVencimento" th:field="*{dataVencimento}" required>
                            <small class="form-text text-muted">Data limite para resolução do evento</small>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('dataVencimento')}" th:errors="*{dataVencimento}"></div>
                        </div>
                    </div>

                    <!-- Informações Adicionais -->
                    <div class="section-title">
                        <h5><i class="bi bi-card-text"></i> Informações Adicionais</h5>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="analistaResponsavel" class="form-label">Analista Responsável</label>
                            <input type="text" class="form-control" id="analistaResponsavel"
                                   th:field="*{analistaResponsavel}" placeholder="Nome do analista">
                        </div>
                        <div class="col-md-6">
                            <label for="idExterno" class="form-label">ID Externo</label>
                            <input type="number" class="form-control" id="idExterno"
                                   th:field="*{idExterno}" placeholder="ID do sistema externo">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="observacoes" class="form-label">Observações</label>
                            <textarea class="form-control" id="observacoes" th:field="*{observacoes}"
                                      rows="3" placeholder="Observações adicionais..."></textarea>
                        </div>
                    </div>

                    <!-- Botões -->
                    <div class="form-actions">
                        <a th:href="@{/events}" class="btn btn-light btn-action">
                            <i class="bi bi-arrow-left"></i>
                            <span>Voltar para lista</span>
                        </a>
                        <div class="form-actions__buttons">
                            <button type="reset" class="btn btn-outline-primary btn-action">
                                <i class="bi bi-arrow-counterclockwise"></i>
                                <span>Limpar campos</span>
                            </button>
                            <button type="submit" class="btn btn-primary btn-action btn-action--primary">
                                <i class="bi bi-save"></i>
                                <span>Salvar Evento</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<script layout:fragment="scripts">
    (function () {
        'use strict';

        const partnerSelect = document.getElementById('partner');
        const vehiclePlateInput = document.getElementById('vehiclePlate');
        const vehicleIdHidden = document.getElementById('vehicleId');
        const vehiclePlateHidden = document.getElementById('vehiclePlateHidden');
        const vehicleOptions = document.getElementById('vehicleOptions');
        const vehicleError = document.getElementById('vehicleError');
        const eventForm = document.getElementById('eventForm');

        if (!partnerSelect || !vehiclePlateInput || !vehicleOptions) {
            console.error('Campos de associado/veículo não encontrados.');
            return;
        }

        function updateVehicleOptions(vehicles) {
            vehicleOptions.innerHTML = '';
            if (Array.isArray(vehicles)) {
                vehicles.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = (v.plaque || '').toUpperCase();
                    opt.textContent = `${v.plaque} - ${v.maker ?? ''} ${v.model ?? ''}`.trim();
                    opt.dataset.id = v.id;
                    vehicleOptions.appendChild(opt);
                });
            }
        }

        function syncVehicleIdFromPlate() {
            const plate = (vehiclePlateInput.value || '').toUpperCase().trim();
            let matchedId = '';
            // Procurar o ID correspondente na datalist
            Array.from(vehicleOptions.options).forEach(opt => {
                if ((opt.value || '').toUpperCase() === plate) {
                    matchedId = opt.dataset.id || '';
                }
            });
            vehicleIdHidden.value = matchedId;
            vehiclePlateHidden.value = plate;

            // Feedback visual para o usuário
            if (plate && !matchedId) {
                vehicleError.style.display = 'block'; // Mostra erro se placa digitada não existe na lista
                vehiclePlateInput.classList.add('is-invalid');
            } else {
                vehicleError.style.display = 'none';
                vehiclePlateInput.classList.remove('is-invalid');
            }
        }

        partnerSelect.addEventListener('change', function () {
            const partnerId = this.value;

            // Limpa o campo de placa ao trocar de associado
            vehiclePlateInput.value = '';
            vehicleIdHidden.value = '';
            vehiclePlateHidden.value = '';

            if (!partnerId) {
                updateVehicleOptions([]);
                syncVehicleIdFromPlate(); // Limpa a validação
                return;
            }

            const url = `/events/api/vehicles/${partnerId}`;
            // Correção na obtenção do token CSRF
            const csrfToken = document.querySelector('input[name="_csrf"]')?.value;
            const csrfHeader = "X-CSRF-TOKEN";

            const headers = {
                'X-Requested-With': 'XMLHttpRequest'
            };
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }

            fetch(url, { headers })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erro na rede: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    updateVehicleOptions(data);
                    syncVehicleIdFromPlate(); // Sincroniza caso o campo já tenha valor
                })
                .catch(error => {
                    console.error('Erro ao buscar veículos:', error);
                    updateVehicleOptions([]);
                    syncVehicleIdFromPlate();
                });
        });

        // Eventos para sincronizar a placa com o ID
        vehiclePlateInput.addEventListener('input', syncVehicleIdFromPlate);
        vehiclePlateInput.addEventListener('change', syncVehicleIdFromPlate);
        vehiclePlateInput.addEventListener('blur', syncVehicleIdFromPlate);

        // Validação final no momento do submit
        if (eventForm) {
            eventForm.addEventListener('submit', function(e) {
                // Garante que a sincronia foi feita antes de submeter
                syncVehicleIdFromPlate();

                const hasPartnerId = (partnerSelect.value || '').trim().length > 0;
                if (!hasPartnerId) {
                    e.preventDefault();
                    partnerSelect.focus(); // Foca no campo do associado se não for selecionado
                    return;
                }

                // A placa deve ter algum valor E um ID correspondente
                const hasVehicleId = (vehicleIdHidden.value || '').trim().length > 0;
                const hasPlateValue = (vehiclePlateInput.value || '').trim().length > 0;

                if (!hasPlateValue || !hasVehicleId) {
                    e.preventDefault(); // Bloqueia o envio do formulário
                    vehicleError.style.display = 'block';
                    vehiclePlateInput.classList.add('is-invalid');
                    vehiclePlateInput.focus(); // Foca no campo da placa para correção
                } else {
                    vehicleError.style.display = 'none';
                    vehiclePlateInput.classList.remove('is-invalid');
                }
            });
        }

        // Inicialização: se já houver associado selecionado (ex.: retorno de validação), carregue as placas
        if (partnerSelect.value) {
            partnerSelect.dispatchEvent(new Event('change'));
        } else {
            updateVehicleOptions([]);
        }
    })();
</script>

</body>
</html>
