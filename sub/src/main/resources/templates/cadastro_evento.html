<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>SUB - Cadastrar Comunica√ß√£o</title>
    <link rel="stylesheet" th:href="@{/css/cadastro.css}">
    <link rel="stylesheet" th:href="@{/css/cadastro-evento.css}">
</head>
<body>

<section layout:fragment="content">
    <div class="event-form py-4">
        <div class="card shadow event-form__card">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-plus-circle"></i> Detalhes do Evento</h4>
            </div>
            <div class="card-body">
                <div class="alert alert-danger" th:if="${formError}" th:text="${formError}"></div>
                <form th:action="@{/events}" th:object="${event}" method="post" class="event-form__body" id="eventForm">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                    <!-- Informa√ß√µes B√°sicas -->
                    <div class="section-title">
                        <h5><i class="bi bi-info-circle"></i> Informa√ß√µes B√°sicas</h5>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="titulo" class="form-label">T√≠tulo *</label>
                            <input type="text" class="form-control" id="titulo" th:field="*{titulo}"
                                   placeholder="Ex: Colis√£o no estacionamento" maxlength="200" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('titulo')}" th:errors="*{titulo}"></div>
                        </div>
                        <div class="col-md-4">
                            <label for="status" class="form-label">Status *</label>
                            <select class="form-select" id="status" th:field="*{status}" required>
                                <option value="">Selecione...</option>
                                <option th:each="status : ${statusOptions}"
                                        th:value="${status}"
                                        th:text="${status.displayName}">Status</option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('status')}" th:errors="*{status}"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="descricao" class="form-label">Descri√ß√£o *</label>
                            <textarea class="form-control" id="descricao" th:field="*{descricao}"
                                      rows="4" placeholder="Descreva o que aconteceu..." required></textarea>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('descricao')}" th:errors="*{descricao}"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="prioridade" class="form-label">Prioridade</label>
                            <select class="form-select" id="prioridade" th:field="*{prioridade}">
                                <option value="">Selecione...</option>
                                <option th:each="prioridade : ${prioridadeOptions}"
                                        th:value="${prioridade}"
                                        th:text="${prioridade.displayName}">Prioridade</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="motivo" class="form-label">Motivo *</label>
                            <select class="form-select" id="motivo" th:field="*{motivo}" required>
                                <option value="">Selecione...</option>
                                <option th:each="motivo : ${motivoOptions}"
                                        th:value="${motivo}"
                                        th:text="${motivo}">Motivo</option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('motivo')}" th:errors="*{motivo}"></div>
                        </div>
                        <div class="col-md-4">
                            <label for="envolvimento" class="form-label">Envolvimento *</label>
                            <select class="form-select" id="envolvimento" th:field="*{envolvimento}" required>
                                <option value="">Selecione...</option>
                                <option th:each="envolvimento : ${envolvimentoOptions}"
                                        th:value="${envolvimento}"
                                        th:text="${envolvimento}">Envolvimento</option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('envolvimento')}" th:errors="*{envolvimento}"></div>
                        </div>
                    </div>

                    <!-- Associado e Ve√≠culo -->
                    <div class="section-title">
                        <h5><i class="bi bi-people"></i> Associado e Ve√≠culo</h5>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="partner" class="form-label">Associado *</label>
                            <select class="form-select" id="partner" th:field="*{partner.id}" required>
                                <option value="">Selecione o associado...</option>
                                <option th:each="partner : ${partners}"
                                        th:value="${partner.id}"
                                        th:text="${partner.name + ' - ' + partner.cpf}">Associado</option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('partner')}" th:errors="*{partner}"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="vehicle" class="form-label">Ve√≠culo (Placa) *</label>
                            <select class="form-select" id="vehicle" th:field="*{vehicle.id}" required>
                                <option value="">Selecione um ve√≠culo...</option>
                                <option th:each="vehicle : ${vehicles}"
                                        th:value="${vehicle.id}"
                                        th:text="${vehicle.plaque + ' - ' + vehicle.maker + ' ' + vehicle.model}"></option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('vehicle')}" th:errors="*{vehicle}"></div>
                        </div>
                    </div>

                    <!-- Datas -->
                    <div class="section-title">
                        <h5><i class="bi bi-calendar"></i> Datas e Hor√°rios</h5>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="dataAconteceu" class="form-label">Data do Ocorrido</label>
                            <input type="date" class="form-control" id="dataAconteceu" th:field="*{dataAconteceu}">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('dataAconteceu')}" th:errors="*{dataAconteceu}"></div>
                        </div>
                        <div class="col-md-2">
                            <label for="horaAconteceu" class="form-label">Hora</label>
                            <input type="time" class="form-control" id="horaAconteceu" th:field="*{horaAconteceu}">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('horaAconteceu')}" th:errors="*{horaAconteceu}"></div>
                        </div>
                        <div class="col-md-4">
                            <label for="dataComunicacao" class="form-label">Data da Comunica√ß√£o</label>
                            <input type="date" class="form-control" id="dataComunicacao" th:field="*{dataComunicacao}">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('dataComunicacao')}" th:errors="*{dataComunicacao}"></div>
                        </div>
                        <div class="col-md-2">
                            <label for="horaComunicacao" class="form-label">Hora</label>
                            <input type="time" class="form-control" id="horaComunicacao" th:field="*{horaComunicacao}">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('horaComunicacao')}" th:errors="*{horaComunicacao}"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="dataVencimento" class="form-label">Data de Vencimento</label>
                            <input type="date" class="form-control" id="dataVencimento" th:field="*{dataVencimento}">
                            <small class="form-text text-muted">Data limite para resolu√ß√£o do evento</small>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('dataVencimento')}" th:errors="*{dataVencimento}"></div>
                        </div>
                    </div>

                    <!-- Informa√ß√µes Adicionais -->
                    <div class="section-title">
                        <h5><i class="bi bi-card-text"></i> Informa√ß√µes Adicionais</h5>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="analistaResponsavel" class="form-label">Analista Respons√°vel</label>
                            <input type="text" class="form-control" id="analistaResponsavel"
                                   th:field="*{analistaResponsavel}" placeholder="Nome do analista">
                        </div>
                        <div class="col-md-6">
                            <label for="idExterno" class="form-label">ID Externo</label>
                            <input type="number" class="form-control" id="idExterno"
                                   th:field="*{idExterno}" placeholder="ID do sistema externo">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="observacoes" class="form-label">Observa√ß√µes</label>
                            <textarea class="form-control" id="observacoes" th:field="*{observacoes}"
                                      rows="3" placeholder="Observa√ß√µes adicionais..."></textarea>
                        </div>
                    </div>

                    <!-- Bot√µes -->
                    <div class="form-actions">
                        <a th:href="@{/events}" class="btn btn-light btn-action">
                            <i class="bi bi-arrow-left"></i>
                            <span>Voltar para lista</span>
                        </a>
                        <div class="form-actions__buttons">
                            <button type="reset" class="btn btn-outline-primary btn-action">
                                <i class="bi bi-arrow-counterclockwise"></i>
                                <span>Limpar campos</span>
                            </button>
                            <button type="submit" class="btn btn-primary btn-action btn-action--primary">
                                <i class="bi bi-save"></i>
                                <span>Salvar Evento</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<script layout:fragment="scripts">
    document.addEventListener('DOMContentLoaded', function () {
        'use strict';

        const partnerSelect = document.getElementById('partner');
        const vehicleSelect = document.getElementById('vehicle');

        // Pega o ID do ve√≠culo selecionado inicialmente (√∫til em caso de erro de valida√ß√£o)
        const initialVehicleId = vehicleSelect?.value || '';

        if (!partnerSelect || !vehicleSelect) {
            console.error('[EVENT FORM] Campos de associado/ve√≠culo n√£o encontrados.');
            return;
        }

        console.log('[EVENT FORM] Formul√°rio inicializado. Partner ID inicial:', partnerSelect.value, '| Vehicle ID inicial:', initialVehicleId);

        async function fetchAndPopulateVehicles(partnerId, selectedVehicleId) {
            console.log('[EVENT FORM] üöÄ Buscando ve√≠culos para o parceiro:', partnerId);

            // Desabilita o seletor de ve√≠culos enquanto carrega
            vehicleSelect.disabled = true;
            vehicleSelect.innerHTML = '<option value="">Carregando...</option>';

            if (!partnerId || partnerId === '') {
                console.log('[EVENT FORM] ‚ö†Ô∏è Nenhum parceiro selecionado. Resetando dropdown de ve√≠culos.');
                vehicleSelect.disabled = false;
                vehicleSelect.innerHTML = '<option value="">Selecione um associado primeiro</option>';
                return;
            }

            try {
                const url = `/events/api/vehicles/${partnerId}`;
                const csrfToken = document.querySelector('input[name="_csrf"]')?.value;
                const csrfHeader = "X-CSRF-TOKEN";
                const headers = {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                };

                if (csrfToken && csrfHeader) {
                    headers[csrfHeader] = csrfToken;
                }

                console.log('[EVENT FORM] üì° Fazendo requisi√ß√£o para:', url);
                console.log('[EVENT FORM] üìã Headers:', JSON.stringify(headers, null, 2));

                const response = await fetch(url, {
                    method: 'GET',
                    headers: headers,
                    credentials: 'same-origin'
                });

                console.log('[EVENT FORM] üì® Response status:', response.status);
                console.log('[EVENT FORM] ‚úÖ Response OK:', response.ok);

                if (!response.ok) {
                    throw new Error(`Erro na rede: ${response.status} ${response.statusText}`);
                }

                // Pega o texto primeiro para ver o JSON bruto
                const responseText = await response.text();
                console.log('[EVENT FORM] üìÑ Response RAW (primeiros 500 chars):', responseText.substring(0, 500));

                let vehicles;
                try {
                    vehicles = JSON.parse(responseText);
                } catch (e) {
                    console.error('[EVENT FORM] ‚ùå Erro ao fazer parse do JSON:', e);
                    console.error('[EVENT FORM] üìÑ Texto recebido:', responseText);
                    throw new Error('Resposta inv√°lida do servidor');
                }

                console.log('[EVENT FORM] üöó Ve√≠culos recebidos (array):', vehicles);
                console.log('[EVENT FORM] üìä Total de ve√≠culos:', Array.isArray(vehicles) ? vehicles.length : 'N√ÉO √â ARRAY!');

                if (vehicles && vehicles.length > 0) {
                    console.log('[EVENT FORM] üîç Primeiro ve√≠culo (exemplo completo):', JSON.stringify(vehicles[0], null, 2));
                }

                // Limpa e popula o seletor
                vehicleSelect.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = vehicles.length > 0 ? 'Selecione um ve√≠culo...' : 'Nenhum ve√≠culo cadastrado para este associado';
                vehicleSelect.appendChild(defaultOption);

                if (Array.isArray(vehicles) && vehicles.length > 0) {
                    vehicles.forEach((v, index) => {
                        console.log(`[EVENT FORM] üîß Processando ve√≠culo ${index + 1}:`, {
                            id: v.id,
                            plaque: v.plaque,
                            maker: v.maker,
                            model: v.model,
                            'typeof id': typeof v.id,
                            'typeof plaque': typeof v.plaque
                        });

                        const opt = document.createElement('option');
                        opt.value = v.id;

                        // Verifica cada propriedade individualmente e trata valores null/undefined
                        const plaqueText = (v.plaque !== null && v.plaque !== undefined) ? String(v.plaque).trim() : 'SEM PLACA';
                        const makerText = (v.maker !== null && v.maker !== undefined) ? String(v.maker).trim() : '';
                        const modelText = (v.model !== null && v.model !== undefined) ? String(v.model).trim() : '';

                        console.log(`[EVENT FORM] üìù Textos processados:`, {
                            plaqueText,
                            makerText,
                            modelText
                        });

                        // Monta o texto da op√ß√£o
                        let displayText = plaqueText;
                        if (makerText || modelText) {
                            const carInfo = [makerText, modelText].filter(Boolean).join(' ').trim();
                            if (carInfo) {
                                displayText += ' - ' + carInfo;
                            }
                        }

                        opt.textContent = displayText;
                        vehicleSelect.appendChild(opt);

                        console.log(`[EVENT FORM] ‚úÖ Ve√≠culo adicionado - ID: ${v.id} | Texto: "${opt.textContent}"`);
                    });

                    console.log(`[EVENT FORM] üéâ Total de ${vehicles.length} ve√≠culos adicionados ao dropdown com sucesso!`);
                } else {
                    console.warn('[EVENT FORM] ‚ö†Ô∏è Nenhum ve√≠culo encontrado para o parceiro:', partnerId);
                }

                // Se um ID de ve√≠culo foi passado (ex: na carga inicial com erro), seleciona-o
                if (selectedVehicleId) {
                    vehicleSelect.value = selectedVehicleId;
                    console.log('[EVENT FORM] üéØ Ve√≠culo pr√©-selecionado:', selectedVehicleId);
                }

            } catch (error) {
                console.error('[EVENT FORM] ‚ùå ERRO ao buscar ve√≠culos:', error);
                console.error('[EVENT FORM] üìç Stack trace:', error.stack);

                vehicleSelect.innerHTML = '<option value="">Erro ao carregar ve√≠culos</option>';

                // Mostra alerta visual para o usu√°rio
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-2';
                alertDiv.setAttribute('role', 'alert');
                alertDiv.innerHTML = `
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>Erro ao carregar ve√≠culos:</strong> ${error.message}
                    <br><small>Verifique o console do navegador (F12) para mais detalhes.</small>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;

                const vehicleContainer = vehicleSelect.parentElement;
                const existingAlert = vehicleContainer.querySelector('.alert');
                if (existingAlert) {
                    existingAlert.remove();
                }
                vehicleContainer.appendChild(alertDiv);

                // Remove o alerta ap√≥s 8 segundos
                setTimeout(() => alertDiv.remove(), 8000);
            } finally {
                // Reabilita o seletor
                vehicleSelect.disabled = false;
                console.log('[EVENT FORM] üîì Dropdown de ve√≠culos reabilitado');
            }
        }

        // Adiciona o listener para o evento 'change' com log
        partnerSelect.addEventListener('change', function (event) {
            console.log('[EVENT FORM] Evento change disparado. Novo valor:', this.value);
            fetchAndPopulateVehicles(this.value, null);
        });

        // Tamb√©m adiciona listener para 'input' como fallback
        partnerSelect.addEventListener('input', function (event) {
            console.log('[EVENT FORM] Evento input disparado. Novo valor:', this.value);
        });

        // Execu√ß√£o inicial ao carregar a p√°gina
        // Isso garante que se um parceiro j√° estiver selecionado (ex: formul√°rio com erro),
        // a lista de ve√≠culos seja carregada e o ve√≠culo correto seja selecionado.
        console.log('[EVENT FORM] Verificando se h√° parceiro pr√©-selecionado...');
        if (partnerSelect.value && partnerSelect.value !== '') {
            console.log('[EVENT FORM] Parceiro pr√©-selecionado detectado:', partnerSelect.value);
            fetchAndPopulateVehicles(partnerSelect.value, initialVehicleId);
        } else {
            console.log('[EVENT FORM] Nenhum parceiro pr√©-selecionado');
            vehicleSelect.disabled = false;
            vehicleSelect.innerHTML = '<option value="">Selecione um associado primeiro</option>';
        }

        // Log quando o formul√°rio √© submetido
        const form = document.getElementById('eventForm');
        if (form) {
            form.addEventListener('submit', function(event) {
                console.log('[EVENT FORM] Formul√°rio sendo enviado...');
                console.log('[EVENT FORM] Parceiro selecionado:', partnerSelect.value);
                console.log('[EVENT FORM] Ve√≠culo selecionado:', vehicleSelect.value);

                if (!vehicleSelect.value || vehicleSelect.value === '') {
                    console.error('[EVENT FORM] ERRO: Nenhum ve√≠culo selecionado!');
                }
            });
        }
    });
</script>

</body>
</html>
