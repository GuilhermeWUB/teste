<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>SUB - Atualizar Veículo</title>
</head>
<body>

<section layout:fragment="content">
    <h1 class="mb-4">Atualizar Veículo</h1>
    <form th:action="@{/vehicles/update/{id}(id=${vehicle.id})}" th:object="${vehicle}" method="post" enctype="multipart/form-data" class="row g-3">
        <input type="hidden" th:field="*{id}" />
        <input type="hidden" th:field="*{payment.id}" />

        <!-- Campos da Tabela FIPE -->
        <div class="col-md-4">
            <label for="codigo_fipe" class="form-label">Código Fipe</label>
            <input type="text" id="codigo_fipe" class="form-control" th:field="*{codigo_fipe}" placeholder="Ex: 001004-9" />
            <small class="form-text text-muted">Digite o código e pressione TAB para buscar automaticamente</small>
        </div>
        <div class="col-md-4">
            <label for="fipe_value" class="form-label">Valor Tabela Fipe</label>
            <input type="text" id="fipe_value" class="form-control" th:field="*{fipe_value}" />
        </div>
        <div class="col-md-4">
            <label for="type_vehicle" class="form-label">Tipo</label>
            <select id="type_vehicle" class="form-select" th:field="*{type_vehicle}">
                <option value="">Selecione o tipo</option>
                <option value="Carro">Carro</option>
                <option value="Moto">Moto</option>
                <option value="Caminhão">Caminhão</option>
                <option value="Ônibus">Ônibus</option>
                <option value="Micro-ônibus">Micro-ônibus</option>
            </select>
        </div>

        <hr class="my-3" />

        <div class="col-md-6">
            <label for="maker" class="form-label">Montadora</label>
            <input type="text" id="maker" class="form-control" th:field="*{maker}" />
            <div class="text-danger" th:if="${#fields.hasErrors('maker')}" th:errors="*{maker}"></div>
        </div>
        <div class="col-md-6">
            <label for="model" class="form-label">Modelo</label>
            <input type="text" id="model" class="form-control" th:field="*{model}" />
            <div class="text-danger" th:if="${#fields.hasErrors('model')}" th:errors="*{model}"></div>
        </div>
        <div class="col-md-4">
            <label for="plaque" class="form-label">Placa</label>
            <input type="text" id="plaque" class="form-control" th:field="*{plaque}" />
            <div class="text-danger" th:if="${#fields.hasErrors('plaque')}" th:errors="*{plaque}"></div>
        </div>
        <div class="col-md-4">
            <label for="color" class="form-label">Cor</label>
            <input type="text" id="color" class="form-control" th:field="*{color}" />
            <div class="text-danger" th:if="${#fields.hasErrors('color')}" th:errors="*{color}"></div>
        </div>
        <div class="col-md-4">
            <label for="year_mod" class="form-label">Ano/Modelo</label>
            <input type="text" id="year_mod" class="form-control" th:field="*{year_mod}" />
            <div class="text-danger" th:if="${#fields.hasErrors('year_mod')}" th:errors="*{year_mod}"></div>
        </div>
        <div class="col-md-6">
            <label for="tipo_combustivel" class="form-label">Tipo de combustível</label>
            <input type="text" id="tipo_combustivel" class="form-control" th:field="*{tipo_combustivel}" />
            <div class="text-danger" th:if="${#fields.hasErrors('tipo_combustivel')}" th:errors="*{tipo_combustivel}"></div>
        </div>
        <div class="col-md-6">
            <label for="partner" class="form-label">Associado</label>
            <select id="partner" class="form-select" th:field="*{partnerId}">
                <option value="" disabled>Selecione</option>
                <option th:each="partner : ${partners}" th:value="${partner.id}" th:text="${partner.name}"></option>
            </select>
            <div class="text-danger" th:if="${#fields.hasErrors('partnerId')}" th:errors="*{partnerId}"></div>
        </div>
        <div class="col-md-6">
            <label for="monthly" class="form-label">Mensalidade</label>
            <input type="number" step="0.01" id="monthly" class="form-control" th:field="*{payment.monthly}" />
            <div class="text-danger" th:if="${#fields.hasErrors('payment.monthly')}" th:errors="*{payment.monthly}"></div>
        </div>
        <div class="col-md-6">
            <label for="vencimento" class="form-label">Dia do vencimento</label>
            <input type="number" min="1" max="31" id="vencimento" class="form-control" th:field="*{payment.vencimento}" />
            <div class="text-danger" th:if="${#fields.hasErrors('payment.vencimento')}" th:errors="*{payment.vencimento}"></div>
        </div>

        <h2 class="mt-4 h5">Situação e Documentação</h2>
        <div class="col-md-12">
            <label for="vehicleStatus" class="form-label">Situação do Veículo</label>
            <select id="vehicleStatus" class="form-select" th:field="*{vehicleStatus}">
                <option value="">Selecione uma situação</option>
                <option th:each="statusOption : ${T(com.necsus.necsusspring.model.VehicleStatus).values()}"
                        th:value="${statusOption}"
                        th:text="${statusOption.displayName}"
                        th:selected="${statusOption == vehicleStatus}">
                </option>
            </select>
        </div>
        <div class="col-md-6">
            <label for="inspectionPhotos" class="form-label">Adicionar Fotos de Inspeção</label>
            <input type="file" id="inspectionPhotos" class="form-control" name="inspectionPhotos" multiple accept="image/*" />
            <small class="form-text text-muted">Selecione novas fotos para adicionar às existentes</small>
        </div>
        <div class="col-md-6">
            <label for="documentPhotos" class="form-label">Adicionar Fotos da Documentação</label>
            <input type="file" id="documentPhotos" class="form-control" name="documentPhotos" multiple accept="image/*,application/pdf" />
            <small class="form-text text-muted">Selecione novos arquivos para adicionar aos existentes</small>
        </div>

        <div class="col-md-6" th:if="${vehicle.inspectionPhotoPaths != null and !#lists.isEmpty(vehicle.inspectionPhotoPaths)}">
            <label class="form-label">Fotos de Inspeção Existentes</label>
            <ul class="list-group">
                <li class="list-group-item d-flex justify-content-between align-items-center" th:each="photo : ${vehicle.inspectionPhotoPaths}">
                    <span th:text="${photo.contains('/') ? photo.substring(photo.lastIndexOf('/') + 1) : photo}">foto.jpg</span>
                    <a th:href="@{/uploads/{filename}(filename=${photo.contains('/') ? photo.substring(photo.lastIndexOf('/') + 1) : photo})}" class="btn btn-sm btn-primary" target="_blank">Ver</a>
                </li>
            </ul>
        </div>
        <div class="col-md-6" th:if="${vehicle.documentPhotoPaths != null and !#lists.isEmpty(vehicle.documentPhotoPaths)}">
            <label class="form-label">Fotos de Documentação Existentes</label>
            <ul class="list-group">
                <li class="list-group-item d-flex justify-content-between align-items-center" th:each="doc : ${vehicle.documentPhotoPaths}">
                    <span th:text="${doc.contains('/') ? doc.substring(doc.lastIndexOf('/') + 1) : doc}">documento.pdf</span>
                    <a th:href="@{/uploads/{filename}(filename=${doc.contains('/') ? doc.substring(doc.lastIndexOf('/') + 1) : doc})}" class="btn btn-sm btn-primary" target="_blank">Ver</a>
                </li>
            </ul>
        </div>

        <div class="col-12 d-flex gap-2">
            <button type="submit" class="btn btn-primary">Salvar alterações</button>
            <a th:href="${partnerId != null} ? @{/vehicles(partnerId=${partnerId})} : @{/vehicles}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</section>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {
        const codigoFipeInput = document.getElementById('codigo_fipe');
        const fipeValueInput = document.getElementById('fipe_value');
        const makerInput = document.getElementById('maker');
        const modelInput = document.getElementById('model');
        const yearModInput = document.getElementById('year_mod');
        const tipoCombustivelInput = document.getElementById('tipo_combustivel');
        const typeVehicleSelect = document.getElementById('type_vehicle');

        if (!codigoFipeInput || !fipeValueInput) {
            console.error('Campos obrigatórios para consulta da Fipe não encontrados.');
            return;
        }

        let timeoutId;

        codigoFipeInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                buscarDadosFipe();
            }
        });

        codigoFipeInput.addEventListener('input', () => {
            clearTimeout(timeoutId);
            const codigo = codigoFipeInput.value.trim();
            if (codigo.length >= 7) {
                timeoutId = setTimeout(buscarDadosFipe, 1500);
            }
        });

        codigoFipeInput.addEventListener('blur', () => {
            clearTimeout(timeoutId);
            if (codigoFipeInput.value.trim().length >= 7) {
                buscarDadosFipe();
            }
        });

        function buscarDadosFipe() {
            const codigoFipe = codigoFipeInput.value.trim();

            if (!codigoFipe || codigoFipe.length < 7) {
                return;
            }

            const valorAnterior = fipeValueInput.value;
            definirEstadoCarregamento(true, valorAnterior);

            fetch(`/vehicles/fipe?codigoFipe=${encodeURIComponent(codigoFipe)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Dados não encontrados');
                    }
                    return response.json();
                })
                .then(data => {
                    aplicarDadosFipe(data);
                    definirEstadoCarregamento(false);
                    mostrarMensagem('Dados da Fipe carregados com sucesso!', 'success');
                })
                .catch(error => {
                    console.error('Erro ao buscar dados Fipe:', error);
                    const anterior = fipeValueInput.dataset.previousValue ?? valorAnterior;
                    definirEstadoCarregamento(false, anterior);
                    mostrarMensagem('Não foi possível buscar os dados da Fipe. Verifique o código informado.', 'warning');
                });
        }

        function aplicarDadosFipe(data) {
            if (!data) {
                return;
            }

            if (data.brand) makerInput.value = data.brand;
            if (data.fuel) tipoCombustivelInput.value = data.fuel;
            if (data.model) modelInput.value = data.model;
            if (data.modelYear) yearModInput.value = data.modelYear;

            if (data.price) {
                const normalizado = normalizarValorMonetario(data.price);
                fipeValueInput.value = normalizado || data.price;
            }

            if (typeVehicleSelect && data.vehicleType) {
                const tipo = mapearTipoVeiculo(data.vehicleType);
                if (tipo) {
                    typeVehicleSelect.value = tipo;
                }
            }
        }

        function definirEstadoCarregamento(emCarregamento, valorParaRestaurar) {
            if (emCarregamento) {
                fipeValueInput.dataset.previousValue = valorParaRestaurar ?? fipeValueInput.value;
                fipeValueInput.value = 'Buscando...';
                fipeValueInput.disabled = true;
                return;
            }

            fipeValueInput.disabled = false;
            if (typeof valorParaRestaurar === 'string') {
                fipeValueInput.value = valorParaRestaurar;
            }
            delete fipeValueInput.dataset.previousValue;
        }

        function normalizarValorMonetario(valor) {
            if (typeof valor !== 'string') {
                return '';
            }

            const somenteNumeros = valor
                .replace(/[^0-9,.-]/g, '')
                .replace(/\.(?=\d{3})/g, '')
                .replace(',', '.');

            const numero = Number.parseFloat(somenteNumeros);
            if (Number.isNaN(numero)) {
                return '';
            }

            return numero.toFixed(2);
        }

        function mapearTipoVeiculo(codigoTipo) {
            const mapa = {
                1: 'Carro',
                2: 'Moto',
                3: 'Caminhão',
                4: 'Ônibus',
                5: 'Micro-ônibus'
            };

            const tipo = mapa[codigoTipo];
            if (!tipo || !typeVehicleSelect) {
                return '';
            }

            const existeNoSelect = Array.from(typeVehicleSelect.options)
                .some(option => option.value === tipo);

            return existeNoSelect ? tipo : '';
        }

        function mostrarMensagem(mensagem, tipo) {
            const alertasAntigos = document.querySelectorAll('.alert-fipe');
            alertasAntigos.forEach(alerta => alerta.remove());

            const alerta = document.createElement('div');
            alerta.className = `alert alert-${tipo} alert-dismissible fade show alert-fipe`;
            alerta.setAttribute('role', 'alert');
            alerta.innerHTML = `
                ${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;

            const form = document.querySelector('form');
            form.insertBefore(alerta, form.firstChild);

            setTimeout(() => {
                alerta.remove();
            }, 5000);
        }
    });
</script>

</body>
</html>
