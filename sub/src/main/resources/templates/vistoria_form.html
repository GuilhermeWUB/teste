<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>SUB - Vistoria do Acidente</title>
    <style>
        .foto-preview {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }
        .foto-container {
            position: relative;
            display: inline-block;
        }
        .foto-container .btn-remove-foto {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .foto-container .btn-remove-foto:hover {
            background-color: rgba(220, 53, 69, 1);
        }
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #0d6efd;
            background-color: #e7f1ff;
        }
        .upload-area.drag-over {
            border-color: #0d6efd;
            background-color: #cfe2ff;
        }
    </style>
</head>
<body>
<section layout:fragment="content">
    <div class="mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/comunicados}">Comunicados</a></li>
                <li class="breadcrumb-item"><a th:href="@{/vistorias}">Vistorias</a></li>
                <li class="breadcrumb-item active" aria-current="page">Enviar Fotos</li>
            </ol>
        </nav>
    </div>

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
        <div>
            <h1 class="mb-0">Vistoria do Acidente</h1>
            <p class="text-muted mb-0">Envie fotos do acidente para análise</p>
        </div>
    </div>

    <!-- Mensagens de sucesso/erro -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Informações do Evento -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-file-text me-2"></i>Informações do Comunicado</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-2">
                    <strong>Título:</strong>
                    <span th:text="${event.titulo}">-</span>
                </div>
                <div class="col-md-6 mb-2">
                    <strong>Status:</strong>
                    <span class="badge bg-warning text-dark" th:text="${event.statusFormatted}">-</span>
                </div>
                <div class="col-md-6 mb-2">
                    <strong>Motivo:</strong>
                    <span th:text="${event.motivo}">-</span>
                </div>
                <div class="col-md-6 mb-2">
                    <strong>Data do Ocorrido:</strong>
                    <span th:text="${event.dataAconteceu != null ? #temporals.format(event.dataAconteceu, 'dd/MM/yyyy') : '-'}">-</span>
                </div>
                <div class="col-12 mb-2">
                    <strong>Descrição:</strong>
                    <p class="mb-0" th:text="${event.descricao}">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulário de Upload de Fotos -->
    <div class="card shadow-sm">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="bi bi-camera-fill me-2"></i>Fotos da Vistoria</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info" role="alert">
                <i class="bi bi-info-circle-fill me-2"></i>
                <strong>Dicas para as fotos:</strong>
                <ul class="mb-0 mt-2">
                    <li>Tire fotos claras dos danos causados no acidente</li>
                    <li>Fotografe diferentes ângulos do veículo</li>
                    <li>Inclua fotos da placa do veículo</li>
                    <li>Se houver outros veículos envolvidos, fotografe-os também</li>
                    <li>Você pode enviar quantas fotos quiser</li>
                    <li>Formatos aceitos: JPG, JPEG, PNG</li>
                </ul>
            </div>

            <form th:action="@{/vistorias/salvar}" method="post" enctype="multipart/form-data" id="formVistoria">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" name="eventId" th:value="${event.id}" />
                <input type="hidden" name="vistoriaId" th:value="${vistoria.id}" />

                <!-- Fotos já enviadas (se existirem) -->
                <div th:if="${vistoria.id != null and vistoria.fotos != null and !vistoria.fotos.isEmpty()}" class="mb-4">
                    <h6 class="fw-semibold mb-3">Fotos já enviadas (<span th:text="${vistoria.fotos.size()}">0</span>):</h6>
                    <div class="row g-3">
                        <div th:each="foto : ${vistoria.fotos}" class="col-6 col-md-4 col-lg-3">
                            <div class="foto-container">
                                <img th:src="@{/vistorias/{vistoriaId}/download/{fotoId}(vistoriaId=${vistoria.id},fotoId=${foto.id})}"
                                     class="foto-preview img-thumbnail"
                                     th:alt="'Foto ' + ${foto.ordem}">
                                <div class="mt-1 text-center">
                                    <small class="text-muted" th:text="'Foto ' + ${foto.ordem}">Foto</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr class="my-4">
                </div>

                <!-- Upload de novas fotos -->
                <h6 class="fw-semibold mb-3">
                    <span th:if="${vistoria.id != null}">Adicionar novas fotos:</span>
                </h6>

                <!-- Campos específicos para fotos dos pneus -->
                <div class="mb-4">
                    <div class="d-flex align-items-center justify-content-between mb-1">
                        <h6 class="fw-semibold mb-0">Fotos dos pneus:</h6>
                        <small class="text-muted">Clique no <i class="bi bi-question-circle-fill"></i> para ver um exemplo</small>
                    </div>
                    <hr class="mt-2 mb-3">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center justify-content-between mb-1">
                                <label for="pneuDianteiroDireito" class="form-label mb-0">Pneu dianteiro direito</label>
                                <button type="button"
                                        class="btn btn-link p-0 text-decoration-none text-primary"
                                        aria-label="Ver exemplo do pneu dianteiro direito"
                                        data-bs-toggle="modal"
                                        data-bs-target="#pneuExampleModal"
                                        th:attr="data-pneu-title='Pneu dianteiro direito', data-pneu-img=@{/images/pneu-dianteiro-direito.svg}">
                                    <i class="bi bi-question-circle-fill fs-5"></i>
                                </button>
                            </div>
                            <input type="file" class="form-control" id="pneuDianteiroDireito" name="pneuDianteiroDireito"
                                   accept="image/jpeg,image/jpg,image/png">
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center justify-content-between mb-1">
                                <label for="pneuDianteiroEsquerdo" class="form-label mb-0">Pneu dianteiro esquerdo</label>
                                <button type="button"
                                        class="btn btn-link p-0 text-decoration-none text-primary"
                                        aria-label="Ver exemplo do pneu dianteiro esquerdo"
                                        data-bs-toggle="modal"
                                        data-bs-target="#pneuExampleModal"
                                        th:attr="data-pneu-title='Pneu dianteiro esquerdo', data-pneu-img=@{/images/pneu-dianteiro-esquerdo.svg}">
                                    <i class="bi bi-question-circle-fill fs-5"></i>
                                </button>
                            </div>
                            <input type="file" class="form-control" id="pneuDianteiroEsquerdo" name="pneuDianteiroEsquerdo"
                                   accept="image/jpeg,image/jpg,image/png">
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center justify-content-between mb-1">
                                <label for="pneuTraseiroDireito" class="form-label mb-0">Pneu traseiro direito</label>
                                <button type="button"
                                        class="btn btn-link p-0 text-decoration-none text-primary"
                                        aria-label="Ver exemplo do pneu traseiro direito"
                                        data-bs-toggle="modal"
                                        data-bs-target="#pneuExampleModal"
                                        th:attr="data-pneu-title='Pneu traseiro direito', data-pneu-img=@{/images/pneu-traseiro-direito.svg}">
                                    <i class="bi bi-question-circle-fill fs-5"></i>
                                </button>
                            </div>
                            <input type="file" class="form-control" id="pneuTraseiroDireito" name="pneuTraseiroDireito"
                                   accept="image/jpeg,image/jpg,image/png">
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center justify-content-between mb-1">
                                <label for="pneuTraseiroEsquerdo" class="form-label mb-0">Pneu traseiro esquerdo</label>
                                <button type="button"
                                        class="btn btn-link p-0 text-decoration-none text-primary"
                                        aria-label="Ver exemplo do pneu traseiro esquerdo"
                                        data-bs-toggle="modal"
                                        data-bs-target="#pneuExampleModal"
                                        th:attr="data-pneu-title='Pneu traseiro esquerdo', data-pneu-img=@{/images/pneu-traseiro-esquerdo.svg}">
                                    <i class="bi bi-question-circle-fill fs-5"></i>
                                </button>
                            </div>
                            <input type="file" class="form-control" id="pneuTraseiroEsquerdo" name="pneuTraseiroEsquerdo"
                                   accept="image/jpeg,image/jpg,image/png">
                        </div>
                    </div>
                </div>

                <!-- Área de upload múltiplo -->
                <h6 class="fw-semibold mb-2">Fotos do acidente:</h6>
                <div class="upload-area mb-3" id="uploadArea">
                    <i class="bi bi-cloud-upload fs-1 text-primary"></i>
                    <p class="mb-2 mt-2"><strong>Clique para selecionar fotos</strong> ou arraste e solte aqui</p>
                    <p class="text-muted small mb-0">Você pode selecionar múltiplas fotos de uma vez</p>
                    <input type="file" class="d-none" id="fotosInput" name="fotos" multiple
                           accept="image/jpeg,image/jpg,image/png">
                </div>

                <!-- Preview das fotos selecionadas -->
                <div id="fotosPreview" class="row g-3 mb-3"></div>
                <div id="fotoCount" class="text-muted small mb-3"></div>

                <!-- Observações -->
                <div class="mt-4">
                    <label for="observacoes" class="form-label">Observações (opcional)</label>
                    <textarea class="form-control" id="observacoes" name="observacoes" rows="3"
                              th:text="${vistoria.observacoes}"
                              placeholder="Adicione informações adicionais sobre as fotos..."></textarea>
                </div>

                <!-- Botões -->
                <div class="mt-4 d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>Salvar Fotos
                    </button>
                    <a th:href="@{/vistorias}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left me-1"></i>Voltar
                    </a>
                </div>
            </form>
        </div>
    </div>
</section>

<!-- Modal com exemplos de fotos dos pneus -->
<div class="modal fade" id="pneuExampleModal" tabindex="-1" aria-labelledby="pneuExampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="pneuExampleModalLabel">Exemplo de foto do pneu</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body text-center">
                <img id="pneuExampleImage" th:src="@{/images/pneu-dianteiro-direito.svg}" alt="Exemplo de foto do pneu"
                     class="img-fluid rounded shadow-sm">
                <p class="text-muted small mt-3 mb-0" id="pneuExampleDescription">
                    Use o exemplo para enquadrar corretamente o pneu solicitado.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Script para preview das fotos -->
<th:block layout:fragment="scripts">
    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fotosInput = document.getElementById('fotosInput');
        const fotosPreview = document.getElementById('fotosPreview');
        const fotoCount = document.getElementById('fotoCount');

        // Clique na área de upload
        uploadArea.addEventListener('click', () => {
            fotosInput.click();
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');

            const files = e.dataTransfer.files;
            fotosInput.files = files;
            previewFotos(files);
        });

        // Seleção de arquivos
        fotosInput.addEventListener('change', (e) => {
            previewFotos(e.target.files);
        });

        function previewFotos(files) {
            fotosPreview.innerHTML = '';

            if (files.length === 0) {
                fotoCount.textContent = '';
                return;
            }

            fotoCount.textContent = `${files.length} foto(s) selecionada(s)`;

            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();

                reader.onload = function(e) {
                    const col = document.createElement('div');
                    col.className = 'col-6 col-md-4 col-lg-3';

                    const container = document.createElement('div');
                    container.className = 'foto-container';

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'foto-preview img-thumbnail';
                    img.alt = `Foto ${index + 1}`;

                    const btnRemove = document.createElement('button');
                    btnRemove.type = 'button';
                    btnRemove.className = 'btn-remove-foto';
                    btnRemove.innerHTML = '<i class="bi bi-x"></i>';
                    btnRemove.title = 'Remover foto';
                    btnRemove.onclick = function() {
                        removeFile(index);
                    };

                    const label = document.createElement('div');
                    label.className = 'mt-1 text-center';
                    label.innerHTML = `<small class="text-muted">Foto ${index + 1}</small>`;

                    container.appendChild(img);
                    container.appendChild(btnRemove);
                    col.appendChild(container);
                    col.appendChild(label);
                    fotosPreview.appendChild(col);
                };

                reader.readAsDataURL(file);
            });
        }

        function removeFile(index) {
            const dt = new DataTransfer();
            const files = fotosInput.files;

            for (let i = 0; i < files.length; i++) {
                if (i !== index) {
                    dt.items.add(files[i]);
                }
            }

            fotosInput.files = dt.files;
            previewFotos(fotosInput.files);
        }

        // Validação antes de enviar o formulário
        document.getElementById('formVistoria').addEventListener('submit', function(e) {
            const vistoriaId = document.querySelector('input[name="vistoriaId"]').value;
            const hasFiles = fotosInput.files && fotosInput.files.length > 0;

            // Se não tem nenhuma foto nova e não é atualização, mostra alerta
            if (!hasFiles && !vistoriaId) {
                e.preventDefault();
                alert('Por favor, selecione pelo menos uma foto para enviar.');
                return false;
            }
        });

        const pneuExampleModal = document.getElementById('pneuExampleModal');
        if (pneuExampleModal) {
            pneuExampleModal.addEventListener('show.bs.modal', (event) => {
                const button = event.relatedTarget;
                if (!button) {
                    return;
                }

                const pneuTitle = button.getAttribute('data-pneu-title') || 'Pneu';
                const pneuImage = button.getAttribute('data-pneu-img');
                const modalTitle = document.getElementById('pneuExampleModalLabel');
                const modalDescription = document.getElementById('pneuExampleDescription');
                const modalImage = document.getElementById('pneuExampleImage');

                if (modalTitle) {
                    modalTitle.textContent = `Exemplo - ${pneuTitle}`;
                }

                if (modalDescription) {
                    modalDescription.textContent = `Observe como enquadrar o ${pneuTitle.toLowerCase()}.`;
                }

                if (modalImage && pneuImage) {
                    modalImage.src = pneuImage;
                    modalImage.alt = `Exemplo de ${pneuTitle}`;
                }
            });
        }
    </script>
</th:block>
</body>
</html>
