<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Visualização de Venda</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .gabiii-container {
            display: flex;
            flex-direction: column;
            padding: 20px;
            background: #e5e7eb;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
        }

        .gabiii-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .gabiii-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #111827;
        }

        .gabiii-id {
            padding: 8px 16px;
            background: #f3f4f6;
            border-radius: 8px;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .gabiii-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #d1d5db;
            background: transparent;
        }

        .gabiii-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: #9ca3af;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .gabiii-tab:hover {
            color: #6b7280;
        }

        .gabiii-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .gabiii-content {
            display: flex;
            gap: 20px;
        }

        .gabiii-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .gabiii-tab-content {
            display: none;
        }

        .gabiii-tab-content.active {
            display: block;
        }

        .gabiii-sidebar {
            width: 280px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .gabiii-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .gabiii-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .gabiii-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
        }

        .gabiii-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .gabiii-btn-primary {
            background: #3b82f6;
            color: white;
        }

        .gabiii-btn-primary:hover {
            background: #2563eb;
        }

        .gabiii-btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .gabiii-btn-secondary:hover {
            background: #d1d5db;
        }

        .gabiii-btn-success {
            background: #10b981;
            color: white;
            width: 100%;
        }

        .gabiii-btn-success:hover {
            background: #059669;
        }

        .gabiii-form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .gabiii-form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .gabiii-form-group.full {
            grid-column: 1 / -1;
        }

        .gabiii-form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        .gabiii-form-input,
        .gabiii-form-select,
        .gabiii-form-textarea {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .gabiii-form-input:focus,
        .gabiii-form-select:focus,
        .gabiii-form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .gabiii-info-value {
            font-size: 0.875rem;
            font-weight: 500;
            color: #111827;
            margin-bottom: 10px;
        }

        .gabiii-highlight-card {
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
            border-left: 4px solid #3b82f6;
        }

        .gabiii-muted {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 5px;
        }

        .gabiii-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #4b5563;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .gabiii-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            background: #fef3c7;
            color: #d97706;
        }

        .gabiii-info-label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .gabiii-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .gabiii-empty-icon {
            font-size: 3rem;
            color: #9ca3af;
            margin-bottom: 15px;
        }

        .gabiii-empty-text {
            font-size: 1rem;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .gabiii-section {
            margin-bottom: 20px;
        }

        .gabiii-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
        }

        .gabiii-tag {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .gabiii-tag-blue {
            background: #dbeafe;
            color: #1e40af;
        }

        .gabiii-tag-green {
            background: #d1fae5;
            color: #065f46;
        }

        .gabiii-btn-link {
            background: none;
            border: none;
            color: #3b82f6;
            cursor: pointer;
            font-size: 0.875rem;
            padding: 0;
            text-decoration: underline;
        }

        .gabiii-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .gabiii-form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .gabiii-tabs-secondary {
            display: flex;
            gap: 0;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }

        .gabiii-tab-secondary {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: #6b7280;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .gabiii-tab-secondary.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
    </style>
</head>
<body>
    <div class="gabiii-container">
        <div class="gabiii-header">
            <h1 class="gabiii-title">Não Definido</h1>
            <div class="gabiii-id" th:text="'ID: ' + ${vendaId}">ID: g£60kJ8Zo4</div>
        </div>

        <div class="gabiii-tabs">
            <button class="gabiii-tab active" data-tab="atividades" type="button">Atividades</button>
            <button class="gabiii-tab" data-tab="associado" type="button">Associado</button>
            <button class="gabiii-tab" data-tab="cotacoes" type="button">Cotações</button>
            <button class="gabiii-tab" data-tab="vistoria" type="button">Vistoria</button>
            <button class="gabiii-tab" data-tab="powersign" type="button">PowerSign</button>
        </div>

        <div class="gabiii-content">
            <div class="gabiii-main">

                <!-- ABA ATIVIDADES -->
                <div class="gabiii-tab-content active" data-content="atividades">
                    <div class="gabiii-tabs-secondary">
                        <button class="gabiii-tab-secondary active" type="button">Atividades</button>
                        <button class="gabiii-tab-secondary" type="button">Anotações</button>
                        <button class="gabiii-tab-secondary" type="button">Anexos</button>
                    </div>

                    <div class="gabiii-card">
                        <div class="gabiii-section-title">Atividade</div>

                        <div class="gabiii-form-grid">
                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Atividade*</label>
                                <select class="gabiii-form-select" id="activity-type">
                                    <option value="LIGACAO">Ligar</option>
                                    <option value="EMAIL">Email</option>
                                    <option value="REUNIAO">Reunião</option>
                                    <option value="VISITA">Visita</option>
                                    <option value="FOLLOW_UP">Follow-up</option>
                                    <option value="APRESENTACAO">Apresentação</option>
                                    <option value="NEGOCIACAO">Negociação</option>
                                    <option value="VISTORIA">Vistoria</option>
                                    <option value="OUTRO">Outro</option>
                                </select>
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Responsável*</label>
                                <input type="text" class="gabiii-form-input" id="activity-responsavel" placeholder="Nome do responsável">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Quando*</label>
                                <input type="datetime-local" class="gabiii-form-input" id="activity-when">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Cliente*</label>
                                <input type="text" class="gabiii-form-input" id="activity-cliente" placeholder="Nome do cliente">
                            </div>
                        </div>

                        <div class="gabiii-form-actions">
                            <button class="gabiii-btn gabiii-btn-primary" type="button" onclick="salvarAtividade()">Salvar</button>
                        </div>
                    </div>

                    <div class="gabiii-card">
                        <div class="gabiii-section-title">Atividades</div>
                        <div id="activities-list">
                            <div class="gabiii-empty-state">
                                <i class="bi bi-calendar-x gabiii-empty-icon"></i>
                                <p class="gabiii-empty-text">Sem atividades nesta negociação.</p>
                            </div>
                        </div>
                    </div>

                    <div class="gabiii-card">
                        <div class="gabiii-section-title">Histórico</div>
                        <div class="gabiii-section">
                            <div style="display: flex; gap: 10px; align-items: start; margin-bottom: 15px;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: #ef4444; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-megaphone" style="color: white;"></i>
                                </div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 500; color: #111827; margin-bottom: 3px;">Marketing Up atribuiu a negociação para VINICIUS RIAN SOARES</p>
                                    <p style="font-size: 0.75rem; color: #6b7280;">25/11/2025 - 13:27</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: start;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: #9ca3af; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-globe" style="color: white;"></i>
                                </div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 500; color: #111827; margin-bottom: 3px;">Negociação criada pelo site</p>
                                    <p style="font-size: 0.75rem; color: #6b7280;">25/11/2025 - 12:17</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="gabiii-card">
                        <div class="gabiii-tabs-secondary">
                            <button class="gabiii-tab-secondary active" type="button">Geral</button>
                            <button class="gabiii-tab-secondary" type="button">Cotação</button>
                        </div>
                        <p class="gabiii-muted">Informações adicionais sobre a negociação</p>
                    </div>
                </div>

                <!-- ABA ASSOCIADO -->
                <div class="gabiii-tab-content" data-content="associado">
                    <div class="gabiii-card">
                        <div class="gabiii-card-header">
                            <div class="gabiii-section-title">Associado</div>
                            <button class="gabiii-btn gabiii-btn-primary" type="button">Consultar no SGA</button>
                        </div>

                        <div class="gabiii-form-grid">
                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Nome Completo</label>
                                <input type="text" class="gabiii-form-input" placeholder="Gabiii">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">CPF/CNPJ</label>
                                <input type="text" class="gabiii-form-input">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">RG</label>
                                <input type="text" class="gabiii-form-input">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Órgão Expedidor</label>
                                <input type="text" class="gabiii-form-input">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Data Expedição</label>
                                <input type="text" class="gabiii-form-input" placeholder="__/__/____">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">CNH</label>
                                <input type="text" class="gabiii-form-input">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Categoria</label>
                                <select class="gabiii-form-select">
                                    <option value="">Selecione</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="AB">AB</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                    <option value="E">E</option>
                                </select>
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Data Validade CNH</label>
                                <input type="text" class="gabiii-form-input" placeholder="__/__/____">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Data Nascimento</label>
                                <input type="text" class="gabiii-form-input" placeholder="__/__/____">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Sexo</label>
                                <select class="gabiii-form-select">
                                    <option value="">Selecione</option>
                                    <option value="M">Masculino</option>
                                    <option value="F">Feminino</option>
                                </select>
                            </div>
                        </div>

                        <div class="gabiii-section-title" style="margin-top: 25px; margin-bottom: 15px;">Contato</div>

                        <div class="gabiii-form-grid">
                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Telefone celular</label>
                                <input type="text" class="gabiii-form-input" placeholder="(41) 98598-3172">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Telefone celular 2</label>
                                <input type="text" class="gabiii-form-input" placeholder="(00) 00000-0000">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Telefone residencial</label>
                                <input type="text" class="gabiii-form-input">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Telefone comercial</label>
                                <input type="text" class="gabiii-form-input">
                            </div>

                            <div class="gabiii-form-group full">
                                <label class="gabiii-form-label">E-mail</label>
                                <input type="email" class="gabiii-form-input" placeholder="o">
                            </div>
                        </div>

                        <div class="gabiii-section-title" style="margin-top: 25px; margin-bottom: 15px;">Endereço</div>

                        <div class="gabiii-form-grid">
                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">CEP</label>
                                <input type="text" class="gabiii-form-input">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Endereço</label>
                                <input type="text" class="gabiii-form-input">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Número</label>
                                <input type="text" class="gabiii-form-input">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Complemento</label>
                                <input type="text" class="gabiii-form-input">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Bairro</label>
                                <input type="text" class="gabiii-form-input">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Estado</label>
                                <select class="gabiii-form-select">
                                    <option value="">Paraná</option>
                                </select>
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Cidade</label>
                                <select class="gabiii-form-select">
                                    <option value="">Campo Largo</option>
                                </select>
                            </div>
                        </div>

                        <div class="gabiii-form-actions">
                            <button class="gabiii-btn gabiii-btn-primary" type="button">Salvar</button>
                        </div>
                    </div>

                    <div class="gabiii-card">
                        <div class="gabiii-section-title">Anexos</div>
                        <p class="gabiii-muted">A conta é a partir do primeiro dia do mês de filiação. Não há cobrança de mensalidade proporcional. Para mais informações, veja nosso FAQ do site.</p>
                    </div>
                </div>

                <!-- ABA COTAÇÕES -->
                <div class="gabiii-tab-content" data-content="cotacoes">
                    <div class="gabiii-card gabiii-highlight-card">
                        <div class="gabiii-card-header">
                            <div>
                                <p class="gabiii-info-label">ACEITE DE COTAÇÃO</p>
                                <h3 class="gabiii-card-title" style="margin-top: 5px;">Envie o documento ao cliente</h3>
                                <p class="gabiii-muted">Use este botão para confirmar o aceite do seu cliente nessa cotação.</p>
                            </div>
                        </div>
                        <p class="gabiii-muted">Essa cotação foi visualizada pelo cliente 0 vezes.</p>
                    </div>

                    <div class="gabiii-card">
                        <div class="gabiii-card-header">
                            <h3 class="gabiii-card-title">Informações do veículo</h3>
                            <button class="gabiii-btn gabiii-btn-primary" type="button">Consultar no SGA</button>
                        </div>

                        <div class="gabiii-form-grid">
                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Tipo de veículo</label>
                                <select class="gabiii-form-select">
                                    <option value="">Selecione</option>
                                    <option value="CARRO">Carro</option>
                                    <option value="MOTO">Moto</option>
                                </select>
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Placa</label>
                                <input type="text" class="gabiii-form-input" placeholder="ABC-1234">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Renavam</label>
                                <input type="text" class="gabiii-form-input">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Marca*</label>
                                <select class="gabiii-form-select">
                                    <option value="">Marca*</option>
                                </select>
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Ano modelo</label>
                                <select class="gabiii-form-select">
                                    <option value="">Ano*</option>
                                </select>
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Modelo*</label>
                                <select class="gabiii-form-select">
                                    <option value="">Modelo*</option>
                                </select>
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Ano Fabricação</label>
                                <input type="text" class="gabiii-form-input">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Código FIPE</label>
                                <input type="text" class="gabiii-form-input">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Valor FIPE</label>
                                <input type="text" class="gabiii-form-input">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Valor Protegido</label>
                                <input type="text" class="gabiii-form-input" value="-">
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Depreciação</label>
                                <select class="gabiii-form-select">
                                    <option value="">Selecione</option>
                                </select>
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Dia de Vencimento</label>
                                <select class="gabiii-form-select">
                                    <option value="">Selecione</option>
                                </select>
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Cor</label>
                                <select class="gabiii-form-select">
                                    <option value="">Select an Option</option>
                                </select>
                            </div>

                            <div class="gabiii-form-group">
                                <label class="gabiii-form-label">Câmbio</label>
                                <select class="gabiii-form-select">
                                    <option value="">Selecione</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ABA VISTORIA -->
                <div class="gabiii-tab-content" data-content="vistoria">
                    <div class="gabiii-card">
                        <div class="gabiii-empty-state">
                            <i class="bi bi-car-front gabiii-empty-icon"></i>
                            <p class="gabiii-empty-text">Este veículo não foi liberado para vistoria.</p>
                            <div class="gabiii-actions" style="margin-top: 20px;">
                                <button class="gabiii-btn gabiii-btn-primary" type="button">Liberar vistoria</button>
                                <button class="gabiii-btn gabiii-btn-secondary" type="button">Vincular vistoria</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ABA POWERSIGN -->
                <div class="gabiii-tab-content" data-content="powersign">
                    <div class="gabiii-card">
                        <div class="gabiii-section-title">Envie documentos para assinatura</div>

                        <div class="gabiii-form-group">
                            <select class="gabiii-form-select">
                                <option value="">Selecione o tipo</option>
                                <option value="contrato">Contrato</option>
                                <option value="termo">Termo de Adesão</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>

                        <div class="gabiii-tabs-secondary" style="margin-top: 20px;">
                            <button class="gabiii-tab-secondary active" type="button">
                                <i class="bi bi-file-earmark-text"></i> Documentos
                            </button>
                            <button class="gabiii-tab-secondary" type="button">
                                <i class="bi bi-envelope"></i> Envelopes
                            </button>
                        </div>

                        <div class="gabiii-empty-state">
                            <p class="gabiii-muted">Nenhum documento enviado</p>
                        </div>
                    </div>
                </div>

            </div>

            <!-- SIDEBAR -->
            <div class="gabiii-sidebar">
                <div class="gabiii-card">
                    <div class="gabiii-card-header">
                        <h3 class="gabiii-card-title">Responsável</h3>
                    </div>
                    <div class="gabiii-avatar">VR</div>
                    <p class="gabiii-info-value">VINICIUS RIAN S...</p>
                    <button class="gabiii-btn gabiii-btn-success" type="button">Atender essa cotação</button>
                </div>

                <div class="gabiii-card">
                    <div class="gabiii-card-header">
                        <h3 class="gabiii-card-title">Afiliado(a)</h3>
                    </div>
                    <p class="gabiii-info-value">Nenhum</p>
                </div>

                <div class="gabiii-card" th:data-venda-id="${vendaId}" th:data-valor-venda="${valorVenda}" id="bonus-card">
                    <div class="gabiii-card-header">
                        <h3 class="gabiii-card-title">Bônus</h3>
                    </div>
                    <p class="gabiii-info-value" style="color: #10b981;" id="bonus-valor">
                        R$ <span th:text="${#numbers.formatDecimal(valorVenda, 1, 'DEFAULT', 2, 'DEFAULT')}">0,00</span>
                    </p>

                    <button class="gabiii-btn" type="button" onclick="concluirVenda()"
                            style="background: #ff9800; color: white; width: 100%; margin-top: 15px;">
                        <i class="bi bi-lightning-fill"></i> Venda Concluída
                    </button>
                </div>

                <div class="gabiii-card">
                    <div class="gabiii-card-header">
                        <h3 class="gabiii-card-title">Contratação online</h3>
                    </div>
                    <span class="gabiii-status">Dados incompletos</span>
                </div>

                <div class="gabiii-card">
                    <div class="gabiii-card-header">
                        <h3 class="gabiii-card-title">Cooperativa</h3>
                    </div>
                    <select class="gabiii-form-select">
                        <option value="">Select an Option</option>
                    </select>
                </div>

                <div class="gabiii-card">
                    <div class="gabiii-card-header">
                        <h3 class="gabiii-card-title">Origem do lead</h3>
                    </div>
                    <select class="gabiii-form-select">
                        <option value="">Marketing ON</option>
                    </select>
                    <select class="gabiii-form-select" style="margin-top: 10px;">
                        <option value="">Facebook Ads</option>
                    </select>
                </div>

                <div class="gabiii-card">
                    <div class="gabiii-card-header">
                        <h3 class="gabiii-card-title">Tags</h3>
                        <button class="gabiii-btn-link" type="button">Adicionar</button>
                    </div>
                    <span class="gabiii-tag gabiii-tag-blue">Cotação de Website</span>
                    <span class="gabiii-tag gabiii-tag-green">Formulário Integrado do Facebook</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== SISTEMA DE TESTE DE VENDA ==========
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
        const vendaId = '[[${vendaId}]]';

        function buildHeaders(extra = {}) {
            const headers = { 'X-Requested-With': 'XMLHttpRequest', ...extra };
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }
            return headers;
        }

        // ========== SISTEMA DE ATIVIDADES ==========
        // Inicializa os campos e carrega atividades ao abrir o modal
        document.addEventListener('DOMContentLoaded', function() {
            // Define data/hora atual como padrão
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');

            const dateTimeValue = `${year}-${month}-${day}T${hours}:${minutes}`;
            const whenField = document.getElementById('activity-when');
            if (whenField) {
                whenField.value = dateTimeValue;
            }

            // Carrega atividades existentes
            loadActivities();
        });

        async function salvarAtividade() {
            const tipo = document.getElementById('activity-type').value;
            const responsavel = document.getElementById('activity-responsavel').value.trim();
            const quando = document.getElementById('activity-when').value;
            const cliente = document.getElementById('activity-cliente').value.trim();

            // Validações
            if (!tipo) {
                alert('Por favor, selecione o tipo de atividade.');
                return;
            }
            if (!responsavel) {
                alert('Por favor, informe o responsável.');
                return;
            }
            if (!quando) {
                alert('Por favor, informe quando a atividade será realizada.');
                return;
            }
            if (!cliente) {
                alert('Por favor, informe o nome do cliente.');
                return;
            }

            // Prepara payload
            const payload = {
                titulo: `${tipo} - ${cliente}`,
                tipo: tipo,
                prioridade: 'MEDIA',
                descricao: `Atividade criada para ${cliente}`,
                responsavel: responsavel,
                dataAgendada: quando,
                contatoNome: cliente,
                saleId: vendaId,
                status: 'AGENDADA'
            };

            try {
                const response = await fetch('/crm/api/atividades', {
                    method: 'POST',
                    headers: buildHeaders({
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }),
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error('Erro ao salvar atividade');
                }

                const data = await response.json();
                alert('✅ Atividade salva com sucesso!');

                // Limpa os campos
                document.getElementById('activity-responsavel').value = '';
                document.getElementById('activity-cliente').value = '';
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                document.getElementById('activity-when').value = `${year}-${month}-${day}T${hours}:${minutes}`;

                // Recarrega a lista de atividades
                loadActivities();

            } catch (error) {
                console.error('Erro ao salvar atividade:', error);
                alert('❌ Erro ao salvar atividade: ' + error.message);
            }
        }

        async function loadActivities() {
            try {
                const response = await fetch(`/crm/api/atividades/venda/${vendaId}`, {
                    headers: buildHeaders({
                        'Accept': 'application/json'
                    })
                });

                if (!response.ok) {
                    throw new Error('Erro ao carregar atividades');
                }

                const activities = await response.json();
                displayActivities(activities);

            } catch (error) {
                console.error('Erro ao carregar atividades:', error);
            }
        }

        function displayActivities(activities) {
            const listContainer = document.getElementById('activities-list');

            if (!activities || activities.length === 0) {
                listContainer.innerHTML = `
                    <div class="gabiii-empty-state">
                        <i class="bi bi-calendar-x gabiii-empty-icon"></i>
                        <p class="gabiii-empty-text">Sem atividades nesta negociação.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            activities.forEach(activity => {
                const statusColor = getStatusColor(activity.status);
                const tipoIcon = getTipoIcon(activity.tipo);
                const dataFormatada = formatarData(activity.dataAgendada);

                html += `
                    <div style="border-left: 4px solid ${statusColor}; padding: 15px; background: #f9fafb; border-radius: 6px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: ${statusColor}; display: flex; align-items: center; justify-content: center;">
                                <i class="bi ${tipoIcon}" style="color: white; font-size: 1.2rem;"></i>
                            </div>
                            <div style="flex: 1;">
                                <h4 style="font-size: 0.95rem; font-weight: 600; color: #111827; margin-bottom: 5px;">
                                    ${activity.titulo}
                                </h4>
                                <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 5px;">
                                    ${activity.descricao || ''}
                                </p>
                                <div style="display: flex; gap: 15px; font-size: 0.75rem; color: #9ca3af;">
                                    <span><i class="bi bi-person"></i> ${activity.responsavel || 'Não definido'}</span>
                                    <span><i class="bi bi-calendar"></i> ${dataFormatada}</span>
                                    <span class="gabiii-tag gabiii-tag-${getStatusClass(activity.status)}" style="padding: 2px 8px;">${getStatusLabel(activity.status)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            listContainer.innerHTML = html;
        }

        function getStatusColor(status) {
            const colors = {
                'AGENDADA': '#3b82f6',
                'EM_ANDAMENTO': '#f59e0b',
                'CONCLUIDA': '#10b981',
                'CANCELADA': '#ef4444',
                'REAGENDADA': '#8b5cf6'
            };
            return colors[status] || '#6b7280';
        }

        function getTipoIcon(tipo) {
            const icons = {
                'LIGACAO': 'bi-telephone',
                'EMAIL': 'bi-envelope',
                'REUNIAO': 'bi-people',
                'VISITA': 'bi-geo-alt',
                'FOLLOW_UP': 'bi-arrow-repeat',
                'APRESENTACAO': 'bi-easel',
                'NEGOCIACAO': 'bi-handshake',
                'VISTORIA': 'bi-car-front',
                'OUTRO': 'bi-three-dots'
            };
            return icons[tipo] || 'bi-calendar';
        }

        function getStatusClass(status) {
            const classes = {
                'AGENDADA': 'blue',
                'EM_ANDAMENTO': 'blue',
                'CONCLUIDA': 'green',
                'CANCELADA': 'blue',
                'REAGENDADA': 'blue'
            };
            return classes[status] || 'blue';
        }

        function getStatusLabel(status) {
            const labels = {
                'AGENDADA': 'Agendada',
                'EM_ANDAMENTO': 'Em andamento',
                'CONCLUIDA': 'Concluída',
                'CANCELADA': 'Cancelada',
                'REAGENDADA': 'Reagendada'
            };
            return labels[status] || status;
        }

        function formatarData(dateString) {
            if (!dateString) return 'Não definida';

            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');

            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        // Função para concluir a venda atual e atualizar o kanban
        async function concluirVenda() {
            // Pega o card de bônus
            const bonusCard = document.getElementById('bonus-card');
            if (!bonusCard) {
                alert('❌ Erro: Card de bônus não encontrado');
                return;
            }

            // Pega o vendaId e valorVenda dos data attributes
            const vendaId = bonusCard.getAttribute('data-venda-id');
            const valorVenda = parseFloat(bonusCard.getAttribute('data-valor-venda')) || 0;

            if (!vendaId) {
                alert('❌ Erro: ID da venda não encontrado');
                return;
            }

            // Se o valor for zero, usa um valor padrão
            const valorFinal = valorVenda > 0 ? valorVenda : 1000.00;

            if (!confirm(`Deseja concluir esta venda no valor de R$ ${valorFinal.toFixed(2).replace('.', ',')}?`)) {
                return;
            }

            try {
                const response = await fetch(`/crm/api/vendas/${vendaId}/concluir`, {
                    method: 'POST',
                    headers: buildHeaders({
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }),
                    body: JSON.stringify({ valorVenda: valorFinal })
                });

                if (!response.ok) {
                    throw new Error('Erro ao concluir venda');
                }

                const data = await response.json();
                const valorResposta = Number(data.valorVenda);
                const valorParaExibir = Number.isNaN(valorResposta) ? valorFinal : valorResposta;
                const valorFormatado = valorParaExibir.toFixed(2).replace('.', ',');
                alert(`✅ Venda concluída com sucesso!\n\nValor: R$ ${valorFormatado}`);

                // Recarrega o kanban se estiver disponível
                if (window.vendasBoard && window.vendasBoard.loadBoard) {
                    window.vendasBoard.loadBoard();
                }

                if (window.vendasBoard && window.vendasBoard.updateCardStatus) {
                    window.vendasBoard.updateCardStatus(data.id, data.status);
                }

                // Fecha o modal após criar a venda
                if (window.vendasBoard && window.vendasBoard.closeModal) {
                    window.vendasBoard.closeModal();
                }
            } catch (error) {
                console.error('Erro ao concluir venda:', error);
                alert('❌ Erro ao concluir venda: ' + error.message);
            }
        }
    </script>
</body>
</html>
