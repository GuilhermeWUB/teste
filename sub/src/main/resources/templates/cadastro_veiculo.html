<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>SUB - Cadastrar Ve√≠culo</title>
    <style>
        .fipe-lookup-box {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 0.375rem;
            border: 2px dashed #dee2e6;
            margin-bottom: 1.5rem;
        }
        .fipe-lookup-form {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }
        .fipe-lookup-form .form-group {
            flex: 1;
            margin-bottom: 0;
        }
    </style>
</head>
<body>

<section layout:fragment="content">
    <h1 class="mb-4">Cadastrar Ve√≠culo</h1>

    <!-- Mensagens de sucesso/erro da busca FIPE -->
    <div th:if="${fipeSuccess}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill"></i>
        <span th:text="${fipeSuccess}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div th:if="${fipeError}" class="alert alert-warning alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <span th:text="${fipeError}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Formul√°rio de Busca FIPE -->
    <div class="fipe-lookup-box">
        <h5 class="mb-3">
            <i class="bi bi-search"></i> Buscar Dados da Tabela FIPE
        </h5>
        <p class="text-muted small mb-2">Digite o c√≥digo FIPE e clique em "Buscar Dados" para preencher automaticamente as informa√ß√µes do ve√≠culo.</p>

        <div class="alert alert-info alert-sm mb-3" style="padding: 0.5rem; font-size: 0.875rem;">
            <strong>üí° Dica:</strong> O c√≥digo FIPE deve estar no formato <code>XXXXXX-X</code> (ex: 001004-9).
            Voc√™ pode encontrar o c√≥digo FIPE do seu ve√≠culo em sites como
            <a href="https://veiculos.fipe.org.br/" target="_blank" rel="noopener">veiculos.fipe.org.br</a> ou
            <a href="https://www.tabelafipebrasil.com/" target="_blank" rel="noopener">tabelafipebrasil.com</a>
        </div>

        <form th:action="@{/vehicles/new}" method="get" class="fipe-lookup-form">
            <input type="hidden" name="partnerId" th:value="${partnerId}" th:if="${partnerId}"/>
            <div class="form-group flex-grow-1">
                <label for="codigoFipeLookup" class="form-label">C√≥digo FIPE</label>
                <input type="text" id="codigoFipeLookup" name="codigoFipe" class="form-control"
                       placeholder="Ex: 001004-9" th:value="${vehicle.codigo_fipe}" required
                       pattern="[0-9]{6}-[0-9]" title="Formato: 000000-0"/>
                <small class="form-text text-muted">Formato: 6 d√≠gitos + h√≠fen + 1 d√≠gito</small>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-arrow-repeat"></i> Buscar Dados
            </button>
        </form>
    </div>

    <!-- Formul√°rio Principal -->
    <form th:action="@{/vehicles}" th:object="${vehicle}" method="post" enctype="multipart/form-data" class="row g-3">
        <input type="hidden" name="contextPartnerId" th:value="${partnerId}" />

        <div th:if="${fipeSuccessMessage}" class="alert alert-success" th:text="${fipeSuccessMessage}"></div>
        <div th:if="${fipeErrorMessage}" class="alert alert-warning" th:text="${fipeErrorMessage}"></div>

        <!-- Campos da Tabela FIPE -->
        <h3 class="h5 mt-4">Dados da Tabela FIPE</h3>
        <div class="col-md-4">
            <label for="codigo_fipe" class="form-label">C√≥digo Fipe</label>
            <input type="text" id="codigo_fipe" class="form-control" th:field="*{codigo_fipe}" placeholder="Ex: 001004-9" />
            <small class="form-text text-muted">Digite o c√≥digo e clique em "Buscar dados da Fipe"</small>
        </div>
        <div class="col-md-4">
            <label for="fipe_value" class="form-label">Valor Tabela Fipe</label>
            <input type="text" id="fipe_value" class="form-control" th:field="*{fipe_value}" />
        </div>
        <div class="col-md-4">
            <label for="type_vehicle" class="form-label">Tipo</label>
            <select id="type_vehicle" class="form-select" th:field="*{type_vehicle}">
                <option value="">Selecione o tipo</option>
                <option value="Carro">Carro</option>
                <option value="Moto">Moto</option>
                <option value="Caminh√£o">Caminh√£o</option>
                <option value="√înibus">√înibus</option>
                <option value="Micro-√¥nibus">Micro-√¥nibus</option>
            </select>
        </div>

        <div class="col-md-4 align-self-end">
            <button type="submit" name="acao" value="buscarFipe" class="btn btn-outline-primary w-100">Buscar dados da Fipe</button>
        </div>

        <hr class="my-3" />

        <h3 class="h5">Dados do Ve√≠culo</h3>
        <div class="col-md-6">
            <label for="maker" class="form-label">Montadora</label>
            <input type="text" id="maker" class="form-control" th:field="*{maker}" />
            <div class="text-danger" th:if="${#fields.hasErrors('maker')}" th:errors="*{maker}"></div>
        </div>
        <div class="col-md-6">
            <label for="model" class="form-label">Modelo</label>
            <input type="text" id="model" class="form-control" th:field="*{model}" />
            <div class="text-danger" th:if="${#fields.hasErrors('model')}" th:errors="*{model}"></div>
        </div>
        <div class="col-md-4">
            <label for="plaque" class="form-label">Placa</label>
            <input type="text" id="plaque" class="form-control" th:field="*{plaque}" />
            <div class="text-danger" th:if="${#fields.hasErrors('plaque')}" th:errors="*{plaque}"></div>
        </div>
        <div class="col-md-4">
            <label for="color" class="form-label">Cor</label>
            <input type="text" id="color" class="form-control" th:field="*{color}" />
            <div class="text-danger" th:if="${#fields.hasErrors('color')}" th:errors="*{color}"></div>
        </div>
        <div class="col-md-4">
            <label for="year_mod" class="form-label">Ano/Modelo</label>
            <input type="text" id="year_mod" class="form-control" th:field="*{year_mod}" />
            <div class="text-danger" th:if="${#fields.hasErrors('year_mod')}" th:errors="*{year_mod}"></div>
        </div>
        <div class="col-md-6">
            <label for="tipo_combustivel" class="form-label">Tipo de combust√≠vel</label>
            <input type="text" id="tipo_combustivel" class="form-control" th:field="*{tipo_combustivel}" />
            <div class="text-danger" th:if="${#fields.hasErrors('tipo_combustivel')}" th:errors="*{tipo_combustivel}"></div>
        </div>
        <div class="col-md-6">
            <label for="partner" class="form-label">Associado</label>
            <select id="partner" class="form-select" th:field="*{partnerId}">
                <option value="" disabled>Selecione</option>
                <option th:each="partner : ${partners}" th:value="${partner.id}" th:text="${partner.name}"></option>
            </select>
            <div class="text-danger" th:if="${#fields.hasErrors('partnerId')}" th:errors="*{partnerId}"></div>
        </div>

        <h3 class="h5 mt-4">Dados de Pagamento</h3>
        <div class="col-md-6">
            <label for="monthly" class="form-label">Mensalidade</label>
            <input type="number" step="0.01" id="monthly" class="form-control" th:field="*{payment.monthly}" />
            <div class="text-danger" th:if="${#fields.hasErrors('payment.monthly')}" th:errors="*{payment.monthly}"></div>
        </div>
        <div class="col-md-6">
            <label for="vencimento" class="form-label">Dia do vencimento</label>
            <input type="number" min="1" max="31" id="vencimento" class="form-control" th:field="*{payment.vencimento}" />
            <div class="text-danger" th:if="${#fields.hasErrors('payment.vencimento')}" th:errors="*{payment.vencimento}"></div>
        </div>

        <h3 class="h5 mt-4">Situa√ß√£o e Documenta√ß√£o</h3>
        <div class="col-md-12">
            <label for="vehicleStatus" class="form-label">Situa√ß√£o do Ve√≠culo</label>
            <select id="vehicleStatus" class="form-select" th:field="*{vehicleStatus}">
                <option value="">Selecione uma situa√ß√£o</option>
                <option th:each="status : ${T(com.necsus.necsusspring.model.VehicleStatus).values()}"
                        th:value="${status}"
                        th:text="${status.displayName}">
                </option>
            </select>
        </div>
        <div class="col-md-6">
            <label for="inspectionPhotos" class="form-label">Fotos de Inspe√ß√£o do Ve√≠culo</label>
            <input type="file" id="inspectionPhotos" class="form-control" name="inspectionPhotos" multiple accept="image/*" />
            <small class="form-text text-muted">Voc√™ pode selecionar m√∫ltiplas fotos</small>
        </div>
        <div class="col-md-6">
            <label for="documentPhotos" class="form-label">Fotos da Documenta√ß√£o do Ve√≠culo</label>
            <input type="file" id="documentPhotos" class="form-control" name="documentPhotos" multiple accept="image/*,application/pdf" />
            <small class="form-text text-muted">Voc√™ pode selecionar m√∫ltiplos arquivos (imagens ou PDFs)</small>
        </div>

        <div class="col-12 d-flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Salvar
            </button>
            <a th:href="${partnerId != null} ? @{/vehicles(partnerId=${partnerId})} : @{/vehicles}" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> Cancelar
            </a>
        </div>
    </form>

</section>

</body>
</html>
