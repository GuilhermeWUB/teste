<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>SUB - Cadastrar Ve√≠culo</title>
    <link rel="stylesheet" th:href="@{/css/cadastro.css}">
    <script src="/js/cadastro-veiculo.js"></script>
    <script>
        /**
         * Sistema de Auto-Preenchimento - Cadastro de Ve√≠culos
         * Busca dados por Placa (ApiBrasil) e por C√≥digo FIPE (BrasilAPI)
         */
        document.addEventListener("DOMContentLoaded", function() {
            console.log('üöó Sistema de Auto-Preenchimento inicializado');

            // ===== BUSCA POR PLACA (ApiBrasil) =====
            const placaInput = document.getElementById("plaque");
            const placaHelpText = document.getElementById("placa_help_text");
            let ultimaPlacaConsultada = '';
            let buscandoPlaca = false;

            // Formatar placa enquanto digita (ABC1234 ou ABC1D23)
            placaInput.addEventListener("input", function(e) {
                let valor = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                if (valor.length > 7) valor = valor.substring(0, 7);
                e.target.value = valor;
            });

            // Buscar ao sair do campo (blur) - acionado pelo TAB ou clique fora
            placaInput.addEventListener("blur", function() {
                buscarDadosPorPlaca();
            });

            // Buscar ao pressionar ENTER
            placaInput.addEventListener("keypress", function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    buscarDadosPorPlaca();
                }
            });

            async function buscarDadosPorPlaca() {
                const placa = placaInput.value.trim().toUpperCase();

                // Valida√ß√µes
                if (placa.length < 7) {
                    placaHelpText.textContent = "Digite uma placa v√°lida (m√≠nimo 7 caracteres)";
                    placaHelpText.className = "form-text text-muted";
                    return;
                }

                if (placa === ultimaPlacaConsultada) {
                    placaHelpText.textContent = "Placa j√° consultada";
                    placaHelpText.className = "form-text text-info";
                    return;
                }

                if (buscandoPlaca) {
                    console.log('‚è≥ Busca j√° em andamento...');
                    return;
                }

                console.log('üîç Buscando dados da placa:', placa);
                buscandoPlaca = true;

                placaHelpText.innerHTML = '<i class="bi bi-arrow-repeat"></i> Buscando dados da placa...';
                placaHelpText.className = "form-text text-primary";

                // Adicionar loading visual no input
                placaInput.style.borderColor = '#0d6efd';
                placaInput.style.backgroundColor = '#e7f1ff';

                try {
                    const response = await fetch(`/vehicles/api/placa/${placa}`);

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || "Placa n√£o encontrada");
                    }

                    const data = await response.json();
                    console.log('‚úÖ Dados recebidos da API:', data);
                    console.log('üìã Detalhamento dos campos:');
                    console.log('  - maker (Montadora):', data.maker);
                    console.log('  - model (Modelo):', data.model);
                    console.log('  - fipe_value (Valor FIPE):', data.fipe_value);
                    console.log('  - year_mod (Ano):', data.year_mod);
                    console.log('  - tipo_combustivel (Combust√≠vel):', data.tipo_combustivel);
                    console.log('  - color (Cor):', data.color);

                    // Preencher campos
                    preencherCampo("maker", data.maker);
                    preencherCampo("model", data.model);
                    preencherCampo("fipe_value", data.fipe_value);
                    preencherCampo("year_mod", data.year_mod);
                    preencherCampo("tipo_combustivel", data.tipo_combustivel);
                    preencherCampo("color", data.color);

                    placaHelpText.innerHTML = '<i class="bi bi-check-circle-fill"></i> Dados preenchidos com sucesso!';
                    placaHelpText.className = "form-text text-success";

                    placaInput.style.borderColor = '#198754';
                    placaInput.style.backgroundColor = '#d1e7dd';

                    ultimaPlacaConsultada = placa;

                    // Anima√ß√£o de sucesso nos campos preenchidos
                    animarCamposPreenchidos();

                } catch (error) {
                    console.error("‚ùå Erro ao buscar dados da placa:", error);
                    placaHelpText.innerHTML = `<i class="bi bi-exclamation-circle-fill"></i> ${error.message}`;
                    placaHelpText.className = "form-text text-danger";

                    placaInput.style.borderColor = '#dc3545';
                    placaInput.style.backgroundColor = '#f8d7da';
                } finally {
                    buscandoPlaca = false;

                    // Restaurar estilo do input ap√≥s 3 segundos
                    setTimeout(() => {
                        placaInput.style.borderColor = '';
                        placaInput.style.backgroundColor = '';
                    }, 3000);
                }
            }

            // ===== BUSCA POR C√ìDIGO FIPE (BrasilAPI) =====
            const fipeCodeInput = document.getElementById("codigo_fipe");
            const fipeHelpText = document.getElementById("fipe_help_text");
            let buscandoFipe = false;

            // Formatar c√≥digo FIPE enquanto digita
            fipeCodeInput.addEventListener("input", function(e) {
                let valor = e.target.value.replace(/[^0-9-]/g, '');
                e.target.value = valor;
            });

            // Buscar ao sair do campo (blur) - acionado pelo TAB
            fipeCodeInput.addEventListener("blur", function() {
                buscarDadosPorCodigoFipe();
            });

            // Buscar ao pressionar ENTER
            fipeCodeInput.addEventListener("keypress", function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    buscarDadosPorCodigoFipe();
                }
            });

            async function buscarDadosPorCodigoFipe() {
                const fipeCode = fipeCodeInput.value.replace(/[^0-9-]/g, '');

                if (fipeCode.length < 7) {
                    fipeHelpText.textContent = "Digite um c√≥digo FIPE v√°lido";
                    fipeHelpText.className = "form-text text-muted";
                    return;
                }

                if (buscandoFipe) {
                    console.log('‚è≥ Busca FIPE j√° em andamento...');
                    return;
                }

                console.log('üîç Buscando dados do c√≥digo FIPE:', fipeCode);
                buscandoFipe = true;

                fipeHelpText.innerHTML = '<i class="bi bi-arrow-repeat"></i> Buscando dados da FIPE...';
                fipeHelpText.className = "form-text text-primary";

                fipeCodeInput.style.borderColor = '#0d6efd';
                fipeCodeInput.style.backgroundColor = '#e7f1ff';

                try {
                    const response = await fetch(`https://brasilapi.com.br/api/fipe/preco/v1/${fipeCode}`);

                    if (!response.ok) {
                        throw new Error('C√≥digo FIPE n√£o encontrado ou inv√°lido.');
                    }

                    const data = await response.json();

                    if (data && data.length > 0) {
                        const vehicle = data[0];
                        console.log('‚úÖ Dados FIPE recebidos:', vehicle);

                        // Mapeamento de tipo de ve√≠culo
                        const vehicleTypeMap = {
                            "carros": "Carro",
                            "motos": "Moto",
                            "caminhoes": "Caminh√£o"
                        };

                        // Preencher campos
                        preencherCampo("maker", vehicle.marca);
                        preencherCampo("model", vehicle.modelo);
                        preencherCampo("year_mod", vehicle.anoModelo);
                        preencherCampo("tipo_combustivel", vehicle.combustivel);

                        // Formatar valor como moeda
                        if (vehicle.valor) {
                            const valorNumerico = parseFloat(vehicle.valor.replace(/[^0-9,-]+/g, "").replace(",", "."));
                            const valorFormatado = new Intl.NumberFormat('pt-BR', {
                                style: 'currency',
                                currency: 'BRL'
                            }).format(valorNumerico);
                            preencherCampo("fipe_value", valorFormatado);
                        }

                        // Selecionar tipo de ve√≠culo
                        const tipoVeiculo = vehicle.tipoVeiculo ? vehicleTypeMap[vehicle.tipoVeiculo] : '';
                        if (tipoVeiculo) {
                            preencherCampo("type_vehicle", tipoVeiculo);
                        }

                        fipeHelpText.innerHTML = '<i class="bi bi-check-circle-fill"></i> Dados FIPE preenchidos com sucesso!';
                        fipeHelpText.className = "form-text text-success";

                        fipeCodeInput.style.borderColor = '#198754';
                        fipeCodeInput.style.backgroundColor = '#d1e7dd';

                        animarCamposPreenchidos();

                    } else {
                        throw new Error('Nenhum dado encontrado para este c√≥digo FIPE.');
                    }

                } catch (error) {
                    console.error("‚ùå Erro ao buscar dados da FIPE:", error);
                    fipeHelpText.innerHTML = `<i class="bi bi-exclamation-circle-fill"></i> ${error.message}`;
                    fipeHelpText.className = "form-text text-danger";

                    fipeCodeInput.style.borderColor = '#dc3545';
                    fipeCodeInput.style.backgroundColor = '#f8d7da';
                } finally {
                    buscandoFipe = false;

                    setTimeout(() => {
                        fipeCodeInput.style.borderColor = '';
                        fipeCodeInput.style.backgroundColor = '';
                    }, 3000);
                }
            }

            // ===== FUN√á√ïES AUXILIARES =====

            /**
             * Preenche um campo e adiciona feedback visual
             */
            function preencherCampo(fieldId, valor) {
                const campo = document.getElementById(fieldId);
                if (!campo) {
                    console.warn(`‚ö†Ô∏è Campo "${fieldId}" n√£o encontrado no DOM`);
                    return;
                }

                if (valor !== null && valor !== undefined && valor !== '') {
                    campo.value = valor;
                    console.log(`‚úÖ Campo "${fieldId}" preenchido com:`, valor);
                } else {
                    console.log(`‚ö†Ô∏è Campo "${fieldId}" - valor vazio/null recebido da API:`, valor);
                }
            }

            /**
             * Anima campos que foram preenchidos
             */
            function animarCamposPreenchidos() {
                const campos = ['maker', 'model', 'fipe_value', 'year_mod', 'tipo_combustivel', 'color'];
                campos.forEach(id => {
                    const campo = document.getElementById(id);
                    if (campo && campo.value) {
                        campo.style.transition = 'all 0.3s ease';
                        campo.style.transform = 'scale(1.02)';
                        campo.style.backgroundColor = '#d1e7dd';

                        setTimeout(() => {
                            campo.style.transform = 'scale(1)';
                            campo.style.backgroundColor = '';
                        }, 500);
                    }
                });
            }

            console.log('‚úÖ Sistema de Auto-Preenchimento pronto!');
            console.log('üí° Dica: Preencha a PLACA e pressione TAB ou ENTER para buscar os dados automaticamente');
        });
    </script>
</head>
<body>

<section layout:fragment="content">
    <h1 class="mb-4">Cadastrar Ve√≠culo</h1>

    <!-- Formul√°rio Principal -->
    <form th:action="@{/vehicles}" th:object="${vehicle}" method="post" enctype="multipart/form-data" class="row g-3">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <input type="hidden" name="contextPartnerId" th:value="${partnerId}" />

        <div th:if="${fipeSuccessMessage}" class="alert alert-success" th:text="${fipeSuccessMessage}"></div>
        <div th:if="${fipeErrorMessage}" class="alert alert-warning" th:text="${fipeErrorMessage}"></div>

        <!-- Campos da Tabela FIPE -->
        <h3 class="h5 mt-4">Dados da Tabela FIPE</h3>
        <div class="col-md-4">
            <label for="codigo_fipe" class="form-label">C√≥digo Fipe</label>
            <input type="text" id="codigo_fipe" class="form-control" th:field="*{codigo_fipe}" placeholder="Ex: 001004-9" />
            <small id="fipe_help_text" class="form-text text-muted">Digite o c√≥digo Fipe para preenchimento autom√°tico.</small>
        </div>
        <div class="col-md-4">
            <label for="fipe_value" class="form-label">Valor Tabela Fipe</label>
            <input type="text" id="fipe_value" class="form-control" th:field="*{fipe_value}" />
            <div class="text-danger" th:if="${#fields.hasErrors('fipe_value')}" th:errors="*{fipe_value}"></div>
        </div>
        <div class="col-md-4">
            <label for="type_vehicle" class="form-label">Tipo</label>
            <select id="type_vehicle" class="form-select" th:field="*{type_vehicle}">
                <option value="">Selecione o tipo</option>
                <option value="Carro">Carro</option>
                <option value="Moto">Moto</option>
                <option value="Caminh√£o">Caminh√£o</option>
                <option value="√înibus">√înibus</option>
                <option value="Micro-√¥nibus">Micro-√¥nibus</option>
            </select>
        </div>

        <hr class="my-3" />

        <h3 class="h5">Dados do Ve√≠culo</h3>
        <div class="col-md-6">
            <label for="maker" class="form-label">Montadora</label>
            <input type="text" id="maker" class="form-control" th:field="*{maker}" />
            <div class="text-danger" th:if="${#fields.hasErrors('maker')}" th:errors="*{maker}"></div>
        </div>
        <div class="col-md-6">
            <label for="model" class="form-label">Modelo</label>
            <input type="text" id="model" class="form-control" th:field="*{model}" />
            <div class="text-danger" th:if="${#fields.hasErrors('model')}" th:errors="*{model}"></div>
        </div>
        <div class="col-md-4">
            <label for="plaque" class="form-label">Placa</label>
            <input type="text" id="plaque" class="form-control" th:field="*{plaque}" />
            <small id="placa_help_text" class="form-text text-muted">Digite a placa para preenchimento autom√°tico.</small>
            <div class="text-danger" th:if="${#fields.hasErrors('plaque')}" th:errors="*{plaque}"></div>
        </div>
        <div class="col-md-4">
            <label for="color" class="form-label">Cor</label>
            <input type="text" id="color" class="form-control" th:field="*{color}" />
            <div class="text-danger" th:if="${#fields.hasErrors('color')}" th:errors="*{color}"></div>
        </div>
        <div class="col-md-4">
            <label for="year_mod" class="form-label">Ano</label>
            <input type="text" id="year_mod" class="form-control" th:field="*{year_mod}" />
            <div class="text-danger" th:if="${#fields.hasErrors('year_mod')}" th:errors="*{year_mod}"></div>
        </div>
        <div class="col-md-6">
            <label for="tipo_combustivel" class="form-label">Tipo de combust√≠vel</label>
            <input type="text" id="tipo_combustivel" class="form-control" th:field="*{tipo_combustivel}" />
            <div class="text-danger" th:if="${#fields.hasErrors('tipo_combustivel')}" th:errors="*{tipo_combustivel}"></div>
        </div>
        <div class="col-md-6">
            <label for="partner" class="form-label">Associado</label>
            <select id="partner" class="form-select" th:field="*{partnerId}">
                <option value="" disabled>Selecione</option>
                <option th:each="partner : ${partners}" th:value="${partner.id}" th:text="${partner.name}"></option>
            </select>
            <div class="text-danger" th:if="${#fields.hasErrors('partnerId')}" th:errors="*{partnerId}"></div>
        </div>

        <h3 class="h5 mt-4">Dados de Pagamento</h3>
        <div class="col-md-6">
            <label for="monthly" class="form-label">Mensalidade</label>
            <input type="number" step="0.01" id="monthly" class="form-control" th:field="*{payment.monthly}" />
            <div class="text-danger" th:if="${#fields.hasErrors('payment.monthly')}" th:errors="*{payment.monthly}"></div>
        </div>
        <div class="col-md-6">
            <label for="vencimento" class="form-label">Dia do vencimento</label>
            <input type="number" min="1" max="31" id="vencimento" class="form-control" th:field="*{payment.vencimento}" />
            <div class="text-danger" th:if="${#fields.hasErrors('payment.vencimento')}" th:errors="*{payment.vencimento}"></div>
        </div>

        <h3 class="h5 mt-4">Situa√ß√£o e Documenta√ß√£o</h3>
        <div class="col-md-12">
            <label for="vehicleStatus" class="form-label">Situa√ß√£o do Ve√≠culo</label>
            <select id="vehicleStatus" class="form-select" th:field="*{vehicleStatus}">
                <option value="">Selecione uma situa√ß√£o</option>
                <option th:each="status : ${T(com.necsus.necsusspring.model.VehicleStatus).values()}"
                        th:value="${status}"
                        th:text="${status.displayName}">
                </option>
            </select>
        </div>
        <div class="col-md-6">
            <label for="inspectionPhotos" class="form-label">Fotos de Inspe√ß√£o do Ve√≠culo</label>
            <input type="file" id="inspectionPhotos" class="form-control" name="inspectionPhotos" multiple accept="image/*" />
            <small class="form-text text-muted">Voc√™ pode selecionar m√∫ltiplas fotos</small>
        </div>
        <div class="col-md-6">
            <label for="documentPhotos" class="form-label">Fotos da Documenta√ß√£o do Ve√≠culo</label>
            <input type="file" id="documentPhotos" class="form-control" name="documentPhotos" multiple accept="image/*,application/pdf" />
            <small class="form-text text-muted">Voc√™ pode selecionar m√∫ltiplos arquivos (imagens ou PDFs)</small>
        </div>

        <div class="col-12 d-flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Salvar
            </button>
            <a th:href="${partnerId != null} ? @{/vehicles(partnerId=${partnerId})} : @{/vehicles}" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> Cancelar
            </a>
        </div>
    </form>

</section>

</body>
</html>
