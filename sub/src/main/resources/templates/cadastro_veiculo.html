<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>SUB - Cadastrar Veículo</title>
</head>
<body>

<section layout:fragment="content">
    <h1 class="mb-4">Cadastrar Veículo</h1>

    <!-- Formulário Principal -->
    <form th:action="@{/vehicles}" th:object="${vehicle}" method="post" enctype="multipart/form-data" class="row g-3">
        <input type="hidden" name="contextPartnerId" th:value="${partnerId}" />

        <div th:if="${fipeSuccessMessage}" class="alert alert-success" th:text="${fipeSuccessMessage}"></div>
        <div th:if="${fipeErrorMessage}" class="alert alert-warning" th:text="${fipeErrorMessage}"></div>

        <!-- Campos da Tabela FIPE -->
        <h3 class="h5 mt-4">Dados da Tabela FIPE</h3>
        <div class="col-md-4">
            <label for="codigo_fipe" class="form-label">Código Fipe</label>
            <input type="text" id="codigo_fipe" class="form-control" th:field="*{codigo_fipe}" placeholder="Ex: 001004-9" />
            <small id="fipe_help_text" class="form-text text-muted">Digite o código Fipe para preenchimento automático.</small>
        </div>
        <div class="col-md-4">
            <label for="fipe_value" class="form-label">Valor Tabela Fipe</label>
            <input type="text" id="fipe_value" class="form-control" th:field="*{fipe_value}" />
        </div>
        <div class="col-md-4">
            <label for="type_vehicle" class="form-label">Tipo</label>
            <select id="type_vehicle" class="form-select" th:field="*{type_vehicle}">
                <option value="">Selecione o tipo</option>
                <option value="Carro">Carro</option>
                <option value="Moto">Moto</option>
                <option value="Caminhão">Caminhão</option>
                <option value="Ônibus">Ônibus</option>
                <option value="Micro-ônibus">Micro-ônibus</option>
            </select>
        </div>

        <hr class="my-3" />

        <h3 class="h5">Dados do Veículo</h3>
        <div class="col-md-6">
            <label for="maker" class="form-label">Montadora</label>
            <input type="text" id="maker" class="form-control" th:field="*{maker}" />
            <div class="text-danger" th:if="${#fields.hasErrors('maker')}" th:errors="*{maker}"></div>
        </div>
        <div class="col-md-6">
            <label for="model" class="form-label">Modelo</label>
            <input type="text" id="model" class="form-control" th:field="*{model}" />
            <div class="text-danger" th:if="${#fields.hasErrors('model')}" th:errors="*{model}"></div>
        </div>
        <div class="col-md-4">
            <label for="plaque" class="form-label">Placa</label>
            <input type="text" id="plaque" class="form-control" th:field="*{plaque}" />
            <div class="text-danger" th:if="${#fields.hasErrors('plaque')}" th:errors="*{plaque}"></div>
        </div>
        <div class="col-md-4">
            <label for="color" class="form-label">Cor</label>
            <input type="text" id="color" class="form-control" th:field="*{color}" />
            <div class="text-danger" th:if="${#fields.hasErrors('color')}" th:errors="*{color}"></div>
        </div>
        <div class="col-md-4">
            <label for="year_mod" class="form-label">Ano/Modelo</label>
            <input type="text" id="year_mod" class="form-control" th:field="*{year_mod}" />
            <div class="text-danger" th:if="${#fields.hasErrors('year_mod')}" th:errors="*{year_mod}"></div>
        </div>
        <div class="col-md-6">
            <label for="tipo_combustivel" class="form-label">Tipo de combustível</label>
            <input type="text" id="tipo_combustivel" class="form-control" th:field="*{tipo_combustivel}" />
            <div class="text-danger" th:if="${#fields.hasErrors('tipo_combustivel')}" th:errors="*{tipo_combustivel}"></div>
        </div>
        <div class="col-md-6">
            <label for="partner" class="form-label">Associado</label>
            <select id="partner" class="form-select" th:field="*{partnerId}">
                <option value="" disabled>Selecione</option>
                <option th:each="partner : ${partners}" th:value="${partner.id}" th:text="${partner.name}"></option>
            </select>
            <div class="text-danger" th:if="${#fields.hasErrors('partnerId')}" th:errors="*{partnerId}"></div>
        </div>

        <h3 class="h5 mt-4">Dados de Pagamento</h3>
        <div class="col-md-6">
            <label for="monthly" class="form-label">Mensalidade</label>
            <input type="number" step="0.01" id="monthly" class="form-control" th:field="*{payment.monthly}" />
            <div class="text-danger" th:if="${#fields.hasErrors('payment.monthly')}" th:errors="*{payment.monthly}"></div>
        </div>
        <div class="col-md-6">
            <label for="vencimento" class="form-label">Dia do vencimento</label>
            <input type="number" min="1" max="31" id="vencimento" class="form-control" th:field="*{payment.vencimento}" />
            <div class="text-danger" th:if="${#fields.hasErrors('payment.vencimento')}" th:errors="*{payment.vencimento}"></div>
        </div>

        <h3 class="h5 mt-4">Situação e Documentação</h3>
        <div class="col-md-12">
            <label for="vehicleStatus" class="form-label">Situação do Veículo</label>
            <select id="vehicleStatus" class="form-select" th:field="*{vehicleStatus}">
                <option value="">Selecione uma situação</option>
                <option th:each="status : ${T(com.necsus.necsusspring.model.VehicleStatus).values()}"
                        th:value="${status}"
                        th:text="${status.displayName}">
                </option>
            </select>
        </div>
        <div class="col-md-6">
            <label for="inspectionPhotos" class="form-label">Fotos de Inspeção do Veículo</label>
            <input type="file" id="inspectionPhotos" class="form-control" name="inspectionPhotos" multiple accept="image/*" />
            <small class="form-text text-muted">Você pode selecionar múltiplas fotos</small>
        </div>
        <div class="col-md-6">
            <label for="documentPhotos" class="form-label">Fotos da Documentação do Veículo</label>
            <input type="file" id="documentPhotos" class="form-control" name="documentPhotos" multiple accept="image/*,application/pdf" />
            <small class="form-text text-muted">Você pode selecionar múltiplos arquivos (imagens ou PDFs)</small>
        </div>

        <div class="col-12 d-flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Salvar
            </button>
            <a th:href="${partnerId != null} ? @{/vehicles(partnerId=${partnerId})} : @{/vehicles}" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> Cancelar
            </a>
        </div>
    </form>

</section>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const fipeCodeInput = document.getElementById("codigo_fipe");
    const helpText = document.getElementById("fipe_help_text");

    fipeCodeInput.addEventListener("blur", function() {
        const fipeCode = this.value.replace(/[^0-9]/g, ''); // Limpa a máscara
        if (fipeCode.length >= 7) { // Validação básica do tamanho do código
            fetchFipeData(fipeCode);
        }
    });

    async function fetchFipeData(fipeCode) {
        // Mapeamento de tipo de veículo da API para os valores do select
        const vehicleTypeMap = {
            "carros": "Carro",
            "motos": "Moto",
            "caminhoes": "Caminhão"
        };

        const originalHelpText = helpText.textContent;
        helpText.textContent = "Buscando dados da Fipe...";
        helpText.classList.remove("text-danger");
        helpText.classList.add("text-primary");

        try {
            const response = await fetch(`https://brasilapi.com.br/api/fipe/preco/v1/${fipeCode}`);

            if (!response.ok) {
                throw new Error('Código Fipe não encontrado ou inválido.');
            }

            const data = await response.json();

            // A BrasilAPI retorna um array, pegamos o primeiro resultado que geralmente é o mais relevante
            if (data && data.length > 0) {
                const vehicle = data[0];

                // Preenche os campos
                document.getElementById("maker").value = vehicle.marca || '';
                document.getElementById("model").value = vehicle.modelo || '';
                document.getElementById("year_mod").value = `${vehicle.anoModelo}`;
                document.getElementById("tipo_combustivel").value = vehicle.combustivel || '';

                // Formata o valor como moeda brasileira
                const formattedValue = new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(parseFloat(vehicle.valor.replace(/[^0-9,-]+/g, "").replace(",", ".")));
                document.getElementById("fipe_value").value = formattedValue;

                // Seleciona o tipo de veículo
                const vehicleType = vehicle.tipoVeiculo ? vehicleTypeMap[vehicle.tipoVeiculo] : '';
                if (vehicleType) {
                    document.getElementById("type_vehicle").value = vehicleType;
                }

                helpText.textContent = "Dados preenchidos com sucesso!";
                helpText.classList.remove("text-primary");
                helpText.classList.add("text-success");
            } else {
                throw new Error('Nenhum dado encontrado para este código Fipe.');
            }

        } catch (error) {
            console.error("Erro ao buscar dados da Fipe:", error);
            helpText.textContent = error.message;
            helpText.classList.remove("text-primary", "text-success");
            helpText.classList.add("text-danger");

            // Opcional: Limpar os campos em caso de erro
            // document.getElementById("maker").value = '';
            // document.getElementById("model").value = '';
            // document.getElementById("year_mod").value = '';
            // document.getElementById("tipo_combustivel").value = '';
            // document.getElementById("fipe_value").value = '';
        }
    }
});
</script>

</body>
</html>
