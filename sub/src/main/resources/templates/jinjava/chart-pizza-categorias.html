<div class="chart-container" style="position: relative; height: 350px; width: 100%;">
    <canvas id="{{ chartId }}"></canvas>
</div>

<script>
    (function() {
        function renderChart() {
            // Verifica se a biblioteca Chart.js carregou. Se não, tenta de novo em 100ms.
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js ainda não carregou (Categorias). Tentando novamente em 100ms...');
                setTimeout(renderChart, 100);
                return;
            }

            const canvas = document.getElementById('{{ chartId }}');
            if (!canvas) {
                 console.error('Canvas de categorias não encontrado!');
                 return;
            }

            const ctx = canvas.getContext('2d');

            new Chart(ctx, {
                type: 'pie',
                data: {
                    // Adicionado |escapejs para evitar erros de sintaxe com aspas nos nomes
                    labels: [{% for item in categorias %}'{{ item.nome|escapejs }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                    datasets: [{
                        data: [{% for item in categorias %}{{ item.valor }}{% if not loop.last %}, {% endif %}{% endfor %}],
                        backgroundColor: [
                            {% for item in categorias %}'{{ item.cor|escapejs }}'{% if not loop.last %}, {% endif %}{% endfor %}
                        ],
                        borderColor: [
                            {% for item in categorias %}'{{ item.borderCor|escapejs }}'{% if not loop.last %}, {% endif %}{% endfor %}
                        ],
                        borderWidth: 2,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: '{{ titulo|escapejs }}',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return context.label + ': R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', renderChart);
        } else {
            renderChart();
        }
    })();
</script>