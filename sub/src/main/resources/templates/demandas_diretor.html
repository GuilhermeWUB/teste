<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>SUB - Demandas Estratégicas</title>
    <link rel="stylesheet" th:href="@{/css/kanban-board.css}">
</head>
<body>
<section layout:fragment="content">
    <div class="kanban-wrapper">
        <div class="kanban-header">
            <div class="kanban-header-info">
                <h1><i class="bi bi-kanban"></i> Demandas Estratégicas</h1>
                <p>Coordene iniciativas prioritárias e acompanhe o progresso em tempo real.</p>
            </div>
            <div class="kanban-controls">
                <div class="kanban-controls-left">
                    <div class="kanban-search">
                        <i class="bi bi-search"></i>
                        <input type="text" id="kanban-search" placeholder="Buscar por título, responsável ou cargo..." autocomplete="off"/>
                    </div>
                    <button class="kanban-filter-btn" id="btn-advanced-filters">
                        <i class="bi bi-funnel-fill"></i> Filtros
                        <span class="filter-count" style="display: none;">0</span>
                    </button>
                    <button class="kanban-clear-filters" id="btn-clear-filters" style="display: none;">
                        <i class="bi bi-x-circle"></i> Limpar Filtros
                    </button>
                </div>
                <div class="kanban-actions">
                    <button class="btn-novo-evento" type="button" onclick="window.demandBoard?.openCreateModal?.()">
                        <i class="bi bi-plus-circle"></i> Nova Demanda
                    </button>
                </div>
            </div>
        </div>

        <div class="kanban-alerts">
            <div th:if="${success}" class="kanban-alert success" role="alert">
                <i class="bi bi-check-circle-fill"></i>
                <span th:text="${success}"></span>
                <button type="button" class="kanban-alert-close" onclick="this.parentElement.remove()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div th:if="${error}" class="kanban-alert danger" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <span th:text="${error}"></span>
                <button type="button" class="kanban-alert-close" onclick="this.parentElement.remove()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        </div>

        <div class="kanban-board">
            <div class="kanban-column" data-status="PENDENTE">
                <div class="column-header">
                    <div class="column-title">
                        <h3>Pendente</h3>
                        <span class="column-count">0</span>
                    </div>
                    <button class="column-add-btn" type="button" onclick="window.demandBoard?.openCreateModal?.()">
                        <i class="bi bi-plus"></i> Nova
                    </button>
                </div>
                <div class="tasks-container"></div>
            </div>

            <div class="kanban-column" data-status="EM_ANDAMENTO">
                <div class="column-header">
                    <div class="column-title">
                        <h3>Em andamento</h3>
                        <span class="column-count">0</span>
                    </div>
                    <button class="column-add-btn" type="button" onclick="window.demandBoard?.openCreateModal?.()">
                        <i class="bi bi-plus"></i> Nova
                    </button>
                </div>
                <div class="tasks-container"></div>
            </div>

            <div class="kanban-column" data-status="CONCLUIDA">
                <div class="column-header">
                    <div class="column-title">
                        <h3>Concluída</h3>
                        <span class="column-count">0</span>
                    </div>
                    <button class="column-add-btn" type="button" onclick="window.demandBoard?.openCreateModal?.()">
                        <i class="bi bi-plus"></i> Nova
                    </button>
                </div>
                <div class="tasks-container"></div>
            </div>

            <div class="kanban-column" data-status="CANCELADA">
                <div class="column-header">
                    <div class="column-title">
                        <h3>Cancelada</h3>
                        <span class="column-count">0</span>
                    </div>
                    <button class="column-add-btn" type="button" onclick="window.demandBoard?.openCreateModal?.()">
                        <i class="bi bi-plus"></i> Nova
                    </button>
                </div>
                <div class="tasks-container"></div>
            </div>
        </div>
    </div>

    <div id="filters-modal" class="kanban-modal">
        <div class="kanban-modal-content filters-modal-content">
            <div class="kanban-modal-header">
                <h2><i class="bi bi-funnel-fill"></i> Filtros avançados</h2>
                <button class="kanban-modal-close" onclick="window.demandBoard?.closeFiltersModal?.()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="kanban-modal-body filters-modal-body">
                <div class="filter-section">
                    <h4 class="filter-section-title"><i class="bi bi-exclamation-triangle"></i> Prioridade</h4>
                    <div class="filter-options">
                        <label class="filter-checkbox" th:each="priority : ${priorityOptions}">
                            <input type="checkbox" name="prioridade" th:value="${priority.name()}" checked>
                            <span class="checkbox-label" th:text="${priority.displayName}">Prioridade</span>
                        </label>
                    </div>
                </div>

                <div class="filter-section">
                    <h4 class="filter-section-title"><i class="bi bi-list-check"></i> Status</h4>
                    <div class="filter-options">
                        <label class="filter-checkbox" th:each="status : ${statusOptions}">
                            <input type="checkbox" name="status" th:value="${status.name()}" checked>
                            <span class="checkbox-label" th:text="${status.displayName}">Status</span>
                        </label>
                    </div>
                </div>

                <div class="filter-section">
                    <h4 class="filter-section-title"><i class="bi bi-people"></i> Cargos destinatários</h4>
                    <div class="filter-options">
                        <label class="filter-checkbox" th:each="role : ${availableRoles}" th:data-role-code="${role.code}">
                            <input type="checkbox" name="targetRoles" th:value="${role.code}" checked>
                            <span class="checkbox-label" th:text="${role.displayName}">Cargo</span>
                        </label>
                    </div>
                </div>

                <div class="filter-section">
                    <h4 class="filter-section-title"><i class="bi bi-person-badge"></i> Responsável</h4>
                    <div class="filter-text-input">
                        <input type="text" id="filter-assigned" class="form-control"
                               placeholder="Nome do responsável (atribuição)">
                    </div>
                </div>

                <div class="filter-section">
                    <h4 class="filter-section-title"><i class="bi bi-person-lines-fill"></i> Criador</h4>
                    <div class="filter-text-input">
                        <input type="text" id="filter-creator" class="form-control"
                               placeholder="Nome de quem criou a demanda">
                    </div>
                </div>

                <div class="filter-section">
                    <h4 class="filter-section-title"><i class="bi bi-calendar-event"></i> Prazo</h4>
                    <div class="filter-date-range">
                        <div class="filter-date-input">
                            <label for="filter-date-from">De:</label>
                            <input type="date" id="filter-date-from" class="form-control">
                        </div>
                        <div class="filter-date-input">
                            <label for="filter-date-to">Até:</label>
                            <input type="date" id="filter-date-to" class="form-control">
                        </div>
                    </div>
                </div>

                <div class="filter-actions">
                    <button class="btn-filter-apply" type="button" onclick="window.demandBoard?.applyFilters?.()">
                        <i class="bi bi-check-circle"></i> Aplicar filtros
                    </button>
                    <button class="btn-filter-reset" type="button" onclick="window.demandBoard?.resetFilters?.()">
                        <i class="bi bi-arrow-clockwise"></i> Resetar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="kanban-modal" class="kanban-modal">
        <div class="kanban-modal-content">
            <div class="kanban-modal-header">
                <h2>Detalhes da demanda</h2>
                <button class="kanban-modal-close" onclick="window.demandBoard?.closeModal?.()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="kanban-modal-body"></div>
        </div>
    </div>

    <div id="create-demand-modal" class="kanban-modal">
        <div class="kanban-modal-content">
            <div class="kanban-modal-header">
                <h2><i class="bi bi-plus-circle"></i> Nova Demanda</h2>
                <button class="kanban-modal-close" onclick="window.demandBoard?.closeCreateModal?.()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="kanban-modal-body">
                <form th:action="@{/demands/create}" th:object="${newDemand}" method="post" class="kanban-create-form">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                    <div class="form-row">
                        <div class="form-group">
                            <label for="titulo">Título *</label>
                            <input type="text" id="titulo" th:field="*{titulo}" placeholder="Resumo objetivo da demanda" required>
                        </div>
                        <div class="form-group">
                            <label for="prioridade">Prioridade *</label>
                            <select id="prioridade" th:field="*{prioridade}" required>
                                <option th:each="priority : ${priorityOptions}" th:value="${priority}" th:text="${priority.displayName}"></option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dueDate">Prazo</label>
                            <input type="datetime-local" id="dueDate" th:field="*{dueDate}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="descricao">Descrição *</label>
                        <textarea id="descricao" th:field="*{descricao}" rows="4" placeholder="Descreva a demanda com contexto e objetivos" required></textarea>
                    </div>

                    <div class="form-group">
                        <label>Cargos destinatários *</label>
                        <div class="role-checkbox-group" id="role-checkbox-group">
                            <label th:each="role : ${availableRoles}" class="role-checkbox-item">
                                <input type="checkbox" name="targetRolesList" th:value="${role.code}" th:id="'create-role-' + ${role.code}" class="role-checkbox-input">
                                <span th:text="${role.displayName}">Cargo</span>
                            </label>
                        </div>
                        <small class="text-muted">Selecione os times que devem receber esta demanda</small>
                    </div>

                    <div class="form-group">
                        <label for="assignedToId">Atribuir a um funcionário específico (opcional)</label>
                        <select id="assignedToId" name="assignedToId" class="form-control">
                            <option value="">Selecione um funcionário...</option>
                        </select>
                        <small class="text-muted" id="assigned-help-text">Selecione um ou mais setores acima para ver os funcionários disponíveis</small>
                    </div>

                    <div class="form-actions" style="display: flex !important; justify-content: flex-end !important; gap: 0.75rem !important; margin-top: 2rem !important;">
                        <button type="button" class="btn-secondary" onclick="window.demandBoard?.closeCreateModal?.()" style="display: inline-flex !important; align-items: center !important; gap: 0.5rem !important; padding: 0.6rem 1.4rem !important; border-radius: 999px !important; border: 1px solid #dee2e6 !important; background-color: #6c757d !important; color: #ffffff !important; font-weight: 600 !important; cursor: pointer !important;">
                            <i class="bi bi-x-circle"></i>
                            Cancelar
                        </button>
                        <button type="submit" class="btn-primary" style="display: inline-flex !important; align-items: center !important; gap: 0.5rem !important; padding: 0.6rem 1.4rem !important; border-radius: 999px !important; border: none !important; background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%) !important; color: #ffffff !important; font-weight: 600 !important; cursor: pointer !important;">
                            <i class="bi bi-send-fill"></i> Criar Demanda
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const body = document.body;
            if (body) {
                body.classList.remove('no-dark-blur');
            }

            const main = document.querySelector('main.page');
            if (main) {
                main.classList.add('kanban-page');
            }

            const container = document.querySelector('main.page > .container');
            if (container) {
                container.classList.add('kanban-full-width');
            }

            const pageContent = document.querySelector('main.page > .container > .page-content');
            if (pageContent) {
                pageContent.classList.add('kanban-content-stretch');
            }

            // Funcionalidade: Buscar funcionários por setores selecionados
            const roleCheckboxes = document.querySelectorAll('.role-checkbox-input');
            const assignedToSelect = document.getElementById('assignedToId');
            const helpText = document.getElementById('assigned-help-text');

            async function updateEmployeeList() {
                const selectedRoles = Array.from(roleCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);

                if (selectedRoles.length === 0) {
                    assignedToSelect.innerHTML = '<option value="">Selecione um funcionário...</option>';
                    assignedToSelect.disabled = true;
                    helpText.textContent = 'Selecione um ou mais setores acima para ver os funcionários disponíveis';
                    helpText.classList.remove('text-success');
                    helpText.classList.add('text-muted');
                    return;
                }

                try {
                    helpText.textContent = 'Carregando funcionários...';
                    helpText.classList.remove('text-muted');
                    helpText.classList.add('text-success');

                    const params = new URLSearchParams();
                    selectedRoles.forEach(role => params.append('roles', role));

                    const response = await fetch(`/demands/api/users-by-roles?${params.toString()}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Erro ao buscar funcionários');
                    }

                    const users = await response.json();

                    assignedToSelect.innerHTML = '<option value="">Selecione um funcionário...</option>';

                    if (users.length === 0) {
                        assignedToSelect.innerHTML += '<option value="" disabled>Nenhum funcionário encontrado para os setores selecionados</option>';
                        helpText.textContent = 'Nenhum funcionário encontrado para os setores selecionados';
                        helpText.classList.remove('text-success');
                        helpText.classList.add('text-warning');
                    } else {
                        users.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = `${user.fullName} (${user.email})`;
                            assignedToSelect.appendChild(option);
                        });

                        helpText.textContent = `${users.length} funcionário(s) disponível(is)`;
                        helpText.classList.remove('text-muted');
                        helpText.classList.add('text-success');
                    }

                    assignedToSelect.disabled = false;

                } catch (error) {
                    console.error('Erro ao buscar funcionários:', error);
                    assignedToSelect.innerHTML = '<option value="">Erro ao carregar funcionários</option>';
                    assignedToSelect.disabled = true;
                    helpText.textContent = 'Erro ao carregar funcionários. Tente novamente.';
                    helpText.classList.remove('text-success');
                    helpText.classList.add('text-danger');
                }
            }

            // Adiciona listeners aos checkboxes
            roleCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateEmployeeList);
            });

            // Estado inicial: select desabilitado
            assignedToSelect.disabled = true;
        });
    </script>
    <script th:src="@{/js/demand-kanban.js}"></script>
</section>
</body>
</html>
