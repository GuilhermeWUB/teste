<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>SUB - Relat√≥rio de Ve√≠culos</title>
</head>
<body>
<section layout:fragment="content" class="report-page" data-report-page="vehicles" data-report-title="Relat√≥rio de Ve√≠culos">
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
        <div>
            <h1 class="mb-1 d-flex align-items-center gap-2">
                <i class="bi bi-car-front-fill text-primary"></i>
                <span>Relat√≥rio de Ve√≠culos</span>
            </h1>
            <p class="text-muted mb-0">Personalize a consulta com os campos que deseja visualizar e gere o relat√≥rio dinamicamente.</p>
        </div>
        <div class="d-flex gap-2">
            <button type="button" id="btnNovaConsulta" class="btn btn-primary d-flex align-items-center gap-2" data-report-open>
                <i class="bi bi-funnel"></i>
                <span>Nova consulta</span>
            </button>
        </div>
    </div>

    <div class="alert alert-info d-flex align-items-center gap-2" data-report-empty>
        <i class="bi bi-info-circle-fill fs-4"></i>
        <span>Utilize o bot√£o <strong>Nova consulta</strong> para configurar os filtros e gerar o relat√≥rio.</span>
    </div>

    <div class="report-results-card d-none" data-report-results-wrapper>
        <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-3">
            <div>
                <h2 class="h4 mb-1" data-report-results-title>Relat√≥rio de Ve√≠culos</h2>
                <p class="text-muted small mb-0" data-report-results-subtitle>Consulta din√¢mica do relat√≥rio.</p>
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2" data-report-open>
                    <i class="bi bi-arrow-repeat"></i>
                    <span>Refazer consulta</span>
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm d-flex align-items-center gap-2" data-report-clear>
                    <i class="bi bi-x-circle"></i>
                    <span>Fechar resultado</span>
                </button>
            </div>
        </div>
        <div data-report-results></div>
    </div>

    <div class="report-overlay" data-report-overlay role="dialog" aria-modal="true" aria-labelledby="report-modal-title">
        <div class="report-overlay-dialog shadow-lg" tabindex="-1">
            <button type="button" class="btn-close" aria-label="Fechar" data-report-close></button>
            <div class="report-overlay-body" data-report-overlay-content>
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status" aria-label="Carregando"></div>
                    <p class="mt-3 mb-0">Carregando op√ß√µes...</p>
                </div>
            </div>
        </div>
    </div>
</section>

<script th:inline="javascript">
(function() {
    console.log('=== INICIO DO SCRIPT STANDALONE ===');

    // Fun√ß√£o standalone que N√ÉO depende do layout.html
    function initStandaloneReport() {
        console.log('‚úÖ initStandaloneReport executando...');

        const overlay = document.querySelector('[data-report-overlay]');
        const overlayContent = document.querySelector('[data-report-overlay-content]');
        const btnNovaConsulta = document.getElementById('btnNovaConsulta');
        const allOpenButtons = document.querySelectorAll('[data-report-open]');

        console.log('Overlay encontrado?', overlay !== null);
        console.log('OverlayContent encontrado?', overlayContent !== null);
        console.log('btnNovaConsulta encontrado?', btnNovaConsulta !== null);
        console.log('Total de bot√µes [data-report-open]:', allOpenButtons.length);

        if (!overlay || !overlayContent) {
            console.error('‚ùå ERRO: Overlay ou overlayContent n√£o encontrado!');
            return;
        }

        function abrirModal() {
            console.log('üöÄ ABRINDO MODAL...');
            overlay.classList.add('is-visible');
            overlay.style.display = 'flex';
            console.log('‚úÖ Classe is-visible adicionada e display flex aplicado');

            // Carregar filtros via AJAX
            fetch('/reports/vehicles/filters', {
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) throw new Error('Erro ' + response.status);
                return response.text();
            })
            .then(html => {
                console.log('‚úÖ HTML carregado, tamanho:', html.length);
                overlayContent.innerHTML = html;
                bindFormEvents();
            })
            .catch(error => {
                console.error('‚ùå Erro ao carregar filtros:', error);
                overlayContent.innerHTML = '<div class="alert alert-danger m-4">Erro ao carregar filtros: ' + error.message + '</div>';
            });
        }

        function fecharModal() {
            console.log('üîí Fechando modal...');
            overlay.classList.remove('is-visible');
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
        }

        function bindFormEvents() {
            const form = overlayContent.querySelector('[data-report-form]');
            const closeButtons = overlay.querySelectorAll('[data-report-close]');

            console.log('Form encontrado?', form !== null);
            console.log('Bot√µes fechar encontrados:', closeButtons.length);

            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('üìù Form submetido!');

                    const formData = new FormData(form);
                    const params = new URLSearchParams(formData);

                    overlayContent.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div><p class="fw-bold">Gerando relat√≥rio...</p></div>';

                    fetch('/reports/vehicles/data?' + params.toString(), {
                        headers: {'X-Requested-With': 'XMLHttpRequest'}
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('‚úÖ Dados recebidos:', data);
                        mostrarResultados(data);
                        fecharModal();
                    })
                    .catch(error => {
                        console.error('‚ùå Erro:', error);
                        overlayContent.innerHTML = '<div class="alert alert-danger m-4">Erro ao gerar relat√≥rio: ' + error.message + '</div>';
                    });
                });
            }

            closeButtons.forEach(btn => {
                btn.addEventListener('click', fecharModal);
            });

            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    fecharModal();
                }
            });
        }

        function mostrarResultados(data) {
            const resultsWrapper = document.querySelector('[data-report-results-wrapper]');
            const resultsContainer = document.querySelector('[data-report-results]');
            const emptyState = document.querySelector('[data-report-empty]');

            if (!resultsWrapper || !resultsContainer) return;

            let html = '<div class="alert alert-success">Relat√≥rio gerado com sucesso!</div>';
            html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';

            resultsContainer.innerHTML = html;
            resultsWrapper.classList.remove('d-none');
            if (emptyState) emptyState.classList.add('d-none');
        }

        // ADICIONAR EVENTOS NOS BOT√ïES
        console.log('üìå Adicionando eventos...');

        if (btnNovaConsulta) {
            btnNovaConsulta.addEventListener('click', function(e) {
                console.log('üîµ CLIQUE DETECTADO no btnNovaConsulta!');
                e.preventDefault();
                abrirModal();
            });
            console.log('‚úÖ Evento adicionado ao btnNovaConsulta');
        }

        allOpenButtons.forEach((btn, index) => {
            btn.addEventListener('click', function(e) {
                console.log('üîµ CLIQUE no bot√£o index', index);
                e.preventDefault();
                abrirModal();
            });
        });

        console.log('‚úÖ TODOS OS EVENTOS FORAM ADICIONADOS!');

        // Fechar com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && overlay.classList.contains('is-visible')) {
                fecharModal();
            }
        });
    }

    // Executar quando DOM estiver pronto
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initStandaloneReport);
    } else {
        initStandaloneReport();
    }

    // TAMB√âM tentar com window.initializeReportPage se existir
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof window.initializeReportPage === 'function') {
            console.log('üü¢ window.initializeReportPage existe, chamando tamb√©m...');
            window.initializeReportPage('vehicles', {autoOpen: false, title: 'Relat√≥rio de Ve√≠culos'});
        }
    });
})();
</script>
</body>
</html>
