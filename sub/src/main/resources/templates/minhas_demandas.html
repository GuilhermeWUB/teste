<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>SUB - Minhas Demandas</title>
    <link rel="stylesheet" th:href="@{/css/my-demands.css}">
</head>
<body>

<section layout:fragment="content" class="my-demands-page">
    <div class="my-demands-header">
        <div class="my-demands-header-content">
            <div class="my-demands-title">
                <span class="eyebrow"><i class="bi bi-clipboard2-check me-2"></i>Central de Demandas</span>
                <h1>Minhas Demandas</h1>
                <p>Gerencie facilmente suas demandas pessoais e as solicitações direcionadas ao seu cargo.
                    Acompanhe o progresso, atualize status e mantenha tudo sob controle mesmo no modo escuro.</p>
            </div>
            <div class="my-demands-actions" th:if="${isDirector}">
                <a th:href="@{/demands/director}" class="btn btn-outline-light text-white fw-semibold">
                    <i class="bi bi-speedometer2 me-2"></i>
                    Painel de Gestão
                </a>
            </div>
        </div>
    </div>

    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill"></i> <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i> <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="demand-stats">
        <article class="stat-card">
            <span class="stat-label">Pendentes</span>
            <span class="stat-value" th:text="${pendentes}">0</span>
        </article>
        <article class="stat-card">
            <span class="stat-label">Em andamento</span>
            <span class="stat-value" th:text="${emAndamento}">0</span>
        </article>
        <article class="stat-card">
            <span class="stat-label">Concluídas</span>
            <span class="stat-value" th:text="${concluidas}">0</span>
        </article>
        <article class="stat-card">
            <span class="stat-label">Total</span>
            <span class="stat-value" th:text="${#lists.size(demands)}">0</span>
        </article>
    </div>

    <div class="demand-toolbar">
        <form th:action="@{/demands/my-demands}" method="get">
            <div class="toolbar-group">
                <label class="toolbar-label" for="statusFilter">Filtrar por status</label>
                <select class="form-select" id="statusFilter" name="status">
                    <option value="">Todos</option>
                    <option th:each="status : ${statusOptions}"
                            th:value="${status}"
                            th:text="${status.displayName}"
                            th:selected="${statusFilter != null && statusFilter == status}"></option>
                </select>
            </div>
            <div class="toolbar-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-funnel me-2"></i>Filtrar
                </button>
                <a th:if="${statusFilter != null}" th:href="@{/demands/my-demands}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle me-2"></i>Limpar
                </a>
            </div>
        </form>
    </div>

    <div class="demand-list" th:if="${!#lists.isEmpty(demands)}">
        <article class="demand-card" th:each="demand : ${demands}">
            <header class="demand-card-header">
                <div>
                    <h2 th:text="${demand.titulo}">Título da Demanda</h2>
                    <div class="demand-meta-line">
                        <span class="demand-chip status-chip" th:attr="data-status=${demand.status.name()}"
                              th:text="${demand.status.displayName}">Status</span>
                        <span class="demand-chip priority-chip" th:attr="data-priority=${demand.prioridade.name()}"
                              th:text="${demand.prioridade.displayName}">Prioridade</span>
                    </div>
                </div>
                <div class="demand-meta-line text-end">
                    <span class="demand-chip">#<span th:text="${demand.id}">1</span></span>
                </div>
            </header>

            <p class="demand-description" th:text="${demand.descricao}">Descrição da demanda...</p>

            <div class="demand-meta">
                <div class="demand-meta-item">
                    <span>Criado por</span>
                    <strong th:text="${demand.createdBy.fullName}">Nome do criador</strong>
                </div>
                <div class="demand-meta-item" th:if="${demand.assignedTo != null}">
                    <span>Atribuído a</span>
                    <strong th:text="${demand.assignedTo.fullName}">Responsável</strong>
                </div>
                <div class="demand-meta-item">
                    <span>Registrada em</span>
                    <strong th:text="${#temporals.format(demand.createdAt, 'dd/MM/yyyy HH:mm')}">Data</strong>
                </div>
                <div class="demand-meta-item" th:if="${demand.dueDate != null}">
                    <span>Prazo limite</span>
                    <strong th:text="${#temporals.format(demand.dueDate, 'dd/MM/yyyy HH:mm')}">Prazo</strong>
                </div>
                <div class="demand-meta-item">
                    <span>Destinatários</span>
                    <strong th:text="${demand.targetRoles}">Cargos</strong>
                </div>
            </div>

            <div class="demand-actions">
                <a th:href="@{/demands/{id}(id=${demand.id})}" class="btn btn-info text-white">
                    <i class="bi bi-eye me-2"></i>Ver detalhes
                </a>

                <form th:if="${demand.assignedTo == null && demand.status.name() == 'PENDENTE'}"
                      th:action="@{/demands/{id}/assign-to-me(id=${demand.id})}"
                      method="post">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-hand-thumbs-up me-2"></i>Atribuir a mim
                    </button>
                </form>

                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-warning dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="bi bi-arrow-repeat me-2"></i>Atualizar status
                    </button>
                    <ul class="dropdown-menu">
                        <li th:each="status : ${statusOptions}">
                            <form th:action="@{/demands/{id}/update-status(id=${demand.id})}" method="post" style="margin: 0;">
                                <input type="hidden" name="status" th:value="${status}">
                                <button type="submit" class="dropdown-item" th:text="${status.displayName}">Status</button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>
        </article>
    </div>

    <div th:if="${#lists.isEmpty(demands)}" class="empty-state">
        <i class="bi bi-inbox"></i>
        <h3 class="mb-3">Nenhuma demanda encontrada</h3>
        <p>As demandas destinadas a você ou ao seu cargo serão exibidas aqui assim que forem criadas.</p>
    </div>
</section>

</body>
</html>
